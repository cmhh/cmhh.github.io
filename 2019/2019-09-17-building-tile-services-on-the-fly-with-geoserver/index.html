<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>cmhh  | Building Tile Services on-the-fly with GeoServer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link href="../../css/highlight/atom-one-dark-reasonable.css" rel='stylesheet' type='text/css' />
    <link rel="stylesheet" href="../../css/blog.css" />
    <link rel="stylesheet" href="../../css/custom.css" />
</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="../../">Home</a>
            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(/img/bg-blog-2.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Building Tile Services on-the-fly with GeoServer
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <h1 id="overview">Overview</h1>
<p>Interactive web applications can be a great way to present information to a diverse audience.  If your interface is well designed and intuitive, then almost anybody will be able to use it.  And where data has a spatial dimension, slippy maps can be an effective way of presenting information.  But sometimes the objects we want to render are a bit on the large side.  This means that our web browser can struggle to render all the required features, and it also means that mobile users of an app might end up using excessive amounts of data.</p>
<p>A good solution to the problem, that the spatial features we need to display are large, is to use some sort of tile service.  Slippy maps can, for the most part, fetch information from a tile service only for the active extent.  So, here we look at using <a href="https://geoserver.org">GeoServer</a> as a means of publishing such services.  We put special emphasis on ease of use and deployment, so cover the following:</p>
<ul>
<li>the use of Docker to simplify the installation and deployment of GeoServer itself</li>
<li>the use of GeoServer&rsquo;s REST API</li>
<li>wrapping calls to GeoServer&rsquo;s REST API to simplify a number of common use cases</li>
</ul>
<p>Specifically, we&rsquo;ll demonstrate how we can create new tile services on-the-fly entirely within R (though we could use any language capable of making HTTP calls and manipulating geospatial data–Python with geopandas, for example).</p>
<video width="878" controls>
  <source src="assets/geoserver.mp4" type="video/mp4">
Your browser does not support the video tag.
</video> 
<p><strong>Note that there is already an R package, <a href="https://github.com/eblondel/geosapi"><code>geosapi</code></a>, that provides what looks like a largely complete wrapper for the GeoServer REST API.</strong>  I wasn&rsquo;t aware of it when I put this together.  The use case here is a bit different, but nevertheless could possibly have made use of the geosapi package.</p>
<h1 id="a-comment-on-spatial-formats">A comment on spatial formats</h1>
<p>In this overview we work exclusively with GeoPackages.  Of course shapefile is somewhat ubiquitous–it&rsquo;s readily available, and most GIS tools can work with it easily.  But shapefile is a proprietary format with a lot of very real drawbacks.  GeoPackage, on the other hand, is an open format built on SQLite which has few, if any, of the same drawbacks, and is widely supported in mainstream GIS tools.</p>
<p>Converting shapefile to GeoPackage is relatively easy if you have access to <a href="https://gdal.org/">GDAL</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ogr2ogr -f GPKG output.gpkg input.shp
</code></pre></div><h2 id="source-data">Source data</h2>
<p>Throughout this document, we use spatial features sourced from
<a href="https://datafinder.stats.govt.nz">Stats NZ geographic data service</a>.  Specifically:</p>
<ul>
<li><a href="https://datafinder.stats.govt.nz/layer/92198-meshblock-2018-clipped-generalised/">Meshblock 2018 Clipped (generalised)</a></li>
<li><a href="https://datafinder.stats.govt.nz/layer/92211-statistical-area-1-2018-clipped-generalised/">Statistical Area 1 2018 (genaralised)</a></li>
<li><a href="https://datafinder.stats.govt.nz/layer/92213-statistical-area-2-2018-clipped-generalised/">Statistical Area 2 2018 (generalised)</a></li>
<li><a href="https://datafinder.stats.govt.nz/layer/92215-territorial-authority-2018-clipped-generalised/">Territorial Authority 2018 Clipped (generalised)</a></li>
<li><a href="https://datafinder.stats.govt.nz/layer/92205-regional-council-2018-clipped-generalised/">Regional Council 2018 Clipped (generalised)</a></li>
</ul>
<p>In addition, we also combine this with contextual information found on <a href="http://nzdotstat.stats.govt.nz/wbos/Index.aspx?_ga=2.229484444.1460045830.1566778650-200579101.1566001142">NZ.Stat</a>:</p>
<ul>
<li><a href="http://nzdotstat.stats.govt.nz/wbos/Index.aspx?DataSetCode=TABLECODE7979">Subnational population estimates (RC, SA2), by age and sex, at 30 June 1996, 2001, 2006-18 (2018 boundaries)</a></li>
<li><a href="http://nzdotstat.stats.govt.nz/wbos/Index.aspx?DataSetCode=TABLECODE7980">Subnational population estimates (TA, SA2), by age and sex, at 30 June 1996, 2001, 2006-18 (2018 boundaries)</a></li>
</ul>
<h2 id="installation">Installation</h2>
<p>To install the R package used throughout this document, simply run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">devtools<span style="color:#f92672">::</span><span style="color:#a6e22e">install_github</span>(<span style="color:#e6db74">&#34;cmhh/geoserveR&#34;</span>)
</code></pre></div><p>The R package requires a running instance of GeoServer to be useful.  We can get GeoServer up and running easily using Docker.  There is <a href="https://wiki.osgeo.org/wiki/DockerImages">no shortage of existing images online</a>, but we&rsquo;ll build our own.  We do this because it&rsquo;s pretty straight forward, and because it&rsquo;s instructive.  The R package contains a Dockerfile in <code>docker/Dockerfile</code> as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:18.04</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DEBIAN_FRONTEND noninteractive<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GEOSERVER_VERSION 2.15.2<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get install -y <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    ca-certificates openssl wget openjdk-8-jre <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    openssh-server openssh-client unzip <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get clean <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  update-ca-certificates <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  cd /usr/local <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  wget http://sourceforge.net/projects/geoserver/files/GeoServer/<span style="color:#e6db74">${</span>GEOSERVER_VERSION<span style="color:#e6db74">}</span>/geoserver-<span style="color:#e6db74">${</span>GEOSERVER_VERSION<span style="color:#e6db74">}</span>-bin.zip <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  unzip geoserver-<span style="color:#e6db74">${</span>GEOSERVER_VERSION<span style="color:#e6db74">}</span>-bin.zip <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  mv geoserver-<span style="color:#e6db74">${</span>GEOSERVER_VERSION<span style="color:#e6db74">}</span> geoserver <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  rm geoserver-<span style="color:#e6db74">${</span>GEOSERVER_VERSION<span style="color:#e6db74">}</span>-bin.zip<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GEOSERVER_HOME /usr/local/geoserver<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> GEOSERVER_DATA_DIR <span style="color:#e6db74">${</span>GEOSERVER_HOME<span style="color:#e6db74">}</span>/data_dir<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;/usr/local/geoserver/bin/startup.sh&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>The R package can be used to generate the command required to build the image since the location of <code>Dockerfile</code> will vary depending on the user&rsquo;s setup.  For example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#f92672">&gt;</span> geoserveR<span style="color:#f92672">::</span><span style="color:#a6e22e">docker_build</span>(tag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;geoserver&#39;</span>)
docker build <span style="color:#f92672">-</span>t geoserver <span style="color:#e6db74">&#34;/home/cmhh/R/x86_64-pc-linux-gnu-library/3.5/geoserveR/docker&#34;</span>
</code></pre></div><p>Running the resulting command at the terminal will result in the creation of an image called, in this case, <code>geoserver</code>.  We can start this via:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run -d --name geoserver --rm -p 8080:8080 geoserver
</code></pre></div><p>The container will take a short while to get up and running completely, but when done, simply open a browser at <code>http://localhost:8080/geoserver</code>.  To login, the username is <code>admin</code>, and the password is <code>geoserver</code> (obviously, we&rsquo;d configure this differently in a production setting&hellip; more on that later).  And that&rsquo;s it.</p>
<p><img src="assets/geoserver001.png" alt="http://localhost:8080/geoserver"></p>
<h2 id="testing-geoserver">Testing GeoServer</h2>
<p>GeoServer includes several data sources by default, and we can use these to test out our install.  We&rsquo;re mostly interested in WMS services which we can display on a leaflet map, though GeoServer can display WCS, WFS, WMS, and WMTS.</p>
<p>Broadly speaking, GeoServer groups sets of <em>layers</em> together in <em>workspaces</em>, where the layers are the features we&rsquo;re intrested in displaying on a map.  And the layers themselves are built up from <em>data stores</em>.  We can inspect workspaces in the main web interface by clicking the Data &gt; Workpaces link:</p>
<p><img src="assets/workspaces.png" alt="Workspaces"></p>
<p>Any of the listed workspaces can then be accessed as WMS services programmatically via <code>http://localhost/geoserver/&lt;workspace&gt;/wms?</code> (and an XML file describing the service can be accessed via <code>http://localhost/geoserver/&lt;workspace&gt;/wms?request=GetCapabilities</code>).  For example, if we wanted to display layers that are part of the <code>topp</code> workspace, we&rsquo;d use <code>http://localhost:8080/geoserver/topp/wms?</code>.  If we click on Data &gt; Layers in the main web interface we see that there is, for example, a layer in the <code>topp</code> workspace called <code>states</code>:</p>
<p><img src="assets/layers.png" alt="Layers"></p>
<p>We can display this in a leaflet map in R by running the following code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(leaflet)

<span style="color:#a6e22e">leaflet</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addTiles</span>(
    urlTemplate <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&#34;</span>
  ) <span style="color:#f92672">%&gt;%</span>
  leaflet<span style="color:#f92672">::</span><span style="color:#a6e22e">fitBounds</span>(<span style="color:#ae81ff">-125</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">-67</span>, <span style="color:#ae81ff">50</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addWMSTiles</span>(
    <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/topp/wms?&#34;</span>, 
    layers <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;states&#34;</span>,
    options <span style="color:#f92672">=</span> <span style="color:#a6e22e">WMSTileOptions</span>(format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;image/png&#34;</span>, transparent <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
  )
</code></pre></div><p>which yields the following:</p>
<p><img src="assets/states.png" alt="states"></p>
<h2 id="an-r-client-library">An R client library</h2>
<p>Our use case is to create styled tiles services, entirely from within R.  To simplify the discussion, a simple R package is provided which:</p>
<ul>
<li>includes geographies (as <code>sf</code> objects)</li>
<li>includes population counts (as a tidy <code>data.frame</code>)</li>
<li>includes an interface for (a subset of) the GeoServer REST API</li>
<li>includes utilities that simplify working with the GeoServer interface.</li>
</ul>
<p>We won&rsquo;t go into the details here, but rather just describe the relevant usage as it arises.  Where possible, though, we will also consider the plain HTTP calls.  But by way of example, the following lists the layers available in the <code>topp</code> workspace.  First, using the REST API (via <code>curl</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl -s -u admin:geoserver -X GET <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    http://localhost:8080/geoserver/rest/workspaces/topp/layers | jq <span style="color:#e6db74">&#39;.&#39;</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;layers&#34;</span>: {
    <span style="color:#f92672">&#34;layer&#34;</span>: [
      {
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;states&#34;</span>,
        <span style="color:#f92672">&#34;href&#34;</span>: <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/states.json&#34;</span>
      },
      {
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;tasmania_cities&#34;</span>,
        <span style="color:#f92672">&#34;href&#34;</span>: <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_cities.json&#34;</span>
      },
      {
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;tasmania_roads&#34;</span>,
        <span style="color:#f92672">&#34;href&#34;</span>: <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_roads.json&#34;</span>
      },
      {
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;tasmania_state_boundaries&#34;</span>,
        <span style="color:#f92672">&#34;href&#34;</span>: <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_state_boundaries.json&#34;</span>
      },
      {
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;tasmania_water_bodies&#34;</span>,
        <span style="color:#f92672">&#34;href&#34;</span>: <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_water_bodies.json&#34;</span>
      }
    ]
  }
}
</code></pre></div><p>and then using the provided R package:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">library</span>(geoserveR)
<span style="color:#f92672">&gt;</span> gs <span style="color:#f92672">&lt;-</span> GeoServer<span style="color:#f92672">$</span><span style="color:#a6e22e">new</span>()
<span style="color:#f92672">&gt;</span> topp_layers <span style="color:#f92672">&lt;-</span> gs<span style="color:#f92672">$</span><span style="color:#a6e22e">getLayers</span>(<span style="color:#e6db74">&#34;topp&#34;</span>)
<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">str</span>(topp_layers)
List of <span style="color:#ae81ff">5</span>
 <span style="color:#f92672">$</span> states                   <span style="color:#f92672">:</span>List of <span style="color:#ae81ff">2</span>
  ..<span style="color:#f92672">$</span> name<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;states&#34;</span>
  ..<span style="color:#f92672">$</span> href<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/states.json&#34;</span>
 <span style="color:#f92672">$</span> tasmania_cities          <span style="color:#f92672">:</span>List of <span style="color:#ae81ff">2</span>
  ..<span style="color:#f92672">$</span> name<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;tasmania_cities&#34;</span>
  ..<span style="color:#f92672">$</span> href<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_cities.json&#34;</span>
 <span style="color:#f92672">$</span> tasmania_roads           <span style="color:#f92672">:</span>List of <span style="color:#ae81ff">2</span>
  ..<span style="color:#f92672">$</span> name<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;tasmania_roads&#34;</span>
  ..<span style="color:#f92672">$</span> href<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_roads.json&#34;</span>
 <span style="color:#f92672">$</span> tasmania_state_boundaries<span style="color:#f92672">:</span>List of <span style="color:#ae81ff">2</span>
  ..<span style="color:#f92672">$</span> name<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;tasmania_state_boundaries&#34;</span>
  ..<span style="color:#f92672">$</span> href<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_state_boundaries.json&#34;</span>
 <span style="color:#f92672">$</span> tasmania_water_bodies    <span style="color:#f92672">:</span>List of <span style="color:#ae81ff">2</span>
  ..<span style="color:#f92672">$</span> name<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;tasmania_water_bodies&#34;</span>
  ..<span style="color:#f92672">$</span> href<span style="color:#f92672">:</span> chr <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/topp/layers/tasmania_water_bodies.json&#34;</span>
</code></pre></div><h2 id="making-a-new-layer">Making a new layer</h2>
<p>Pretty much any layer that exists in GeoServer can be made available as a service–WMS in our case.  We&rsquo;ll run through a couple of examples, but, broadly speaking, the steps are:</p>
<ul>
<li>create a <em>workspace</em></li>
<li>add a <em>datastore</em> to the workspace</li>
<li>add a <em>style</em> via a styled layer descriptor (sld) file</li>
<li>add a <em>layer</em> to the workspace which references the data store and style</li>
</ul>
<p>We&rsquo;ll put all our examples in a single workspace named <code>statsnz</code>.  We can create this in R as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(geserveR)

gs <span style="color:#f92672">&lt;-</span> GeoServer<span style="color:#f92672">$</span><span style="color:#a6e22e">new</span>()
gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createWorkspace</span>(<span style="color:#e6db74">&#34;statsnz&#34;</span>)
</code></pre></div><h2 id="example---meshblock-with-labels">Example - meshblock with labels</h2>
<p>Meshblocks are the building blocks of most other official geographies held by Stats NZ.  There are approximately 50,000 of them and collectively they are quite large–the GeoPackage used here was 91MB, though we simplified this considerably using <a href="https://mapshaper.org/">mapshaper</a> to make things practical.  To display them in R on a leaflet map:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(geoserveR)
<span style="color:#a6e22e">library</span>(leaflet)

<span style="color:#a6e22e">leaflet</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addTiles</span>(urlTemplate <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addPolygons</span>(data <span style="color:#f92672">=</span> mb2018, 
              color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#000000&#34;</span>, weight <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, opacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, fillOpacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
              label <span style="color:#f92672">=</span> <span style="color:#f92672">~</span>code)
</code></pre></div><p>This yields something like the following:</p>
<p><img src="assets/leaflet001.png" alt="meshblocks"></p>
<p>Saved as a stand-alone HTML file, this weighs in at over 15MB, and can be sluggish when rendering.  In actuality, the features are oversimplified here, so that when zoomed in the shapes have lost far too much detail.  But if we&rsquo;d displayed them at full resolution, our HTML file would be over 100MB!</p>
<p>To make meshblocks available as a service, we first add a datastore.  We can add this in R as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createDatastore</span>(mb2018, <span style="color:#e6db74">&#34;statsnz&#34;</span>, <span style="color:#e6db74">&#34;mb2018&#34;</span>)
</code></pre></div><p>Internally, this creates a copy of the <code>mb2018</code> feature class as a GeoPackage, and then uploads it to the server via the <code>datastores</code> endpoint.  We then make a layer in R as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">style <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">import_template</span>(
  <span style="color:#e6db74">&#34;outline_with_label&#34;</span>,
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mb2018_with_labels&#34;</span>, strokeColor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#000000&#34;</span>, strokeWidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
  maxScale <span style="color:#f92672">=</span> <span style="color:#ae81ff">600000</span>, geometryName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;geom&#34;</span>, labelName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;code&#34;</span>,
  fontFamily <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Arial&#34;</span>, fontSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>, fontStyle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;normal&#34;</span>,
  fontWeight <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>, fontColor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#000000&#34;</span>,
  haloSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>, haloColor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#FFFFFF&#34;</span>
)

gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createLayer</span>(<span style="color:#e6db74">&#34;statsnz&#34;</span>, <span style="color:#e6db74">&#34;mb2018&#34;</span>, <span style="color:#e6db74">&#34;mb2018_with_labels&#34;</span>, style)
</code></pre></div><p>Internally, we create a <em>feature type</em>, which is initially unconfigured.  We then create a new style, and then we apply the style to the created layer.  The variable <code>style</code> contains styling information in styled layer descriptor (SLD) format.  The approach here isn&rsquo;t terribly refined, but it is practical.  The <code>import_template</code> function is used to import bundled templates, and replace placeholders with parameter values.</p>
<p>Either way, having done all this, we can now access meshblocks as a WMS via <code>http://localhost:8080/statsnz/wms?</code> as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">leaflet</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">fitBounds</span>(lng1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">164.45</span>, lng2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">179.35</span>, lat1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">-48.52</span>, lat2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">-33.22</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addTiles</span>(
    urlTemplate <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&#34;</span>
  ) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addWMSTiles</span>(
    <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/statsnz/wms?&#34;</span>, 
    layers <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mb2018_with_labels&#34;</span>,
    options <span style="color:#f92672">=</span> <span style="color:#a6e22e">WMSTileOptions</span>(format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;image/png&#34;</span>, transparent <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>), 
    group <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mb2018&#34;</span>
  ) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addLayersControl</span>(
    overlayGroups <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mb2018&#34;</span>,
    options <span style="color:#f92672">=</span> <span style="color:#a6e22e">layersControlOptions</span>(collapsed <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
  )
</code></pre></div><p>Visually:</p>
<p><img src="assets/leaflet003.png" alt="mb2018_with_labels"></p>
<p><img src="assets/leaflet004.png" alt="mb2018_with_labels"></p>
<p>Better yet, saved as a stand-alone HTML file, this map is less than 500KB (though the various tiles still need to be transferred, so one can still burn through a bit of data just navigating around).</p>
<h2 id="example---population-by-statistical-area-2">Example - population by statistical area 2</h2>
<p>Consider the following R code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(geoserveR)
<span style="color:#a6e22e">library</span>(leaflet)
<span style="color:#a6e22e">library</span>(sf)
<span style="color:#a6e22e">library</span>(dplyr)

<span style="color:#a6e22e">data</span>(sa22018)
<span style="color:#a6e22e">data</span>(popdata)

mapdata <span style="color:#f92672">&lt;-</span> sa22018 <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">inner_join</span>(<span style="color:#a6e22e">filter</span>(popdata, geography <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sa22018&#34;</span>), by <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;code&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(year <span style="color:#f92672">==</span> <span style="color:#ae81ff">2018</span>)

pal <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">colorNumeric</span>(palette <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Blues&#34;</span>, domain <span style="color:#f92672">=</span> mapdata<span style="color:#f92672">$</span>value)

<span style="color:#a6e22e">leaflet</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addTiles</span>(urlTemplate <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addPolygons</span>(data <span style="color:#f92672">=</span> mapdata, 
              fillColor <span style="color:#f92672">=</span> <span style="color:#f92672">~</span><span style="color:#a6e22e">pal</span>(value), opacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, fillOpacity <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
              label <span style="color:#f92672">=</span> <span style="color:#f92672">~</span><span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;%s - %s&#34;</span>, label, value)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addLegend</span>(position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottomright&#34;</span>, pal <span style="color:#f92672">=</span> pal, values <span style="color:#f92672">=</span> mapdata<span style="color:#f92672">$</span>value)
</code></pre></div><p>This yields an interactive map as follows:</p>
<p><img src="assets/leaflet002.png" alt="population by SA2"></p>
<p>The resulting HTML file weighs in at 3.2MB–not enormous by any stretch, but still probably not something you want users to be fetching repeatedly over a mobile connection, for example.  But this map just shows data for 2018, yet we have data for the years 1996, 2001, and 2006-2018–that&rsquo;s 15 years all up.  What if we want to make all this available on one map?  In that case, the resulting stand-alone HTML file weighs in at over 40MB.  (Of course, a hosted app could serve up a year based on user selection, but 3MB or so would still be transferred each time the year was switched).</p>
<p>Let us instead see if we can create a workspace in GeoServer which contains a layer for each year.  As a WMS, the layers will cease to be interactive (so no hovering tooltips), but we could at least render a label whenever the user zooms in close enough, so let&rsquo;s do that too.</p>
<p>First, we create a version of the SA2 feature class that has population counts:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(dplyr)
<span style="color:#a6e22e">library</span>(reshape2)

counts <span style="color:#f92672">&lt;-</span> popdata <span style="color:#f92672">%&gt;%</span>
  dplyr<span style="color:#f92672">::</span><span style="color:#a6e22e">filter</span>(geography <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sa22018&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  dplyr<span style="color:#f92672">::</span><span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>geography)

counts_wide <span style="color:#f92672">&lt;-</span> counts <span style="color:#f92672">%&gt;%</span>
  reshape2<span style="color:#f92672">::</span><span style="color:#a6e22e">dcast</span>(code <span style="color:#f92672">~</span> year, value.var <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;value&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  data.frame <span style="color:#75715e"># this is deliberate so years are like X1996 rather than `1996`</span>

sa22018_with_counts <span style="color:#f92672">&lt;-</span> sa22018 <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">inner_join</span>(counts_wide, by <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;code&#34;</span>)
</code></pre></div><p>Then, we create a data store using the feature class created, and add a new layer for each of the columns:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">gs <span style="color:#f92672">&lt;-</span> GeoServer<span style="color:#f92672">$</span><span style="color:#a6e22e">new</span>()

gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createDatastore</span>(sa22018_with_counts, <span style="color:#e6db74">&#34;statsnz&#34;</span>, <span style="color:#e6db74">&#34;sa22018_with_counts&#34;</span>)

years <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1996</span>, <span style="color:#ae81ff">2001</span>, <span style="color:#ae81ff">2006</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2018</span>)

<span style="color:#a6e22e">for </span>(year in years) {
  col <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;X%s&#34;</span>, year)
  name <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;sa22018_%s&#34;</span>, year)
  style <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">create_polygon_fills</span>(sa22018_with_counts, col, <span style="color:#e6db74">&#34;geom&#34;</span>, <span style="color:#e6db74">&#34;label&#34;</span>)
  gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createLayer</span>(<span style="color:#e6db74">&#34;statsnz&#34;</span>, <span style="color:#e6db74">&#34;sa22018_with_counts&#34;</span>, name, style) 
}
</code></pre></div><p>And that&rsquo;s it—we now have a bunch of new layers called <code>sa22018_1996</code>, and so on.  There&rsquo;s a little bit going on under the hood, of course, but either way we can now use the resulting WMS layers as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">m <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">leaflet</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">fitBounds</span>(lng1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">164.45</span>, lng2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">179.35</span>, lat1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">-48.52</span>, lat2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">-33.22</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addTiles</span>(
    urlTemplate <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&#34;</span>
  )

<span style="color:#a6e22e">for </span>(year in years) {
  m <span style="color:#f92672">&lt;-</span> m <span style="color:#f92672">%&gt;%</span>
    <span style="color:#a6e22e">addWMSTiles</span>(
      <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/statsnz/wms?&#34;</span>,
      layers <span style="color:#f92672">=</span> <span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;sa22018_%s&#34;</span>, year),
      options <span style="color:#f92672">=</span> <span style="color:#a6e22e">WMSTileOptions</span>(format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;image/png&#34;</span>, transparent <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>),
      group <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.character</span>(year)
    ) <span style="color:#f92672">%&gt;%</span>
    <span style="color:#a6e22e">hideGroup</span>(<span style="color:#a6e22e">as.character</span>(year))
}

m <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">addLayersControl</span>(
    overlayGroups <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.character</span>(years),
    options <span style="color:#f92672">=</span> <span style="color:#a6e22e">layersControlOptions</span>(collapsed <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
  ) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">showGroup</span>(<span style="color:#a6e22e">as.character</span>(<span style="color:#a6e22e">tail</span>(years, <span style="color:#ae81ff">1</span>)))
</code></pre></div><p>which yields:</p>
<p><img src="assets/leaflet05.png" alt="sa22018_with_counts"></p>
<p><img src="assets/leaflet06.png" alt="sa22018_with_counts"></p>
<!--
## Extension&ndash;adding PostGIS to our Docker image

Throughout the demo we just used shapefiles.  Shapefiles are useful in the sense that 
-->
<h2 id="appendix---api-calls">Appendix - API calls</h2>
<p>For the sake of brevity, the examples above mostly focused on R calls using the provided R client library.  For the sake of completeness, and for those who might want to do something similar without R, we include the equivalent functionality using direct API calls.</p>
<h3 id="creating-a-workspace">Creating a workspace</h3>
<p>To make the <code>statsnz</code> workspace, we ran:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(geserveR)

gs <span style="color:#f92672">&lt;-</span> GeoServer<span style="color:#f92672">$</span><span style="color:#a6e22e">new</span>()
gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createWorkspace</span>(<span style="color:#e6db74">&#34;statsnz&#34;</span>)
</code></pre></div><p>To do this direclty, we use the <code>workspaces</code> endpoint:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -u admin:geoserver <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d <span style="color:#e6db74">&#39;{&#34;workspace&#34;:{&#34;name&#34;:&#34;statsnz&#34;}}&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -X POST <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  http://localhost:8080/geoserver/rest/workspaces
</code></pre></div><h3 id="creating-a-datastore">Creating a datastore</h3>
<p>To add the meshblock feature set as a datastore, we ran the following in R:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createDatastore</span>(mb2018, <span style="color:#e6db74">&#34;statsnz&#34;</span>, <span style="color:#e6db74">&#34;mb2018&#34;</span>, <span style="color:#e6db74">&#34;mb2018.gpkg&#34;</span>)
</code></pre></div><p>Internally, this results in <code>mb2018</code> first being saved as a temporary GeoPackage, before being uploaded via the <code>datastores</code> endpoint.  If we wanted to do this manually, we&rsquo;d first create the GeoPackage in R:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">fname <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tempfile</span>(fileext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.gpkg&#34;</span>)
<span style="color:#a6e22e">st_write</span>(regc2018, fname, <span style="color:#e6db74">&#34;mb2018&#34;</span>)
</code></pre></div><p>and then we&rsquo;d <code>PUT</code> via the <code>datastores</code> endpoint as follows (assuming <code>fname</code> has the value <code>file4b82655cefdd.gpkg</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -u admin:geoserver <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Accept: application/json, text/xml, application/xml, */*&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/octet-stream&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -T <span style="color:#e6db74">&#34;/tmp/RtmpbY5Tby/file4b82655cefdd.gpkg&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -X PUT <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/statsnz/datastores/regc2018/file.gpkg?configure=none&amp;update=overwrite&amp;charset=UTF-8&amp;filename=mb2018.gpkg&#34;</span>
</code></pre></div><h3 id="creating-a-layer">Creating a layer</h3>
<p>To create a meshblock layer with a simple outline and text label, we ran the following in R:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">style <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">import_template</span>(
  <span style="color:#e6db74">&#34;outline_with_label&#34;</span>,
  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mb2018_with_labels&#34;</span>, strokeColor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#000000&#34;</span>, strokeWidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
  maxScale <span style="color:#f92672">=</span> <span style="color:#ae81ff">600000</span>, geometryName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;geom&#34;</span>, labelName <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;code&#34;</span>,
  fontFamily <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Arial&#34;</span>, fontSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>, fontStyle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;normal&#34;</span>,
  fontWeight <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>, fontColor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#000000&#34;</span>,
  haloSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>, haloColor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#FFFFFF&#34;</span>
)

gs<span style="color:#f92672">$</span><span style="color:#a6e22e">createLayer</span>(<span style="color:#e6db74">&#34;statsnz&#34;</span>, <span style="color:#e6db74">&#34;mb2018&#34;</span>, <span style="color:#e6db74">&#34;mb2018_with_labels&#34;</span>, style)
</code></pre></div><p>Assuming we have saved the content of the variable <code>style</code> in a file called <code>style.sld</code>, we could create the style on the server as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -u admin:geoserver <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Accept: application/json, text/xml, application/xml, */*&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/vnd.ogc.sld+xml&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --data <span style="color:#e6db74">&#34;@style.sld&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -X POST <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/statsnz/styles?name=mb2018_with_label&#34;</span>
</code></pre></div><p>We&rsquo;d create the feature type as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -u admin:geoserver <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d <span style="color:#e6db74">&#39;{&#34;featureType&#34;:{&#34;name&#34;:&#34;mb2018_with_labels&#34;, &#34;nativeName&#34;:&#34;mb2018&#34;}}&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -X POST <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/statsnz/datastores/mb2018/featuretypes&#34;</span>
</code></pre></div><p>and we&rsquo;d add the style to the layer as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -u admin:geoserver <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d <span style="color:#e6db74">&#39;{&#34;layer&#34;:{&#34;defaultStyle&#34;:{&#34;name&#34;:&#34;statsnz:labelledpolygon&#34;}}}&#39;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -X PUT <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">&#34;http://localhost:8080/geoserver/rest/workspaces/statsnz/layers/mb2018&#34;</span>
</code></pre></div>
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="../../tags/akka-http">akka-http</a></span>
        
            <span class="tag"><a href="../../tags/docker">docker</a></span>
        
            <span class="tag"><a href="../../tags/geoserver">geoserver</a></span>
        
            <span class="tag"><a href="../../tags/geospark">geospark</a></span>
        
            <span class="tag"><a href="../../tags/geospatial">geospatial</a></span>
        
            <span class="tag"><a href="../../tags/nodejs">nodejs</a></span>
        
            <span class="tag"><a href="../../tags/osrm">osrm</a></span>
        
            <span class="tag"><a href="../../tags/postgis">postgis</a></span>
        
            <span class="tag"><a href="../../tags/postgresql">postgresql</a></span>
        
            <span class="tag"><a href="../../tags/qgis">qgis</a></span>
        
            <span class="tag"><a href="../../tags/r">r</a></span>
        
            <span class="tag"><a href="../../tags/r-packages">r-packages</a></span>
        
            <span class="tag"><a href="../../tags/seasonal-adjustment">seasonal-adjustment</a></span>
        
            <span class="tag"><a href="../../tags/sedona">sedona</a></span>
        
            <span class="tag"><a href="../../tags/shiny">shiny</a></span>
        
            <span class="tag"><a href="../../tags/spark">spark</a></span>
        
            <span class="tag"><a href="../../tags/tiles">tiles</a></span>
        
            <span class="tag"><a href="../../tags/tilestache">tilestache</a></span>
        
            <span class="tag"><a href="../../tags/vuejs">vuejs</a></span>
        
            <span class="tag"><a href="../../tags/wmts">wmts</a></span>
        
            <span class="tag"><a href="../../tags/wsl2">wsl2</a></span>
        
            <span class="tag"><a href="../../tags/x13-arima-seats">x13-arima-seats</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="../../2021/2021-04-19-a-brief-look-at-apache-sedona/">A Brief Look at Apache Sedona</a></h1>
            <time class="has-text-grey-light is-size-7">19 April 2021</time>
        
            <h1><a href="../../2020/2020-12-05-working-productively-on-windows-using-wsl2-and-docker/">Working Productively on Windows Using Windows Subsystem for Linux 2 and Docker</a></h1>
            <time class="has-text-grey-light is-size-7">5 December 2020</time>
        
            <h1><a href="../../2020/2020-10-31-using-postgis-as-a-spatial-backend-for-r/">Using PostGIS as a Spatial Backend for R</a></h1>
            <time class="has-text-grey-light is-size-7">31 October 2020</time>
        
            <h1><a href="../../2020/2020-10-31-docker-on-windows-with-wsl2/">Docker on Windows with Windows Subsystem for Linux 2</a></h1>
            <time class="has-text-grey-light is-size-7">31 October 2020</time>
        
            <h1><a href="../../2020/2020-06-01-seasonal-adjustment-as-a-service/">Seasonal Adjustment as a Service</a></h1>
            <time class="has-text-grey-light is-size-7">1 June 2020</time>
        
    </div>
</div>
    <br>
                
  



<div class="card">
    <div class="card-content">
        <h1 class="title is-5">Related posts</h1>
      
      
            <h1><a href="../../2020/2020-10-31-using-postgis-as-a-spatial-backend-for-r/">Using PostGIS as a Spatial Backend for R</a></h1>
            <time class="has-text-grey-light is-size-7">31 October 2020</time>
      
            <h1><a href="../../2016/2016-11-27-routing-in-r-using-osrm/">Routing in R Using the Open Source Routing Machine (OSRM)</a></h1>
            <time class="has-text-grey-light is-size-7">27 November 2016</time>
      
            <h1><a href="../../2016/2016-07-20-data-packages/">Using R Packages to Disseminate Data</a></h1>
            <time class="has-text-grey-light is-size-7">20 July 2016</time>
      
    </div>
</div>

    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="../../archives/2021">2021</a> (1)<br>
        
            <a href="../../archives/2020">2020</a> (4)<br>
        
            <a href="../../archives/2019">2019</a> (1)<br>
        
            <a href="../../archives/2017">2017</a> (1)<br>
        
            <a href="../../archives/2016">2016</a> (4)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://github.com/cmhh" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="mailto://cmhhansen@outlook.com" class="mysocial" rel="me"><i class="fas fa-envelope fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; cmhh 2021 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="//yihui.org/js/math-code.js"></script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

</body>
</html>
