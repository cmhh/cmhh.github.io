<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>cmhh  | Using PostGIS as a Spatial Backend for R</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link href="../../css/highlight/atom-one-dark-reasonable.css" rel='stylesheet' type='text/css' />
    <link rel="stylesheet" href="../../css/blog.css" />
    <link rel="stylesheet" href="../../css/custom.css" />
</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="../../">Home</a>
            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(/img/bg-blog-2.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Using PostGIS as a Spatial Backend for R
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <h1 id="overview">Overview</h1>
<p>R is a wildly extensible tool, and that extensibility means it can be used in a surprising array of domains.  This versatility is great, but there are times when R is just not the best tool for the job–at least not by itself.  Geospatial applications are a good example.  Packages such as <code>rgdal</code>, <code>sf</code>, and <code>raster</code> make R quite usable in this domain, but R&rsquo;s largely in-memory approach can make geoprocessing tasks involving large spatial objects a little challenging.  In this blog, we look at how we can leverage <a href="https://www.postgresql.org/">PostgreSQL</a> and the <a href="https://postgis.net/">PostGIS</a> extension to usefully complement R, mostly by offloading large geoprocessing tasks, and as a library for storing large feature classes for shared use across a potentially large userbase.</p>
<h1 id="source-data">Source Data</h1>
<p>In this demonstration we will use <a href="https://www.openstreetmap.org/#map=2/-41.2/-6.6">OpenStreetMap</a> data sourced from <a href="http://download.geofabrik.de">Geofabrik</a>.  Specifically, <a href="http://download.geofabrik.de/australia-oceania/new-zealand-latest-free.shp.zip">New Zealand (.shp.zip)</a>.  Unpacked, this provides a number of feature classes, but we will be interested mainly in <code>gis_osm_landuse_a_free_1</code>, which contains polygons describing land use–forest, farm, nature reserves, etc.  This data is provided as a set of ESRI Shapefiles.</p>
<!--:

file                       | type    | description
---------------------------|---------|------------------
gis_osm_buildings_a_free_1 | polygon |
gis_osm_landuse_a_free_1   | polygon | 
gis_osm_natural_a_free_1   | polygon | 
gis_osm_natural_free_1     | point   | 
gis_osm_places_a_free_1    | polygon | 
gis_osm_places_free_1      | point   | 
gis_osm_pofw_a_free_1      | polygon | places of worship
gis_osm_pofw_free_1        | point   | places of worship
gis_osm_pois_a_free_1      | polygon | points of interest
gis_osm_pois_free_1        | point   | points of interest
gis_osm_railways_free_1    | line    | 
gis_osm_roads_free_1       | line    | 
gis_osm_traffic_a_free_1   | polygon | parking, fuel, etc.
gis_osm_traffic_free_1     | point   | parking, fuel, etc.
gis_osm_transport_a_free_1 | polygon | stations, terminals, etc.
gis_osm_transport_free_1   | point   | stations, terminals, etc.
gis_osm_water_a_free_1     | polygon | 
gis_osm_waterways_free_1   | line    | 
-->
<p>Additionally, we will use <a href="https://datafinder.stats.govt.nz/layer/104280-meshblock-2020-generalised/">Meshblock 2020 (generalised)</a> sourced from <a href="https://datafinder.stats.govt.nz/">Stats NZ Geographic Data Service</a>.  This is a standard geographic grouping used by Stats NZ out of which all other higher geographies (Statistical Area levels 1 and 2, Territorial Authority, Regional Council, etc.) are created.  This data can be downloaded in a range of formats, and GeoPackage was chosen for the purpose of this post.</p>
<!--
* [Territorial Authority 2020 Clipped (generalised)](https://datafinder.stats.govt.nz/layer/104266-territorial-authority-2020-clipped-generalised/) 
* [Regional Council 2020 Clipped (generalised)](https://datafinder.stats.govt.nz/layer/104253-regional-council-2020-clipped-generalised/)
* [Statistical Area Level 1 2020 Clipped (generalised)](https://datafinder.stats.govt.nz/layer/104272-statistical-area-1-2020-clipped-generalised/)
* [Statistical Area Level 2 2020 Clipped (generalised)](https://datafinder.stats.govt.nz/layer/104270-statistical-area-2-2020-clipped-generalised/)
* [Meshblock 2020 (generalised)](https://datafinder.stats.govt.nz/layer/104280-meshblock-2020-generalised/)
-->
<p>Finally we will make use of <a href="https://data.linz.govt.nz/layer/95524-wellington-010m-urban-aerial-photos-2017/">Wellington 0.10m Urban Aerial Photos (2017)</a> from the <a href="https://data.linz.govt.nz/">LINZ Data Service</a>.  This is a set of high resolution aerial imagery covering Wellington City.  This data can be downloaded in a range of formats, and JPEG was chosen here.</p>
<!-- * [Wellington 0.10m Urban Aerial Photos (2017)](https://data.linz.govt.nz/layer/95524-wellington-010m-urban-aerial-photos-2017/) -->
<h1 id="loading-the-source-data-to-postgis">Loading the Source Data to PostGIS</h1>
<p>In principle, we can create spatial tables in a PostGIS-enabled database by running SQL queries.  Of course, that&rsquo;s not practical beyond trivially simple use cases.  In practice, we will copy compatible files into the database using one of the following methods:</p>
<ul>
<li>using command-line tools that come with PostGIS, such as <code>shp2pgsql</code></li>
<li>using command-line tools that come with GDAL, such as <code>ogr2ogr</code></li>
<li>using a client library, such as the <code>rpostgis</code> or <code>rgdal</code> packages in R</li>
</ul>
<h2 id="vector-data">Vector data</h2>
<p>We can load vector data to PostGIS using the <code>ogr2ogr</code> program provided by <code>gdal</code>.  For example, in the following we load a GeoPackage called <code>meshblock-2020-generalised.gpkg</code> to <code>statsnz.meshblock2020</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ogr2ogr <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -f PostgreSQL PG:<span style="color:#e6db74">&#34;dbname=&#39;gis&#39; user=&#39;gisuser&#39; password=&#39;gisuser&#39;&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  meshblock-2020-generalised.gpkg <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -nln statsnz.meshblock2020
</code></pre></div><p>In this case the geodatabase has a single layer, so we don&rsquo;t need to specify it explicitly.  And note that on occasion it might be necessary to specify the type explicitly, for example by adding <code>-nlt MULTIPOLYGON</code>.</p>
<p>We can also load vector data using the <code>shp2pgsql</code> utility that is provided with PostGIS.  It only works for shapefiles, however.  So, to load the data this way we&rsquo;d first convert it to a shapefile as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ogr2ogr <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -f <span style="color:#e6db74">&#39;ESRI Shapefile&#39;</span> mb2020.shp <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  meshblock-2020-generalised.gpkg
</code></pre></div><p>and then use <code>shp2pgsql</code> to load it to a PostGIS table:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">shp2pgsql -s <span style="color:#ae81ff">2193</span> mb2020.shp statsnz.meshblock2020 | psql -d gis
</code></pre></div><p>Note that <code>shp2pgsql</code> actually just creates a large SQL script, and that is executed in the same way as any other.  <code>ogr2ogr</code> can also be used to create a SQL script which can be loaded directly to our database:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ogr2ogr -f PGDUMP mb2020.sql <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  meshblock-2020-generalised.gpkg <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -nln statsnz.meshblock2020
</code></pre></div><p>Actually, this approach should be preferred since transferring to shapefile as an intermediate step will cause attribute names to be truncated / normalised, and if the GeoPackage contains indexes, comments, and so forth, they will be retained.</p>
<p>Finally, one could load the data via R itself, though it probably isn&rsquo;t the best approach in general.  Still, to load the same GeoPackage:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(sf)

conn <span style="color:#f92672">&lt;-</span> RPostgreSQL<span style="color:#f92672">::</span><span style="color:#a6e22e">dbConnect</span>(
  <span style="color:#e6db74">&#34;PostgreSQL&#34;</span>, host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, port <span style="color:#f92672">=</span> <span style="color:#ae81ff">5432</span>,
  dbname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gis&#34;</span>, user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gisuser&#34;</span>, password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gisuser&#34;</span>
)

mb <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_read</span>(<span style="color:#e6db74">&#34;meshblock-2020-generalised.gpkg&#34;</span>)
<span style="color:#a6e22e">st_write</span>(mb, conn, <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;statsnz&#34;</span>, <span style="color:#e6db74">&#34;meshblock2020&#34;</span>))
DBI<span style="color:#f92672">::</span><span style="color:#a6e22e">dbDisconnect</span>(conn)
</code></pre></div><h2 id="raster-data">Raster data</h2>
<p>GDAL only offers read-only support for PostGIS currently (I think), so there are two options for loading rasters: using the <code>raster2pgsql</code> command-line tool provided by PostGIS, or using the <code>rpostgis::pgWriteRast</code> function in R.</p>
<p>One advantage of the <code>raster2pgsql</code> approach is that we can wildcard a large number of input files.  For example, for this blog, the <a href="https://data.linz.govt.nz/layer/95524-wellington-010m-urban-aerial-photos-2017/">Wellington aerial imagery</a> was downloaded as an archive containing 1667 jpeg files.  These can be loaded as <code>linz.wellington-010m-urban-aerial-2017</code> as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">raster2pgsql <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -I -C -e -Y -F -s <span style="color:#ae81ff">2193</span> -t 100x100 -l 2,4 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  *.jpg linz.wellington_010m_2017 | psql -U gisuser -d gis
</code></pre></div><p>There are some interesting options here.  Using <code>-e</code> means each file will be run as an independent query, rather than all running as a single transaction.  Using <code>-l 2,4</code> means that lower resolution (1/2 and 1/4) versions of the raster will be added to new tables called <code>o_2_wellington_010m_2017</code> and <code>o_4_wellington_010m_2017</code>, respectively.  See <a href="https://postgis.net/docs/using_raster_dataman.html">Raster Data Management, Queries, and Applications</a>.</p>
<p>Loading the data via R is possible, though not as straightforward.  In this case, while not recommended, we could do something like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(rpostgis)

conn <span style="color:#f92672">&lt;-</span> RPostgreSQL<span style="color:#f92672">::</span><span style="color:#a6e22e">dbConnect</span>(
  <span style="color:#e6db74">&#34;PostgreSQL&#34;</span>, host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, port <span style="color:#f92672">=</span> <span style="color:#ae81ff">5432</span>,
  dbname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gis&#34;</span>, user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gisuser&#34;</span>, password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gisuser&#34;</span>
)

files <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dir</span>(<span style="color:#e6db74">&#34;/home/cmhh/Downloads/shp/linz&#34;</span>, full.names <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
files <span style="color:#f92672">&lt;-</span> files<span style="color:#a6e22e">[grepl</span>(<span style="color:#e6db74">&#34;*.jpg$&#34;</span>, files)]
l <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lapply</span>(files, <span style="color:#a6e22e">function</span>(f) {
  <span style="color:#a6e22e">pgWriteRast</span>(
    conn, 
    <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;linz&#34;</span>, <span style="color:#e6db74">&#34;wellington_010m_2017&#34;</span>), 
    <span style="color:#a6e22e">stack</span>(f), 
    append <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>
  )
})

DBI<span style="color:#f92672">::</span><span style="color:#a6e22e">dbDisconnect</span>(conn)
</code></pre></div><h1 id="practical-examples">Practical Examples</h1>
<p>In this section we demonstrate a small number of practical use cases that are probably relatively common in many workflows.  We will start with a pure R approach in each case (if possible), before contrasting it with an equivalent approach which leverages PostGIS.</p>
<p>Note that all operations in this section were conducted on a single machine with 16GB of RAM and a Intel® Core™ i7-9750H CPU @ 2.60GHz × 12 processor.</p>
<h2 id="transforming--reprojecting-and-simplifying-features">Transforming / reprojecting and simplifying features</h2>
<p>Consider the <code>osm.gis_osm_landuse_a_free_1</code> feature class.  This is reasonably large, consisting of some 373272 features, and totalling 327MB as a shapefile on disk.  The features themselves are polygons that describe various types of land use, a section of which looks as follows:</p>
<a href="assets/upperhuttlanduse.png" target="_blank">
<img src="assets/upperhuttlanduselo.png" class="large">
</a>
<p>Assume we wish to do the following:</p>
<ul>
<li>read the shapefile</li>
<li>convert to EPSG 2193 (New Zealand Tranverse Mercator 2000)</li>
<li>simplify with 1 metre tolerance.</li>
</ul>
<p>To do this in R, we might do the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(sf)

landuse_nztm_1m <span style="color:#f92672">&lt;-</span> 
  <span style="color:#a6e22e">st_read</span>(<span style="color:#e6db74">&#34;gis_osm_landuse_a_free_1.shp&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">st_transform</span>(<span style="color:#ae81ff">2193</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">st_simplify</span>(preserveTopology <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, dTolerance <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
</code></pre></div><p>Peak memory use during this operation was approximately 2.5GB, and the operation took 63 seconds.  This same task can be conducted from R, but leaning heavily on PostGIS, by pulling the results of a SQL query as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">conn <span style="color:#f92672">&lt;-</span> RPostgreSQL<span style="color:#f92672">::</span><span style="color:#a6e22e">dbConnect</span>(
  <span style="color:#e6db74">&#34;PostgreSQL&#34;</span>, host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;localhost&#34;</span>, port <span style="color:#f92672">=</span> <span style="color:#ae81ff">5432</span>,
  dbname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gis&#34;</span>, user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gisuser&#34;</span>, password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gisuser&#34;</span>
)
  
landuse_nztm <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_read</span>(
  conn, 
  query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    SELECT 
</span><span style="color:#e6db74">      gid, osm_id, code, fclass, name, 
</span><span style="color:#e6db74">      ST_Simplify(ST_Transform(wkb_geometry, 2193), 1.0, FALSE) as geom 
</span><span style="color:#e6db74">    FROM 
</span><span style="color:#e6db74">      osm.gis_osm_landuse_a_free_1
</span><span style="color:#e6db74">  &#34;</span>
)
</code></pre></div><p>Peak memory usage throughout was 1.5GB, and the total execution time was 19.4 seconds.  In this case, then, PostGIS consumed 1GB (40%) less memory, and was 43.6 seconds (69%) faster than an in-memory approach using the <code>sf</code> package.</p>
<!--
## Intersecting two large features

Maybe do building outlines for a single SA2 or something?
-->
<h2 id="dissolving-features">Dissolving features</h2>
<p>A feature class can be dissolved by some categorical attribute using the <code>sf</code> package simply by performing a grouped aggregate, in this case with <code>dplyr</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(dplyr)

mb_dissolved_sf <span style="color:#f92672">&lt;-</span> 
  <span style="color:#a6e22e">st_read</span>(<span style="color:#e6db74">&#34;meshblock-2020-generalised.gpkg&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(LANDWATER_NAME) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarise</span>(n <span style="color:#f92672">=</span> <span style="color:#a6e22e">n</span>())
</code></pre></div><p>Peak memory use for this was about 530MB, and total execution time was 65.1 seconds.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">mb_dissolved <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_read</span>(
  conn, 
  query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    SELECT
</span><span style="color:#e6db74">      landwater_name, ST_Multi(ST_Union(geom)) as geom
</span><span style="color:#e6db74">    FROM 
</span><span style="color:#e6db74">      statsnz.meshblock2020
</span><span style="color:#e6db74">    GROUP BY 
</span><span style="color:#e6db74">      landwater_name
</span><span style="color:#e6db74">  &#34;</span>
)
</code></pre></div><p>Peak memory use for this was about 480MB, and total execution time was 67.9 seconds.  Importantly, peak memory usage for R itself was much smaller at 132.3MB.</p>
<p>The result either way can be plotted using the <code>geom_sf</code> geometry for <code>ggplot2</code>.  Before dissolving we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(ggplot2)

<span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_sf</span>(
    data <span style="color:#f92672">=</span> <span style="color:#a6e22e">st_read</span>(<span style="color:#e6db74">&#34;meshblock-2020-generalised.gpkg&#34;</span>), 
    <span style="color:#a6e22e">aes</span>(fill <span style="color:#f92672">=</span> LANDWATER_NAME)
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> <span style="color:#a6e22e">guide_legend</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>))
</code></pre></div><div class="large">
<a href=assets/mb.png target="_blank"><img src=assets/mb.png></a>
</div>
<p>After dissolving we have:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_sf</span>(
    data <span style="color:#f92672">=</span> mb_dissolved_sf, 
    <span style="color:#a6e22e">aes</span>(fill <span style="color:#f92672">=</span> LANDWATER_NAME), linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blank&#34;</span>
  ) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> <span style="color:#a6e22e">guide_legend</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>))
</code></pre></div><div class="large">
<a href=assets/mb.png target="_blank"><img src=assets/mbdissolve.png></a>
</div>
<h2 id="clipping-a-large-raster">Clipping a large raster</h2>
<p>The <a href="https://data.linz.govt.nz/layer/95524-wellington-010m-urban-aerial-photos-2017/">Wellington 0.10m Urban Aerial Photos (2017)</a> raster was downloaded in JPEG format.  Unpacked, the &lsquo;raster&rsquo; is 5.4GB, and is made up of 1667 individual JPEG files, each about 3.5MB in size.  Collectively, they look as follows:</p>
<a href="assets/wgtnaerial01.jpeg" target="_blank">
<img src="assets/wgtnaerial01lo.jpeg" class="large">
</a>
<p>In principle, these can be imported into R using the raster package.  For example, to create a raster from the first 2 JPEG files:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">f <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dir</span>(<span style="color:#e6db74">&#34;/home/cmhh/Downloads/shp/linz&#34;</span>, full.names <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
f <span style="color:#f92672">&lt;-</span> f<span style="color:#a6e22e">[grepl</span>(<span style="color:#e6db74">&#34;^.+(.jpg)$&#34;</span>, f)]
r <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">merge</span>(<span style="color:#a6e22e">brick</span>(f[1]), <span style="color:#a6e22e">brick</span>(f[2]))
</code></pre></div><p>which yields:</p>
<a href="assets/wgtnaerial02.jpeg" target="_blank">
<img src="assets/wgtnaerial02lo.jpeg" class="large">
</a>
<p>In practice, however, this approach is excruciatingly slow, and far from practical.  (Loading the raster to PostGIS is also excruciatingly slow, but it only needs to be done once, and then many users can use the result.) Now consider this same raster with the <code>statsnz.meshblock2020</code> feature class overlaid:</p>
<a href="assets/wgtnaerial03.jpeg" target="_blank">
<img src="assets/wgtnaerial03lo.jpeg" class="large">
</a>
<p>Assume that we just wish to use a single meshblock, 2122700, to mask the raster.  This can be done in R using the <code>gdalUtils::gdalwarp</code> function (which is just a wrapper for the <code>gdalwarp</code> command-line tool) as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(gdalUtils)

<span style="color:#a6e22e">gdalwarp</span>(
  srcfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    PG: dbname=&#39;gis&#39; host=127.0.0.1 port=5432 
</span><span style="color:#e6db74">    user=&#39;gisuser&#39; password=&#39;gisuser&#39; mode=2 
</span><span style="color:#e6db74">    schema=&#39;linz&#39; column=&#39;rast&#39; 
</span><span style="color:#e6db74">    table=&#39;wellington_010m_2017&#39;
</span><span style="color:#e6db74">  &#34;</span>,
  dstfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2122700.tif&#34;</span>,
  s_src <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EPSG:2193&#34;</span>, 
  t_srs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EPSG:2193&#34;</span>,
  multi <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>,
  cutline <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    PG:dbname=&#39;gis&#39; host=127.0.0.1 port=5432 
</span><span style="color:#e6db74">    user=&#39;gisuser&#39; password=&#39;gisuser&#39;
</span><span style="color:#e6db74">  &#34;</span>,
  csql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    select geom 
</span><span style="color:#e6db74">    from statsnz.meshblock2020 
</span><span style="color:#e6db74">    where mb2020_v1_00 = &#39;2122700&#39;
</span><span style="color:#e6db74">  &#34;</span>,
  crop_to_cutline <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>,
  dstnodata <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nodata&#34;</span>
)
</code></pre></div><p>Note that this took only a few seconds in practice, and outputs a single TIF file which can be read into R using <code>raster::stack(&quot;2122700.tif&quot;)</code>, and looks as follows:</p>
<a href="assets/wgtnrail.jpeg" target="_blank">
<img src="assets/wgtnraillo.jpeg" class="small">
</a>
<h1 id="extensions">Extensions</h1>
<p>PostGIS has a number of other uses.  One interesting use case is to pair it with <a href="http://geoserver.org/">GeoServer</a> so feature classes can be served as WMS features which can be included in <a href="https://leafletjs.com/">Leaflet</a> maps.  For an example of using GeoServer from R to create tile services on the fly, see <a href="../../post/geoserver/">Building Tile Services on-the-fly with GeoServer</a>.</p>
<div style="padding-bottom: 10px;"><video width="878" controls>
<source src="assets/geoserver.mp4" type="video/mp4">
Your browser does not support the video tag.
</video></div>
<p>Note that GeoServer supports the use of rasters, though it is a little involved.  See, for example, <a href="https://docs.geoserver.org/latest/en/user/data/raster/imagemosaic/index.html#data-imagemosaic">GeoServer User Manual - ImageMosaic</a>.</p>
<p>Another method of using PostGIS to serve features is via  <a href="https://github.com/CrunchyData/pg_tileserv">pg_tileserv</a> or <a href="https://github.com/CrunchyData/pg_featureserv">pg_featureserv</a>.  The first is used to serve PostGIS feature tables as tiles, the second will serve PostGIS feature tables in a range of OGC API formats.  All of this might make for an interesting follow-up post in the future.</p>
<h1 id="appendix---installing-dependencies">Appendix - Installing Dependencies</h1>
<p>For this demonstration, one can deploy all required software via Docker containers.  This ensures it is very easy to reproduce everything shown here if desired.</p>
<h2 id="installing-docker">Installing Docker</h2>
<p>Docker is relatively easy to install on Linux systems.  Reasonably new versions will sometimes be available from standard repositories, but a newer version can be obtained for most distributions by following the instructions:</p>
<p><a href="https://docs.docker.com/engine/install/">Install Docker Engine</a></p>
<p>While Windows users can run Linux containers via <a href="https://docs.docker.com/docker-for-windows/install/">Docker Desktop</a>, they are strongly encouraged to enable the Windows Subsystem for Linux version 2 (WSL2), and instead install Docker on Linux.  For a rundown on using Docker via WSL2 see:</p>
<p><a href="../../post/docker_wsl2/">Docker on Windows with Windows Subsystem for Linux 2</a></p>
<p>I have no experience with Docker on a Mac, but <a href="https://docs.docker.com/docker-for-mac/install/">Docker Desktop</a> is available.  It has apparently had performance issues in the past, though newer versions might be much better.  The release notes for version 2.3.5.0 (2020-08-21) have the following promising inclusion:</p>
<blockquote>
<p>Docker Desktop now uses gRPC-FUSE for file sharing by default. This has much faster file sharing and uses much less CPU than osxfs, especially when there are lots of file events on the host. To switch back to osxfs, go to Preferences &gt; General and disable gRPC-FUSE.</p>
</blockquote>
<h2 id="installing-postgresql-and-postgis">&lsquo;Installing&rsquo; PostgreSQL and PostGIS</h2>
<p>There are Docker images available which contain both PostgreSQL and PostGIS, though it is instructive to create one.  First, create a file called <code>Dockerfile</code> with the following content:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive
<span style="color:#66d9ef">ENV</span> SHELL<span style="color:#f92672">=</span>/bin/bash<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span>  apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get -y dist-upgrade <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get install -y --no-install-recommends <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    wget gnupg2 ca-certificates gdal-bin sudo vim <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sh -c <span style="color:#e6db74">&#39;echo &#34;deb http://apt.postgresql.org/pub/repos/apt focal-pgdg main&#34; &gt; /etc/apt/sources.list.d/pgdg.list&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y --no-install-recommends postgresql-13 postgresql-13-postgis-3 postgis <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get clean <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  rm -rf /var/lib/apt/lists/*<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> service postgresql start <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -c <span style="color:#e6db74">&#39;create database gis;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -d gis -c <span style="color:#e6db74">&#39;create extension postgis;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -d gis -c <span style="color:#e6db74">&#39;create extension postgis_raster;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -d gis -c <span style="color:#e6db74">&#39;create extension postgis_sfcgal;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -d gis -c <span style="color:#e6db74">&#39;create extension postgis_topology;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -d gis -c <span style="color:#e6db74">&#34;SET postgis.gdal_enabled_drivers = &#39;ENABLE_ALL&#39;;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -c <span style="color:#e6db74">&#39;create user gisuser;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -c <span style="color:#e6db74">&#34;alter user gisuser with encrypted password &#39;gisuser&#39;;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sudo -u postgres psql -c <span style="color:#e6db74">&#39;grant all privileges on database gis to gisuser;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  printf <span style="color:#e6db74">&#34;\tlisten_addresses=&#39;*&#39;\t&#34;</span> &gt;&gt; /etc/postgresql/13/main/postgresql.conf <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sed -i -E <span style="color:#e6db74">&#39;/local +all +all +peer/ s/peer/md5/&#39;</span> /etc/postgresql/13/main/pg_hba.conf <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sed -i -E <span style="color:#e6db74">&#39;/host +all +all +127.0.0.1\/32 +md5/ s/127.0.0.1\/32/0.0.0.0\/0   /&#39;</span> /etc/postgresql/13/main/pg_hba.conf <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sed -i -E <span style="color:#e6db74">&#39;/host +all +all +::1\/128 +md5/ s/::1\/128/::0\/0  /&#39;</span> /etc/postgresql/13/main/pg_hba.conf <span style="color:#f92672">&amp;&amp;</span><span style="color:#ae81ff">\ </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  printf <span style="color:#e6db74">&#34;localhost:5432:gis:gisuser:gisuser&#34;</span> &gt;&gt; /root/.pgpass <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  chmod <span style="color:#ae81ff">0600</span> /root/.pgpass<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 5432</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> service postgresql start <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  tail -f /dev/null  <span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>To build the image, change into the directory containing <code>Dockerfile</code> and run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker build -t postgis .
</code></pre></div><p>If we wish to persist our database, we can create a volume as so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker volume create pgdata
</code></pre></div><p>Then, to run an instance with the volume mounted, as well as a folder containing all the required source features (if desired):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d --rm --name postgis <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -p 5432:5432 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v /path/to/downloaded/data:/data <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -v pgdata:/var/lib/postgresql/13/main <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  postgis
</code></pre></div><p>To gain terminal access to the running container, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker exec -it postgis bash
</code></pre></div><h2 id="installing-r-and-required-spatial-dependencies">&lsquo;Installing&rsquo; R and required spatial dependencies</h2>
<p>To create a Linux container with R and RStudio Server, create a file called <code>Dockerfile</code> with content as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> rstudio_version<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>.3.1093<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive
<span style="color:#66d9ef">ENV</span> SHELL<span style="color:#f92672">=</span>/bin/bash<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> RSTUDIO_VERSION<span style="color:#f92672">=</span>$rstudio_version<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># install necessary packages</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span>  apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get -y dist-upgrade <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get install -y --no-install-recommends <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    gnupg2 ca-certificates gdebi-core wget odbc-postgresql libblas3 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    grass gdal-bin libgdal-dev libgeos-dev libproj-dev proj-bin proj-data <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sed -i -e <span style="color:#e6db74">&#39;s/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/&#39;</span> /etc/locale.gen <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  dpkg-reconfigure --frontend<span style="color:#f92672">=</span>noninteractive locales <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  update-locale LANG<span style="color:#f92672">=</span>en_US.UTF-8 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  wget -qO- <span style="color:#e6db74">&#34;https://yihui.org/gh/tinytex/tools/install-unx.sh&#34;</span> | sh -s - --admin --no-path <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  mv /root/.TinyTeX /usr/local/TinyTex <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  /usr/local/TinyTex/bin/*/tlmgr path add <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  printf <span style="color:#e6db74">&#34;deb https://cloud.r-project.org/bin/linux/ubuntu focal-cran40/&#34;</span> &gt;&gt; /etc/apt/sources.list <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y --no-install-recommends r-base <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  wget https://download2.rstudio.org/server/bionic/amd64/rstudio-server-<span style="color:#e6db74">${</span>RSTUDIO_VERSION<span style="color:#e6db74">}</span>-amd64.deb <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  gdebi rstudio-server-<span style="color:#e6db74">${</span>RSTUDIO_VERSION<span style="color:#e6db74">}</span>-amd64.deb <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  rm rstudio-server-<span style="color:#e6db74">${</span>RSTUDIO_VERSION<span style="color:#e6db74">}</span>-amd64.deb <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  apt-get clean <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  rm -rf /var/lib/apt/lists/* <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  R -e <span style="color:#e6db74">&#34;install.packages(c(&#39;renv&#39;, &#39;rgdal&#39;, &#39;rgeos&#39;, &#39;sf&#39;, &#39;leaflet&#39;, &#39;RPostgreSQL&#39;, &#39;rpostgis&#39;))&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  wget https://download2.rstudio.org/server/bionic/amd64/rstudio-server-<span style="color:#e6db74">${</span>RSTUDIO_VERSION<span style="color:#e6db74">}</span>-amd64.deb <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  gdebi --non-interactive rstudio-server-<span style="color:#e6db74">${</span>RSTUDIO_VERSION<span style="color:#e6db74">}</span>-amd64.deb <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  rm rstudio-server-<span style="color:#e6db74">${</span>RSTUDIO_VERSION<span style="color:#e6db74">}</span>-amd64.deb<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># add user for demo purposes</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> adduser --disabled-password --gecos <span style="color:#e6db74">&#34;&#34;</span> guest <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  usermod --password <span style="color:#66d9ef">$(</span>openssl passwd -1 guest<span style="color:#66d9ef">)</span> guest <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  usermod -aG sudo guest <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8787</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> service rstudio-server start <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  tail -f /dev/null<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>To build this container, simply change into the directory containing <code>Dockerfile</code> and run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker build -t rstudio .
</code></pre></div><p>The image can be started by running:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d --rm --name rstudio -p 8787:8787 rstudio
</code></pre></div><p>When done, RStudio will be available via a web browser at <code>http://localhost:8787</code>.</p>
<p><img src="assets/rdocker.png" alt=""></p>

            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="../../tags/akka-http">akka-http</a></span>
        
            <span class="tag"><a href="../../tags/docker">docker</a></span>
        
            <span class="tag"><a href="../../tags/geoserver">geoserver</a></span>
        
            <span class="tag"><a href="../../tags/geospark">geospark</a></span>
        
            <span class="tag"><a href="../../tags/geospatial">geospatial</a></span>
        
            <span class="tag"><a href="../../tags/nodejs">nodejs</a></span>
        
            <span class="tag"><a href="../../tags/osrm">osrm</a></span>
        
            <span class="tag"><a href="../../tags/postgis">postgis</a></span>
        
            <span class="tag"><a href="../../tags/postgresql">postgresql</a></span>
        
            <span class="tag"><a href="../../tags/qgis">qgis</a></span>
        
            <span class="tag"><a href="../../tags/r">r</a></span>
        
            <span class="tag"><a href="../../tags/r-packages">r-packages</a></span>
        
            <span class="tag"><a href="../../tags/seasonal-adjustment">seasonal-adjustment</a></span>
        
            <span class="tag"><a href="../../tags/sedona">sedona</a></span>
        
            <span class="tag"><a href="../../tags/shiny">shiny</a></span>
        
            <span class="tag"><a href="../../tags/spark">spark</a></span>
        
            <span class="tag"><a href="../../tags/tiles">tiles</a></span>
        
            <span class="tag"><a href="../../tags/tilestache">tilestache</a></span>
        
            <span class="tag"><a href="../../tags/vuejs">vuejs</a></span>
        
            <span class="tag"><a href="../../tags/wmts">wmts</a></span>
        
            <span class="tag"><a href="../../tags/wsl2">wsl2</a></span>
        
            <span class="tag"><a href="../../tags/x13-arima-seats">x13-arima-seats</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="../../2021/2021-08-08-online-learning-with-akka/">Online Learning with Akka</a></h1>
            <time class="has-text-grey-light is-size-7">8 August 2021</time>
        
            <h1><a href="../../2021/2021-07-30-online-learning-with-apache-kafka/">Online Learning with Apache Kafka</a></h1>
            <time class="has-text-grey-light is-size-7">30 July 2021</time>
        
            <h1><a href="../../2021/2021-04-19-a-brief-look-at-apache-sedona/">A Brief Look at Apache Sedona</a></h1>
            <time class="has-text-grey-light is-size-7">19 April 2021</time>
        
            <h1><a href="../../2020/2020-12-05-working-productively-on-windows-using-wsl2-and-docker/">Working Productively on Windows Using Windows Subsystem for Linux 2 and Docker</a></h1>
            <time class="has-text-grey-light is-size-7">5 December 2020</time>
        
            <h1><a href="../../2020/2020-10-31-using-postgis-as-a-spatial-backend-for-r/">Using PostGIS as a Spatial Backend for R</a></h1>
            <time class="has-text-grey-light is-size-7">31 October 2020</time>
        
    </div>
</div>
    <br>
                
  



<div class="card">
    <div class="card-content">
        <h1 class="title is-5">Related posts</h1>
      
      
            <h1><a href="../../2019/2019-09-17-building-tile-services-on-the-fly-with-geoserver/">Building Tile Services on-the-fly with GeoServer</a></h1>
            <time class="has-text-grey-light is-size-7">17 September 2019</time>
      
            <h1><a href="../../2016/2016-11-27-routing-in-r-using-osrm/">Routing in R Using the Open Source Routing Machine (OSRM)</a></h1>
            <time class="has-text-grey-light is-size-7">27 November 2016</time>
      
            <h1><a href="../../2016/2016-07-20-data-packages/">Using R Packages to Disseminate Data</a></h1>
            <time class="has-text-grey-light is-size-7">20 July 2016</time>
      
    </div>
</div>

    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="../../archives/2021">2021</a> (3)<br>
        
            <a href="../../archives/2020">2020</a> (4)<br>
        
            <a href="../../archives/2019">2019</a> (1)<br>
        
            <a href="../../archives/2017">2017</a> (1)<br>
        
            <a href="../../archives/2016">2016</a> (4)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://github.com/cmhh" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="mailto://cmhhansen@outlook.com" class="mysocial" rel="me"><i class="fas fa-envelope fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; cmhh 2021 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="//yihui.org/js/math-code.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>




</body>
</html>
