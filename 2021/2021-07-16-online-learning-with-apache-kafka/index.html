<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>cmhh  | Online Learning with Apache Kafka</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link href="../../css/highlight/atom-one-dark-reasonable.css" rel='stylesheet' type='text/css' />
    <link rel="stylesheet" href="../../css/blog.css" />
    <link rel="stylesheet" href="../../css/custom.css" />
</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="../../">Home</a>
            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(/img/bg-blog-2.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Online Learning with Apache Kafka
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <h1 id="overview">Overview</h1>
<p>I recently came across a scenario at work that would, like <it>so</it> many things in practice, be particularly well modelled as an ordered set of events.  The messages would have a large number of uses in practice, but one would involve using them to train some sort of predictive model.  Moreover, the messages would be arriving in real-time, and the patterns underpinning the messages might well change over time.  Based on previous research, Kafka seemed like it would be a good fit, though I don&rsquo;t yet have a huge amount of practical experience using it.  So I decided to create a simplified version of my real use case, and then write it up as a post.  We&rsquo;ll use a producer to read messages in a topic, and a consumer will then read those messages and update our model.  If nothing else, the exercise should also serve as a reasonably accessible example of the use of Kafka producers and consumers.  Let&rsquo;s get to it&hellip;</p>
<h1 id="problem-description">Problem Description</h1>
<p>We use the popular <a href="http://yann.lecun.com/exdb/mnist/">MNIST database of handwritten digits</a>.  The database contains hand-written digits represented as 28x28 pixel arrays with integer values in the range \([0,255]\) representing grey-scale colours.  The images are split into training and test sets with 60000 and 10000 images, respectively.  The following image contains a collage of randomly selected examples:</p>
<img src="assets/random1.png" class="large">
<p>Broadly speaking, Kafka consists of <em>topics</em>, effectively partitioned log files.  <em>Producers</em> append new messages to topics, and <em>consumers</em> read them.  In this demonstration we&rsquo;ll simply add all the MNIST training images to a Kafka topic, but we&rsquo;ll throttle the rate at which this is done.  At the same time, a consumer will continuously poll the topic and use any messages received to update a simple classifier, and will report model accuracy after each update.</p>
<p>This isn&rsquo;t a terribly realistic example, and is intended for demonstrative purposes.  We&rsquo;ll work through just one epoch, but we&rsquo;ll see that training accuracy is indeed improving as new messages are received.  In more realistic set-ups we&rsquo;d probably start with a pre-trained model, and use real-time data to refine our model.  Of course, we can replay a log, and so it would certainly be possible to train our model over many epochs if we wished.</p>
<!--
## Consumer Pattern 1

Here, we simply consume the topic from start to finish, and we update our model message-by-message.  If we had a pre-trained model, this might well represent a perfect online training scenario, and would more closely apply to the use-case described in the overview.

## Consumer Pattern 2

Here, we simply consume the topic from start to finish, but we use an internal buffer to store images, and we train our model in batches of size \\(n\\).

## Consumer Pattern 3

Here, we again consume the topic from start to finish, but our buffer holds \\(m\times{}n\\) messages, rather than \\(n\\).  We train our model by taking random samples without replacement from our buffer of size \\(n\\) until it is empty, and in this way we at least present our training data in a somewhat random order.
-->
<h1 id="implementation">Implementation</h1>
<p>The complete application can be found on GitHub at <a href="https://github.com/cmhh/kafkatrain">cmhh/kafkatrain</a>, and the <code>README</code> includes enough information to get up and running.  Note that the repository includes the <a href="http://yann.lecun.com/exdb/mnist/">MNIST database</a> since the data is only 12MB all up, and the original source urges users to &lsquo;Please refrain from accessing these files from automated scripts with high frequency. Make copies!&rsquo;.   Either way, in this section we discuss the most important bits in more detail.</p>
<h2 id="install-and-start-kafka">Install and Start Kafka</h2>
<p>Even though all the source for this exercise is provided as an sbt project, we still need a running broker.  There are a number of ways we can do this, but it will suffice to simply download a pre-compiled bundle from the Kafka website directly.  At the time of writing, the most recent version of Kafka is 2.8.0, and it can be downloaded via the following link:</p>
<p><a href="https://www.apache.org/dyn/closer.cgi?path=/kafka/2.8.0/kafka_2.13-2.8.0.tgz">Kafka 2.8.0 for Scala 2.13</a></p>
<p>I just downloaded this to the root of the project folder, and unpacked it there, the result being <code>kafka_2.13-2.8.0</code>.  We first start Apache Zookeeper as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./kafka_2.13-2.8.0/bin/zookeeper-server-start.sh <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  ./kafka_2.13-2.8.0/config/zookeeper.properties
</code></pre></div><p>Kafka is distributed, and Zookeeper is used to coordinate the nodes.  Note that this function will soon be handled natively by Kafka so will not be a requirement much longer.  Either way, we then start our Kafka broker by running:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./kafka_2.13-2.8.0/bin/kafka-server-start.sh <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  ./kafka_2.13-2.8.0/config/server.properties
</code></pre></div><p><a href="https://github.com/obsidiandynamics/kafdrop">Kafdrop</a> is a useful web UI which can be used to monitor Kafka brokers, and we can get this up and running quickly via Docker as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d --rm <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --net host <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e KAFKA_BROKERCONNECT<span style="color:#f92672">=</span>localhost:9092 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e JVM_OPTS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Xms32M -Xmx64M&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -e SERVER_SERVLET_CONTEXTPATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  obsidiandynamics/kafdrop
</code></pre></div><h2 id="create-a-kafka-topic">Create a Kafka Topic</h2>
<p>Here, our events or messages will just be instances of the <code>MnistRecord</code> case class, so we need to create a topic to hold them.  We can do this at the terminal, assuming our Kafka broker is running, as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./kafka_2.13-2.8.0/bin/kafka-topics.sh <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --bootstrap-server localhost:9092 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --create --partitions <span style="color:#ae81ff">3</span> --replication-factor <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --topic mnist
</code></pre></div><p>Topics can also be added and deleted easily enough via the Kafdrop web UI.</p>
<h2 id="model-our-messages">Model Our Messages</h2>
<p>The MNIST database consists of handwritten images of 28x28 pixels, each assigned a label from 0 to 9.  The image data is easily read from the provided files as an array of bytes in row-major order, so we define a simple case class as follows (the class has a number of methods, but we omit the details here):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Image</span><span style="color:#f92672">(</span>data<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Byte</span><span style="color:#f92672">],</span> rows<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> cols<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> byrow<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span>
</code></pre></div><p>Note that the <code>byrow</code> parameter is included since I also tested this code with the <a href="https://www.nist.gov/itl/products-and-services/emnist-dataset">EMNIST database</a>.  This is a database which is intended to largely be a drop-in replacement for MNIST, but with a larger number of categories.  However, while the IDX format is used for both, EMNIST appears to store pixels in column-major order, whereas MNIST is in row-major order.  Either way, the labelled images can then be modelled simply, also using a case class, as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MnistRecord</span><span style="color:#f92672">(</span>image<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Image</span><span style="color:#f92672">,</span> label<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span>
</code></pre></div><p>The MNIST data has been bundled as a resource in the provided sbt project, and a basic, single-use iterator is provided also.  For example, to read the training data:</p>
<div class="REPL">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">val</span> testIt <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">MnistIterator</span><span style="color:#f92672">(</span><span style="color:#a6e22e">MnistType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TRAIN</span><span style="color:#f92672">)</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> testIt<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">org.cmhh.MnistIterator</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>iterator<span style="color:#f92672">&gt;</span>
</code></pre></div></div>
<h2 id="serialisation--deserialisation">Serialisation / Deserialisation</h2>
<p>Messages are transmitted and stored as sequences of bytes, and so we need the ability to convert our messages to byte arrays (serialisation) and back again (deserialisation).  The <code>MnistRecord</code> type is relatively simple–our images are already stored as byte arrays, and we just need to append one more byte to account for the image label.</p>
<p>To create a serialiser we mix in the <code>Serializer[T]</code> trait, and we must provide a concrete implementation of method <code>serialize</code> with signature:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> serialize<span style="color:#f92672">(</span>topic<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> data<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">T</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Byte</span><span style="color:#f92672">]</span>
</code></pre></div><p>To create a deserialiser we mix in the <code>Deserialzer[T]</code> trait, and we must provide a concrete implemenation of method <code>deserialize</code> with signature:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> deserialize<span style="color:#f92672">(</span>topic<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> data<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Byte</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">T</span>
</code></pre></div><p>We can define everything together in one class, though one needs to take care since the two traits have methods with the same name, so we need to override things just so.  The full implementation in this case is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> org.apache.kafka.common.serialization.<span style="color:#f92672">{</span><span style="color:#a6e22e">Serializer</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Deserializer</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Serde</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Serdes</span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MnistRecordSerde</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Serde</span><span style="color:#f92672">[</span><span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">]</span> 
<span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Serializer</span><span style="color:#f92672">[</span><span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Deserializer</span><span style="color:#f92672">[</span><span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> serializer<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Serializer</span><span style="color:#f92672">[</span><span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">this</span>
  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> deserializer<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Deserializer</span><span style="color:#f92672">[</span><span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">this</span>
  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> close<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">()</span>
  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> configure<span style="color:#f92672">(</span>configs<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">java.util.Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">_</span><span style="color:#f92672">],</span> isKey<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#f92672">()</span>
  <span style="color:#66d9ef">val</span> <span style="color:#a6e22e">Serde</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Serde</span><span style="color:#f92672">[</span><span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Serdes</span><span style="color:#f92672">.</span>serdeFrom<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">)</span>

  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> serialize<span style="color:#f92672">(</span>topic<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> data<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Byte</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> 
    data<span style="color:#f92672">.</span>image<span style="color:#f92672">.</span>data <span style="color:#66d9ef">:</span><span style="color:#66d9ef">+</span> <span style="color:#66d9ef">data.label.toByte</span>

  <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> deserialize<span style="color:#f92672">(</span>topic<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> data<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Byte</span><span style="color:#f92672">])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MnistRecord</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> m <span style="color:#66d9ef">=</span> data<span style="color:#f92672">.</span>size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">val</span> n <span style="color:#66d9ef">=</span> math<span style="color:#f92672">.</span>sqrt<span style="color:#f92672">(</span>m<span style="color:#f92672">).</span>toInt
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">*</span> n <span style="color:#f92672">!=</span> m<span style="color:#f92672">)</span> sys<span style="color:#f92672">.</span>error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;oops.&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">MnistRecord</span><span style="color:#f92672">(</span>
      <span style="color:#a6e22e">Image</span><span style="color:#f92672">(</span>data<span style="color:#f92672">.</span>take<span style="color:#f92672">(</span>m<span style="color:#f92672">),</span> n<span style="color:#f92672">,</span> n<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">),</span>
      data<span style="color:#f92672">(</span>m<span style="color:#f92672">).</span>toInt
    <span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="producer">Producer</h2>
<p>Our producer is very simple.  In this case it is a standard driver program, and the complete program is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">package</span> org.cmhh

<span style="color:#66d9ef">import</span> org.apache.kafka.clients.producer._
<span style="color:#66d9ef">import</span> org.apache.kafka.common.serialization._
<span style="color:#66d9ef">import</span> scala.jdk.CollectionConverters._
<span style="color:#66d9ef">import</span> scala.concurrent.duration.Duration
<span style="color:#66d9ef">import</span> scala.concurrent.<span style="color:#f92672">{</span><span style="color:#a6e22e">Await</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Future</span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">import</span> scala.concurrent.ExecutionContext.Implicits.global
<span style="color:#66d9ef">import</span> scala.util.<span style="color:#f92672">{</span><span style="color:#a6e22e">Success</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Failure</span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">import</span> java.util.Properties

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ProducerApp</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">App</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">val</span> delay <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>args<span style="color:#f92672">.</span>size <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> args<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">).</span>toInt <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">val</span> trainIt<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MnistIterator</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">MnistIterator</span><span style="color:#f92672">(</span><span style="color:#a6e22e">MnistType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TRAIN</span><span style="color:#f92672">)</span>
  <span style="color:#66d9ef">val</span> n <span style="color:#66d9ef">=</span> trainIt<span style="color:#f92672">.</span>size

  <span style="color:#66d9ef">val</span> props <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Properties</span><span style="color:#f92672">()</span>
  props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bootstrap.servers&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;localhost:9092&#34;</span><span style="color:#f92672">)</span>
  props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;key.serializer&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;org.apache.kafka.common.serialization.StringSerializer&#34;</span><span style="color:#f92672">)</span>
  props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value.serializer&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;org.cmhh.MnistRecordSerde&#34;</span><span style="color:#f92672">)</span>

  <span style="color:#66d9ef">val</span> producer <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">KafkaProducer</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">](</span>props<span style="color:#f92672">)</span>

  print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n\nSending messages...\n\n0.0%...&#34;</span><span style="color:#f92672">)</span>

  <span style="color:#66d9ef">val</span> res <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Future</span><span style="color:#f92672">.</span>sequence<span style="color:#f92672">(</span>trainIt<span style="color:#f92672">.</span>zipWithIndex<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>rec <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> msg <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ProducerRecord</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">](</span>
      <span style="color:#e6db74">&#34;mnist&#34;</span><span style="color:#f92672">,</span> 
      <span style="color:#e6db74">s&#34;%05d&#34;</span><span style="color:#f92672">.</span>format<span style="color:#f92672">(</span>rec<span style="color:#f92672">.</span>_2<span style="color:#f92672">),</span> 
      rec<span style="color:#f92672">.</span>_1
    <span style="color:#f92672">)</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>rec<span style="color:#f92672">.</span>_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">%</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> 
      print<span style="color:#f92672">(</span><span style="color:#e6db74">s&#34;</span><span style="color:#e6db74">${</span><span style="color:#f92672">(</span>rec<span style="color:#f92672">.</span>_2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">).</span>toDouble <span style="color:#f92672">/</span> n <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span><span style="color:#e6db74">}</span><span style="color:#e6db74">%... &#34;</span><span style="color:#f92672">)</span>
      
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>delay <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#a6e22e">Thread</span><span style="color:#f92672">.</span>sleep<span style="color:#f92672">(</span>delay<span style="color:#f92672">)</span>
    <span style="color:#a6e22e">Future</span> <span style="color:#f92672">{</span> producer<span style="color:#f92672">.</span>send<span style="color:#f92672">(</span>msg<span style="color:#f92672">).</span>get <span style="color:#f92672">}</span>
  <span style="color:#f92672">}))</span>

  <span style="color:#a6e22e">Await</span><span style="color:#f92672">.</span>ready<span style="color:#f92672">(</span>res<span style="color:#f92672">,</span> <span style="color:#a6e22e">Duration</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Inf</span><span style="color:#f92672">)</span>

  print<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n\nDone.\n\n&#34;</span><span style="color:#f92672">)</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>We first create an instance of <code>KafkaProducer</code>, which is responsible for publishing our messages.  This client object requires a configuration in order to be initialised, in this case an instance of <code>Properties</code>.  Our properties include the address of our broker, as well as the serialisation classes for our keys and for our messages.  In this case, our message keys will be the strings <code>00001</code> through <code>60000</code>, and they&rsquo;ll be serialised via <code>StringSerializer</code>.  Our messages are, of course, <code>MnistRecord</code>, and they&rsquo;ll be serialised using the custom serialiser <code>MnistRecordSerde</code>.  Otherwise, the driver program simply iterates over the training set, sending each, and then waiting some amount of time in milliseconds before moving on to the next, and we are notified on standard output how far we are through the full set in 10 percentage point increments.  Messages are published by calling the <code>send</code> method of our <code>KafkaProducer</code>.  This is asynchronous, and returns a Java-style <code>Future</code>, though in this case our messages are still stored in the correct order in our topic.</p>
<h2 id="consumer">Consumer</h2>
<p>Our consumer is a little more complicated.  First, we initialise a simple neural network using the Deeplearning4j library.  The complete setup is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> cnn<span style="color:#f92672">(</span>learningRate<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Double</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span><span style="color:#f92672">,</span> seed<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MultiLayerNetwork</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">val</span> architecture <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">NeuralNetConfiguration</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">.</span>seed<span style="color:#f92672">(</span>seed<span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>updater<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Sgd</span><span style="color:#f92672">(</span>learningRate<span style="color:#f92672">))</span> 
    <span style="color:#f92672">.</span>weightInit<span style="color:#f92672">(</span><span style="color:#a6e22e">WeightInit</span><span style="color:#f92672">.</span><span style="color:#a6e22e">XAVIER</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>l2<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span>e<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>list<span style="color:#f92672">()</span>
    <span style="color:#f92672">.</span>layer<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ConvolutionLayer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>stride<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>padding<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>nOut<span style="color:#f92672">(</span><span style="color:#ae81ff">32</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>activation<span style="color:#f92672">(</span><span style="color:#a6e22e">Activation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RELU</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>build<span style="color:#f92672">()</span>
    <span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>layer<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SubsamplingLayer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">(</span><span style="color:#a6e22e">SubsamplingLayer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">PoolingType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MAX</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>kernelSize<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span><span style="color:#ae81ff">2</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>stride<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>build<span style="color:#f92672">()</span>
    <span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>layer<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DenseLayer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">()</span>
      <span style="color:#f92672">.</span>nOut<span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>activation<span style="color:#f92672">(</span><span style="color:#a6e22e">Activation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">RELU</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>build<span style="color:#f92672">()</span>
    <span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>layer<span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">OutputLayer</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">(</span><span style="color:#a6e22e">LossFunctions</span><span style="color:#f92672">.</span><span style="color:#a6e22e">LossFunction</span><span style="color:#f92672">.</span><span style="color:#a6e22e">MCXENT</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>nOut<span style="color:#f92672">(</span><span style="color:#ae81ff">10</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>activation<span style="color:#f92672">(</span><span style="color:#a6e22e">Activation</span><span style="color:#f92672">.</span><span style="color:#a6e22e">SOFTMAX</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>build<span style="color:#f92672">()</span>
    <span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>setInputType<span style="color:#f92672">(</span><span style="color:#a6e22e">InputType</span><span style="color:#f92672">.</span>convolutionalFlat<span style="color:#f92672">(</span><span style="color:#ae81ff">28</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">28</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">))</span>
    <span style="color:#f92672">.</span>build

  <span style="color:#66d9ef">val</span> network <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MultiLayerNetwork</span><span style="color:#f92672">(</span>architecture<span style="color:#f92672">)</span>
  network<span style="color:#f92672">.</span>init<span style="color:#f92672">()</span>
  network
<span style="color:#f92672">}</span>
</code></pre></div><p>We&rsquo;re not aiming for best-in-breed here–just something that we can train reasonably quickly, and which shows increasing accuracy as more of the topic is consumed.  The full consumer application then looks as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">package</span> org.cmhh

<span style="color:#66d9ef">import</span> org.apache.kafka.clients.consumer._
<span style="color:#66d9ef">import</span> org.apache.kafka.common.serialization._
<span style="color:#66d9ef">import</span> scala.jdk.CollectionConverters._
<span style="color:#66d9ef">import</span> scala.concurrent.duration.Duration
<span style="color:#66d9ef">import</span> scala.concurrent.<span style="color:#f92672">{</span><span style="color:#a6e22e">Await</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Future</span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">import</span> scala.concurrent.ExecutionContext.Implicits.global
<span style="color:#66d9ef">import</span> scala.util.<span style="color:#f92672">{</span><span style="color:#a6e22e">Success</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">Failure</span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">import</span> java.util.Properties
<span style="color:#66d9ef">import</span> java.time.<span style="color:#f92672">{</span><span style="color:#a6e22e">Duration</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">JDuration</span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">import</span> org.nd4j.evaluation.classification.Evaluation

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">ConsumerApp</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">App</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">val</span> t <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Thread</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">def</span> run<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Unit</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">val</span> props <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Properties</span><span style="color:#f92672">()</span>
      props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bootstrap.servers&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;localhost:9092&#34;</span><span style="color:#f92672">)</span>
      props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;key.deserializer&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span><span style="color:#f92672">)</span>
      props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;value.deserializer&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;org.cmhh.MnistRecordSerde&#34;</span><span style="color:#f92672">)</span>
      props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;group.id&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;mnist-train&#34;</span><span style="color:#f92672">)</span>
      props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;auto.offset.reset&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;earliest&#34;</span><span style="color:#f92672">)</span>
      props<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;enable.auto.commit&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>

      <span style="color:#66d9ef">val</span> consumer <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">KafkaConsumer</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">](</span>props<span style="color:#f92672">)</span>
      consumer<span style="color:#f92672">.</span>subscribe<span style="color:#f92672">(</span>java<span style="color:#f92672">.</span>util<span style="color:#f92672">.</span><span style="color:#a6e22e">Collections</span><span style="color:#f92672">.</span>singletonList<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;mnist&#34;</span><span style="color:#f92672">))</span>
      
      <span style="color:#66d9ef">val</span> network <span style="color:#66d9ef">=</span> model<span style="color:#f92672">.</span>ann<span style="color:#f92672">()</span> 
      <span style="color:#66d9ef">val</span> mnistTest <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MnistDataSetIterator</span><span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">MnistType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TEST</span><span style="color:#f92672">)</span>

      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">val</span> recs <span style="color:#66d9ef">=</span> consumer<span style="color:#f92672">.</span>poll<span style="color:#f92672">(</span><span style="color:#a6e22e">JDuration</span><span style="color:#f92672">.</span>ofMillis<span style="color:#f92672">(</span><span style="color:#ae81ff">1000</span><span style="color:#f92672">))</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>recs<span style="color:#f92672">.</span>count<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">val</span> it <span style="color:#66d9ef">=</span> recs<span style="color:#f92672">.</span>iterator
          <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>it<span style="color:#f92672">.</span>hasNext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
            <span style="color:#66d9ef">val</span> im <span style="color:#66d9ef">=</span> it<span style="color:#f92672">.</span>next<span style="color:#f92672">().</span>value<span style="color:#f92672">.</span>toNd4j
            network<span style="color:#f92672">.</span>fit<span style="color:#f92672">(</span>im<span style="color:#f92672">.</span>_1<span style="color:#f92672">,</span> im<span style="color:#f92672">.</span>_2<span style="color:#f92672">)</span>
          <span style="color:#f92672">}</span>

          <span style="color:#66d9ef">val</span> eval <span style="color:#66d9ef">=</span> network<span style="color:#f92672">.</span>evaluate<span style="color:#f92672">[</span><span style="color:#66d9ef">Evaluation</span><span style="color:#f92672">](</span>mnistTest<span style="color:#f92672">)</span>
          println<span style="color:#f92672">(</span>
            <span style="color:#e6db74">f&#34;number read: %%d, accuracy: %%1.4f&#34;</span><span style="color:#f92672">.</span>format<span style="color:#f92672">(</span>recs<span style="color:#f92672">.</span>count<span style="color:#f92672">(),</span> eval<span style="color:#f92672">.</span>accuracy<span style="color:#f92672">)</span>
          <span style="color:#f92672">)</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> e<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Throwable</span> <span style="color:#f92672">=&gt;</span>
          println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Program terminated.\n\n&#34;</span><span style="color:#f92672">)</span>
          println<span style="color:#f92672">(</span>e<span style="color:#f92672">.</span>getMessage<span style="color:#f92672">())</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>

  t<span style="color:#f92672">.</span>start
  scala<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span><span style="color:#a6e22e">StdIn</span><span style="color:#f92672">.</span>readLine<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n\nPress ENTER to stop...\n\n&#34;</span><span style="color:#f92672">)</span>
  t<span style="color:#f92672">.</span>interrupt<span style="color:#f92672">()</span>
  t<span style="color:#f92672">.</span>join<span style="color:#f92672">()</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>To retrieve messages from a topic, we need a <code>KafkaConsumer</code> object.  We pass a basic configuration on instantiation which includes the address of our Kafka broker, the deserialisers for our keys and messages (which are of type <code>MnistRecord</code>), and we also ensure we read the topic from the start.  Once the <code>KafkaConsumer</code>, <code>consumer</code>, is created, we subscribe to the <code>mnist</code> topic.  Then, we poll the topic continuously for 1 second at a time, and use all the messages retrieved in that time to update our neural network.  At the end of each loop, we report how many cases were retrieved, and how the model accuracy has changed as a result.  We place the whole loop on a separate thread, mostly so we can wait for users to terminate the program by pressing ENTER.</p>
<p>Note that Deeplearning4j does provide iterators for the MNIST database, but here we&rsquo;ve rolled our own simple version.  In part this is because Deeplearning4j is but one choice we could have made for the machine learning component, but also because it&rsquo;s instructive to see how one goes about creating such iterators using the traits provided–in useful real-world scenarios, our data won&rsquo;t be pre-bundled, and we&rsquo;ll have no choice.</p>
<p>Note also that while our neural network is simple enough, we run our training set through the model frequently, and without a GPU back-end this will be quite slow.  On my machine I have an NVIDIA GeForce GTX 1650 Mobile / Max-Q GPU with 4GB of memory, and an Intel i7-9750H (12) @ 4.500GHz CPU.  The training set of 10,000 images takes around 100 seconds to evaluate using the CPU back-end, but about 1.3 seconds using the GPU.  At the very least one should probably change the settings so more messages are consumed on each iteration if using CPU–or simply don&rsquo;t evaluate the test accuracy at all.</p>
<h2 id="results">Results</h2>
<p>To demonstrate the application, we start the consumer and producer applications each in separate terminals.  In the first case, we send a new record to our topic every 10 milliseconds or so.  Once the topic has records in it, our consumer starts printing out the learning progress.  The rate at which we add new messages dictates our consumer processes about 20 or so new images for each 100 millisecond iteration.</p>
<div class="large">
<a href=assets/kafkatrain01.webp target="_blank"><img src=assets/kafkatrain01.webp></a>
</div>
<p>If we just load all the images into our topic as fast as we can, we find our consumer processes 500 records for every 100 millisecond iteration.  This is because the consumer configuration parameter <code>max.poll.records</code> has a default value of 500, and we have not changed it.</p>
<div class="large">
<a href=assets/kafkatrain02.webp target="_blank"><img src=assets/kafkatrain02.webp></a>
</div>
<h2 id="summary">Summary</h2>
<p>In this post we demonstrated the basic usage of a producers and consumers when working with Kafka, including important considerations such as serialisation and deserialisation of our message types.  The specific use-case for our consumer here, while not a great example of a useful real-world scenario, was to continuously update a classifier in real-time as new messages were received.  There are a number of extensions that one could consider to make this more interesting, of course–we could develop web interfaces for creating new messages and appending them to our topic, we could serialise our classifier for offline use, and so on.  In an upcoming post we&rsquo;ll replicate most of what was done in this post, but using Akka actors rather than Kafka.</p>

            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="../../tags/akka-http">akka-http</a></span>
        
            <span class="tag"><a href="../../tags/docker">docker</a></span>
        
            <span class="tag"><a href="../../tags/geoserver">geoserver</a></span>
        
            <span class="tag"><a href="../../tags/geospark">geospark</a></span>
        
            <span class="tag"><a href="../../tags/geospatial">geospatial</a></span>
        
            <span class="tag"><a href="../../tags/nodejs">nodejs</a></span>
        
            <span class="tag"><a href="../../tags/osrm">osrm</a></span>
        
            <span class="tag"><a href="../../tags/postgis">postgis</a></span>
        
            <span class="tag"><a href="../../tags/postgresql">postgresql</a></span>
        
            <span class="tag"><a href="../../tags/qgis">qgis</a></span>
        
            <span class="tag"><a href="../../tags/r">r</a></span>
        
            <span class="tag"><a href="../../tags/r-packages">r-packages</a></span>
        
            <span class="tag"><a href="../../tags/seasonal-adjustment">seasonal-adjustment</a></span>
        
            <span class="tag"><a href="../../tags/sedona">sedona</a></span>
        
            <span class="tag"><a href="../../tags/shiny">shiny</a></span>
        
            <span class="tag"><a href="../../tags/spark">spark</a></span>
        
            <span class="tag"><a href="../../tags/tiles">tiles</a></span>
        
            <span class="tag"><a href="../../tags/tilestache">tilestache</a></span>
        
            <span class="tag"><a href="../../tags/vuejs">vuejs</a></span>
        
            <span class="tag"><a href="../../tags/wmts">wmts</a></span>
        
            <span class="tag"><a href="../../tags/wsl2">wsl2</a></span>
        
            <span class="tag"><a href="../../tags/x13-arima-seats">x13-arima-seats</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="../../2021/2021-07-16-online-learning-with-apache-kafka/">Online Learning with Apache Kafka</a></h1>
            <time class="has-text-grey-light is-size-7">16 July 2021</time>
        
            <h1><a href="../../2021/2021-04-19-a-brief-look-at-apache-sedona/">A Brief Look at Apache Sedona</a></h1>
            <time class="has-text-grey-light is-size-7">19 April 2021</time>
        
            <h1><a href="../../2020/2020-12-05-working-productively-on-windows-using-wsl2-and-docker/">Working Productively on Windows Using Windows Subsystem for Linux 2 and Docker</a></h1>
            <time class="has-text-grey-light is-size-7">5 December 2020</time>
        
            <h1><a href="../../2020/2020-10-31-using-postgis-as-a-spatial-backend-for-r/">Using PostGIS as a Spatial Backend for R</a></h1>
            <time class="has-text-grey-light is-size-7">31 October 2020</time>
        
            <h1><a href="../../2020/2020-10-31-docker-on-windows-with-wsl2/">Docker on Windows with Windows Subsystem for Linux 2</a></h1>
            <time class="has-text-grey-light is-size-7">31 October 2020</time>
        
    </div>
</div>
    <br>
                


    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="../../archives/2021">2021</a> (2)<br>
        
            <a href="../../archives/2020">2020</a> (4)<br>
        
            <a href="../../archives/2019">2019</a> (1)<br>
        
            <a href="../../archives/2017">2017</a> (1)<br>
        
            <a href="../../archives/2016">2016</a> (4)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://github.com/cmhh" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="mailto://cmhhansen@outlook.com" class="mysocial" rel="me"><i class="fas fa-envelope fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; cmhh 2021 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="//yihui.org/js/math-code.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>




</body>
</html>
