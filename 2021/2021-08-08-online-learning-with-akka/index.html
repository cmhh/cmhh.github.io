<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>cmhh  | Online Learning with Akka</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link href="../../css/highlight/atom-one-dark-reasonable.css" rel='stylesheet' type='text/css' />
    <link rel="stylesheet" href="../../css/blog.css" />
    <link rel="stylesheet" href="../../css/custom.css" />
</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="../../">Home</a>
            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(/img/bg-blog-2.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Online Learning with Akka
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <h1 id="overview">Overview</h1>
<p>In a <a href="../2021-07-30-online-learning-with-apache-kafka">previous post</a>, we looked at how we could consume messages in a Kafka topic, and use those messages for online training of a classifier. In this post, we look at how Akka could be used to solve the same problem, in broadly the same way. Akka is an implementation of the actor model, and is particularly well suited for building event-driven, reactive systems since the <em>actors</em> involved communicate exclusively by sending and reacting to messages.</p>
<h1 id="problem-description">Problem Description</h1>
<p>As before, we download the popular <a href="http://yann.lecun.com/exdb/mnist/">MNIST database of handwritten digits</a>. The database contains hand-written digits represented as 28x28 pixel arrays with integer values in the range \([0,255]\) representing grey-scale colours. The images are split into training and test sets with 60000 and 10000 images, respectively. The following image contains a collage of randomly selected examples:</p>
<img src="assets/random1.png" class="large"/>
<p>I must confess that I am a HUGE Akka fan, and in this case I think it is <em>cooler</em> than Kafka, even if perhaps not as well suited to situations requiring <em>extremely</em> high throughput. All that said, I&rsquo;m not yet that familiar with the newer typed actors, so things here might not be completely idiomatic.</p>
<p>Our solution will consist of three actors which we&rsquo;ll call <em>producer</em>, <em>consumer</em>, and <em>coordinator</em> for lack of anything better. When sent a labelled image, our consumer will use that image to update a classifier, but our consumer will also respond to other message types. Specifically, when asked, the producer will send the current accuracy over the MNIST test set, and it will also send the actual classifier on request. The producer will simply send messages to the consumer whenever we tell it to.</p>
<h1 id="implementation">Implementation</h1>
<p>The complete application can be found on GitHub at <a href="https://github.com/cmhh/akkatrain">cmhh/akkatrain</a>, and the <code>README</code> includes enough information to get up and running. Note that the repository includes the <a href="http://yann.lecun.com/exdb/mnist/">MNIST database</a> since the data is only 12MB all up, and the original source urges users to &lsquo;Please refrain from accessing these files from automated scripts with high frequency. Make copies!&rsquo;. Either way, in this section we discuss the most important bits in more detail.</p>
<h2 id="serialisation--deserialisation">Serialisation / Deserialisation</h2>
<p>Akka is designed to be scalable, and our actor system can be spread across multiple JVM instances, on disparate servers. For actors to communicate with each other outside a single JVM instance, we would need to serialise our messages.  Custom serialisers are easy enough to make–we simply create a class which mixes in <code>akka.serialization.Serializer</code>, and then we add entries in the <code>akka.actor.serializers</code> and <code>akka.actor.serialization-bindings</code> section of our configuration (see <a href="https://doc.akka.io/docs/akka/current/serialization.html">Serialization</a>) to make use of them.  However, in this example we limit ourselves to a single JVM instance, and so we do not need to worry.</p>
<h2 id="model-our-messages">Model Our Messages</h2>
<p>In order to send labelled images, we&rsquo;ll re-use the <code>MnistRecord</code> type from the <a href="../2021-07-30-online-learning-with-apache-kafka">Kafka implementation</a>, so, please excuse the duplication&hellip;</p>
<p>The MNIST database consists of handwritten images of 28x28 pixels, each assigned a label from 0 to 9. The image data is easily read from the provided files as an array of bytes in row-major order, so we define a simple case class as follows (the class has a number of methods, but we omit the details here):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Image</span><span style="color:#f92672">(</span>data<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Array</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Byte</span><span style="color:#f92672">],</span> rows<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> cols<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> byrow<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Boolean</span><span style="color:#f92672">)</span>
</code></pre></div><p>Labelled images can then be modelled simply, also using a case class, as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MnistRecord</span><span style="color:#f92672">(</span>image<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Image</span><span style="color:#f92672">,</span> label<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span>
</code></pre></div><p>The MNIST data has been bundled as a resource in the provided sbt project, and a basic, single-use iterator is provided also. For example, to read the training data:</p>
<div class="REPL">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">scala<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">val</span> testIt <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">MnistIterator</span><span style="color:#f92672">(</span><span style="color:#a6e22e">MnistType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TRAIN</span><span style="color:#f92672">)</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> testIt<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">org.cmhh.MnistIterator</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span>iterator<span style="color:#f92672">&gt;</span>
</code></pre></div></div>
<p>The rest of our messages will be modelled as singleton objects, or very simple case classes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> akka.actor.typed.ActorRef
<span style="color:#66d9ef">import</span> org.deeplearning4j.nn.multilayer.MultiLayerNetwork

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">messages</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">CoordinatorCommand</span> 
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">object</span> <span style="color:#a6e22e">RequestAccuracy</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RequestSendImages</span><span style="color:#f92672">(</span>n<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RequestClassifier</span><span style="color:#f92672">(</span>f<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Stop</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">ProducerCommand</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">ConsumerCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Accuracy</span><span style="color:#f92672">(</span>value<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Double</span><span style="color:#f92672">,</span> n<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Classifier</span><span style="color:#f92672">(</span>value<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MultiLayerNetwork</span><span style="color:#f92672">,</span> f<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span>  <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span>
  
  <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">ProducerCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SendImages</span><span style="color:#f92672">(</span>sendTo<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorRef</span><span style="color:#f92672">[</span><span style="color:#66d9ef">ConsumerCommand</span><span style="color:#f92672">],</span> n<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ProducerCommand</span>

  <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">ConsumerCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Image</span><span style="color:#f92672">(</span>image<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">MnistRecord</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ConsumerCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SendAccuracy</span><span style="color:#f92672">(</span>replyTo<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorRef</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Accuracy</span><span style="color:#f92672">])</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ConsumerCommand</span>
  <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SendClassifier</span><span style="color:#f92672">(</span>replyTo<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorRef</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Classifier</span><span style="color:#f92672">],</span> f<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ConsumerCommand</span> 
<span style="color:#f92672">}</span>
</code></pre></div><p>All our producer does is send \(n\) images to the consumer, and it does this when sent a <code>SendImages</code> object.  In this case, the producer sends messages but does not expect any sort of reply.  The producer will also terminate when sent the <code>Stop</code> object, but also once it has traversed the full MNIST training set once (again, we&rsquo;re simulating online learning here–it would be straightforward to implement other training scenarios, traversing the training set as many times as required, for example, and in a random order).  The full implementation is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> akka.actor.typed.scaladsl.Behaviors
<span style="color:#66d9ef">import</span> akka.actor.typed.scaladsl.LoggerOps
<span style="color:#66d9ef">import</span> akka.actor.typed.Behavior

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Producer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">import</span> messages._

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> images <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">MnistIterator</span><span style="color:#f92672">(</span><span style="color:#a6e22e">MnistType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TRAIN</span><span style="color:#f92672">)</span>

  <span style="color:#66d9ef">def</span> apply<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Behavior</span><span style="color:#f92672">[</span><span style="color:#66d9ef">ProducerCommand</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> 
    <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>receive<span style="color:#f92672">[</span><span style="color:#66d9ef">ProducerCommand</span><span style="color:#f92672">]{</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> message<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> 
      message <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SendImages</span><span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> n<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> 
          <span style="color:#66d9ef">def</span> loop<span style="color:#f92672">(</span>i<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Behavior</span><span style="color:#f92672">[</span><span style="color:#66d9ef">ProducerCommand</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> 
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>images<span style="color:#f92672">.</span>hasNext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
              println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;All images sent.  Shutting down.&#34;</span><span style="color:#f92672">)</span>
              <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>stopped
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">==</span> n<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
              <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>same
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
              r <span style="color:#f92672">!</span> <span style="color:#a6e22e">Image</span><span style="color:#f92672">(</span>images<span style="color:#f92672">.</span>next<span style="color:#f92672">())</span>
              loop<span style="color:#f92672">(</span>i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
            <span style="color:#f92672">}</span>
          loop<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Stop</span> <span style="color:#66d9ef">=&gt;</span> 
          println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Producer is dead!&#34;</span><span style="color:#f92672">)</span>
          <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>stopped
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Our consumer is a little more complicated, but is still relatively simple.  It can receive messages as follows:</p>
<ul>
<li><code>Image</code> - when received, it will update its private classifier</li>
<li><code>SendAccuracy</code> - when received, it will send an <code>Accuracy</code> object to the sender</li>
<li><code>SendClassifier</code> - when received, it will send a <code>Classifier</code> object to the sender</li>
</ul>
<p>The full implementation of the consumer actors is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> akka.actor.typed.scaladsl.Behaviors
<span style="color:#66d9ef">import</span> akka.actor.typed.scaladsl.LoggerOps
<span style="color:#66d9ef">import</span> akka.actor.typed.Behavior
<span style="color:#66d9ef">import</span> org.nd4j.evaluation.classification.Evaluation

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Consumer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">import</span> messages._

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> network <span style="color:#66d9ef">=</span> model<span style="color:#f92672">.</span>cnn<span style="color:#f92672">()</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> mnistTest <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MnistDataSetIterator</span><span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">,</span> <span style="color:#a6e22e">MnistType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">TEST</span><span style="color:#f92672">)</span>

  <span style="color:#66d9ef">def</span> apply<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Behavior</span><span style="color:#f92672">[</span><span style="color:#66d9ef">ConsumerCommand</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> run<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>

  <span style="color:#66d9ef">def</span> run<span style="color:#f92672">(</span>n<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Behavior</span><span style="color:#f92672">[</span><span style="color:#66d9ef">ConsumerCommand</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> 
    <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>receive<span style="color:#f92672">{</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> message<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> message <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Image</span><span style="color:#f92672">(</span>rec<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
        <span style="color:#66d9ef">val</span> im <span style="color:#66d9ef">=</span> rec<span style="color:#f92672">.</span>toNd4j
        network<span style="color:#f92672">.</span>fit<span style="color:#f92672">(</span>im<span style="color:#f92672">.</span>_1<span style="color:#f92672">,</span> im<span style="color:#f92672">.</span>_2<span style="color:#f92672">)</span>
        run<span style="color:#f92672">(</span>n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SendAccuracy</span><span style="color:#f92672">(</span>replyTo<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
        replyTo <span style="color:#f92672">!</span> <span style="color:#a6e22e">Accuracy</span><span style="color:#f92672">(</span>accuracy<span style="color:#f92672">,</span> n<span style="color:#f92672">)</span>
        <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>same
      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">SendClassifier</span><span style="color:#f92672">(</span>replyTo<span style="color:#f92672">,</span> f<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
        replyTo <span style="color:#f92672">!</span> <span style="color:#a6e22e">Classifier</span><span style="color:#f92672">(</span>network<span style="color:#f92672">.</span>clone<span style="color:#f92672">,</span> f<span style="color:#f92672">)</span>
        <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>same
      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Stop</span> <span style="color:#66d9ef">=&gt;</span> 
        <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>stopped <span style="color:#f92672">{()</span> <span style="color:#66d9ef">=&gt;</span> 
          println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Consumer is dead!&#34;</span><span style="color:#f92672">)</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">def</span> accuracy<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Double</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">val</span> eval <span style="color:#66d9ef">=</span> network<span style="color:#f92672">.</span>evaluate<span style="color:#f92672">[</span><span style="color:#66d9ef">Evaluation</span><span style="color:#f92672">](</span>mnistTest<span style="color:#f92672">)</span>
    eval<span style="color:#f92672">.</span>accuracy
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Note that actors can be created with an object-oriented or functional style, and we&rsquo;ve opted for the functional approach here.  So in the case of the consumer, we&rsquo;ve tracked the number of total training images received, mostly to demonstrate how one might go about maintaining state–we <em>could</em> use mutable variables, but instead we define our <code>Behavior</code> recursively.</p>
<p>Rather than send messages directly to either of our producer or consumer actors, we communicate exclusively with a coordinator actor.  We send the coordinator any of the following:</p>
<ul>
<li><code>RequestSendAccuracy</code> - coordinator will tell the producer to send <code>Image</code>s to the consumer</li>
<li><code>RequestAccuracy</code> - coordinator will tell the consumer to send an <code>Accuracy</code> object</li>
<li><code>RequestClassifier</code> - coordinator will tell the consumer to send a <code>Classifier</code> object</li>
<li><code>Stop</code> - tell both the consumer and producer to <code>Stop</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">
<span style="color:#66d9ef">import</span> akka.actor.typed.scaladsl.Behaviors
<span style="color:#66d9ef">import</span> akka.actor.typed.scaladsl.LoggerOps
<span style="color:#66d9ef">import</span> akka.actor.typed.Behavior
<span style="color:#66d9ef">import</span> java.io.File

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Coordinator</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">import</span> messages._

  <span style="color:#66d9ef">def</span> apply<span style="color:#f92672">()</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Behavior</span><span style="color:#f92672">[</span><span style="color:#66d9ef">CoordinatorCommand</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>setup <span style="color:#f92672">{</span> context <span style="color:#66d9ef">=&gt;</span> 
    <span style="color:#66d9ef">val</span> consumer <span style="color:#66d9ef">=</span> context<span style="color:#f92672">.</span>spawn<span style="color:#f92672">(</span><span style="color:#a6e22e">Consumer</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;consumer&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">val</span> producer <span style="color:#66d9ef">=</span> context<span style="color:#f92672">.</span>spawn<span style="color:#f92672">(</span><span style="color:#a6e22e">Producer</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;producer&#34;</span><span style="color:#f92672">)</span>

    <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>receiveMessage <span style="color:#f92672">{</span> message <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">{</span>
      message <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">RequestSendImages</span><span style="color:#f92672">(</span>n<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
          producer <span style="color:#f92672">!</span> <span style="color:#a6e22e">SendImages</span><span style="color:#f92672">(</span>consumer<span style="color:#f92672">,</span> n<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">RequestAccuracy</span> <span style="color:#66d9ef">=&gt;</span> 
          consumer <span style="color:#f92672">!</span> <span style="color:#a6e22e">SendAccuracy</span><span style="color:#f92672">(</span>context<span style="color:#f92672">.</span>self<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">RequestClassifier</span><span style="color:#f92672">(</span>f<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
          consumer <span style="color:#f92672">!</span> <span style="color:#a6e22e">SendClassifier</span><span style="color:#f92672">(</span>context<span style="color:#f92672">.</span>self<span style="color:#f92672">,</span> f<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Accuracy</span><span style="color:#f92672">(</span>accuracy<span style="color:#f92672">,</span> n<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> 
          println<span style="color:#f92672">(</span><span style="color:#e6db74">f&#34;accuracy: %%1.4f, training images seen: %%05d&#34;</span><span style="color:#f92672">.</span>format<span style="color:#f92672">(</span>accuracy<span style="color:#f92672">,</span> n<span style="color:#f92672">))</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Classifier</span><span style="color:#f92672">(</span>n<span style="color:#f92672">,</span> f<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
          n<span style="color:#f92672">.</span>save<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">File</span><span style="color:#f92672">(</span>f<span style="color:#f92672">))</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Stop</span> <span style="color:#66d9ef">=&gt;</span>
          consumer <span style="color:#f92672">!</span> <span style="color:#a6e22e">Stop</span>
          producer <span style="color:#f92672">!</span> <span style="color:#a6e22e">Stop</span>
      <span style="color:#f92672">}</span>
      <span style="color:#a6e22e">Behaviors</span><span style="color:#f92672">.</span>same
    <span style="color:#f92672">}}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h1 id="using-the-actors">Using the Actors</h1>
<p>We always need an actor system to provide the overall context, and while it might not be best practice, we can make our system from a <code>Coordinator</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> akka.actor.typed.ActorSystem
<span style="color:#66d9ef">val</span> system <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">ActorSystem</span><span style="color:#f92672">(</span><span style="color:#a6e22e">Coordinator</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;akkatrain&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>Then, to check the current classifier accuracy:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">system <span style="color:#f92672">!</span> <span style="color:#a6e22e">RequestAccuracy</span>
</code></pre></div><p>To have 1000 images sent to the consumer actor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">system <span style="color:#f92672">!</span> <span style="color:#a6e22e">RequestSendImages</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1000</span><span style="color:#f92672">)</span>
</code></pre></div><p>To fetch the classifier and save it to a file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">system <span style="color:#f92672">!</span> <span style="color:#a6e22e">RequestClassifier</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;mnist.model&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>And to shut everything down:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">system <span style="color:#f92672">!</span> <span style="color:#a6e22e">Stop</span>
system<span style="color:#f92672">.</span>terminate<span style="color:#f92672">()</span>
</code></pre></div><p>The project contains a simple entry point which will create an actor system as above, and then send the full MNIST training set in batches of 500 images, reporting accuracy after each request.  It is illustrative only, and uses <code>Thread.sleep()</code> to make things work <em>just so</em> (i.e., on a different machine with faster or slower performance, lack of GPU, etc., things will not work out so neatly!).  The demo can be run as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">java -cp target/scala-2.13/akkatrain.jar org.cmhh.Main
</code></pre></div><div class="large">
<a href=assets/akkatrain01.webp target="_blank"><img src=assets/akkatrain01.webp></a>
</div>
<h2 id="summary">Summary</h2>
<p>In this post we demonstrated the basic usage of Kafka&rsquo;s typed actors.  The specific use-case for our actor system was to react to new messages in real-time, using them to update a classifier.  There are a number of extensions that we could consider to make this more interesting, of course&ndash;we could develop web interfaces for interacting with out actors, and we could look other parts of the Akka ecosystem such as Akka streams (though the goal here was specifically to use the actor model).</p>

            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="../../tags/akka-http">akka-http</a></span>
        
            <span class="tag"><a href="../../tags/docker">docker</a></span>
        
            <span class="tag"><a href="../../tags/geoserver">geoserver</a></span>
        
            <span class="tag"><a href="../../tags/geospark">geospark</a></span>
        
            <span class="tag"><a href="../../tags/geospatial">geospatial</a></span>
        
            <span class="tag"><a href="../../tags/nodejs">nodejs</a></span>
        
            <span class="tag"><a href="../../tags/osrm">osrm</a></span>
        
            <span class="tag"><a href="../../tags/postgis">postgis</a></span>
        
            <span class="tag"><a href="../../tags/postgresql">postgresql</a></span>
        
            <span class="tag"><a href="../../tags/qgis">qgis</a></span>
        
            <span class="tag"><a href="../../tags/r">r</a></span>
        
            <span class="tag"><a href="../../tags/r-packages">r-packages</a></span>
        
            <span class="tag"><a href="../../tags/seasonal-adjustment">seasonal-adjustment</a></span>
        
            <span class="tag"><a href="../../tags/sedona">sedona</a></span>
        
            <span class="tag"><a href="../../tags/shiny">shiny</a></span>
        
            <span class="tag"><a href="../../tags/spark">spark</a></span>
        
            <span class="tag"><a href="../../tags/tiles">tiles</a></span>
        
            <span class="tag"><a href="../../tags/tilestache">tilestache</a></span>
        
            <span class="tag"><a href="../../tags/vuejs">vuejs</a></span>
        
            <span class="tag"><a href="../../tags/wmts">wmts</a></span>
        
            <span class="tag"><a href="../../tags/wsl2">wsl2</a></span>
        
            <span class="tag"><a href="../../tags/x13-arima-seats">x13-arima-seats</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="../../2021/2021-08-14-data-services-from-postgres/">Data Services from Existing PostgreSQL Databases</a></h1>
            <time class="has-text-grey-light is-size-7">14 August 2021</time>
        
            <h1><a href="../../2021/2021-08-08-online-learning-with-akka/">Online Learning with Akka</a></h1>
            <time class="has-text-grey-light is-size-7">8 August 2021</time>
        
            <h1><a href="../../2021/2021-07-30-online-learning-with-apache-kafka/">Online Learning with Apache Kafka</a></h1>
            <time class="has-text-grey-light is-size-7">30 July 2021</time>
        
            <h1><a href="../../2021/2021-04-19-a-brief-look-at-apache-sedona/">A Brief Look at Apache Sedona</a></h1>
            <time class="has-text-grey-light is-size-7">19 April 2021</time>
        
            <h1><a href="../../2020/2020-12-05-working-productively-on-windows-using-wsl2-and-docker/">Working Productively on Windows Using Windows Subsystem for Linux 2 and Docker</a></h1>
            <time class="has-text-grey-light is-size-7">5 December 2020</time>
        
    </div>
</div>
    <br>
                


    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="../../archives/2021">2021</a> (4)<br>
        
            <a href="../../archives/2020">2020</a> (4)<br>
        
            <a href="../../archives/2019">2019</a> (1)<br>
        
            <a href="../../archives/2017">2017</a> (1)<br>
        
            <a href="../../archives/2016">2016</a> (4)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://github.com/cmhh" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="mailto://cmhhansen@outlook.com" class="mysocial" rel="me"><i class="fas fa-envelope fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; cmhh 2021 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="//yihui.org/js/math-code.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>




</body>
</html>
