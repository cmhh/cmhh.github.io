<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>cmhh  | Agent Based Simulations with Akka</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link href="../../css/highlight/atom-one-dark-reasonable.css" rel='stylesheet' type='text/css' />
    <link rel="stylesheet" href="../../css/blog.css" />
    <link rel="stylesheet" href="../../css/custom.css" />
</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="../../">Home</a>
            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(/img/bg-blog-2.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Agent Based Simulations with Akka
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <h1 id="overview">Overview</h1>
<p>In this post we describe a relatively simple agent-based simulation. The
simulation itself is a rough approximation of a household survey, consisting of
a large collection of dwellings, in turn surveyed in a strictly face-to-face
setting by one of a number of independent field collectors.</p>
<p>We describe the simulation in terms of the <em>actor model</em>, though we do so in a
way that is largely agnostic with respect to programming language or actor
framework. Still, a concrete implementation is useful for illustration, and <a href="https://github.com/cmhh/collectionsim">one
is provided here</a>. This is implemented
using <a href="https://akka.io/">Akka</a>, an implementation of the <a href="https://en.wikipedia.org/wiki/Actor_model">actor
model</a> on the JVM, and so some jargon
specific to Akka will appear here and there. Nevertheless, it should be easy
enough to implement something similar in other frameworks</p>
<h1 id="the-actor-model">The Actor Model</h1>
<p>From <a href="https://en.wikipedia.org/wiki/Actor_model">Wikipedia</a>:</p>
<blockquote>
<p>The actor model in computer science is a mathematical model of concurrent
computation that treats <em>actor</em> as the universal primitive of concurrent
computation. In response to a message it receives, an actor can: make local
decisions, create more actors, send more messages, and determine how to
respond to the next message received. Actors may modify their own private
state, but can only affect each other indirectly through messaging (removing
the need for lock-based synchronization).</p>
</blockquote>
<p>Akka provides an implementation of the actor model on the JVM which adheres to
this definition quite faithfully. We create a set of actors, collectively
referred to as an <em>actor system</em>, and actors can only communicate with each
other by sending messages. That is, no actor can change or access the internal
state of another actor directly. If one actor wishes to know something about
another actor, it can request information by sending a message, and the
receiving actor can respond with a message in kind. Importantly, messages are
just that, and they do not provide direct access to internal state of an actor
directly. This means that actors can operate concurrently, but with complete
safety&ndash;since actors have exclusive access to their state, we do not need to
concern ourselves with thread safety or any of the common mitigation strategies,
such as synchronized blocks, locks, semaphores, and so on.</p>
<p>As implemented by Akka, actors are free to communicate with any other actor in
the system, and functionality does exist that facilitates the discovery of an
actor by other actors. However, actors are commonly organised in a hierarchical
fashion, typically only communicating with their direct subordinates. In fact,
actors can <em>spawn</em> other actors, and this is typically what is meant by
subordinate. That is, if actor A spawns actor B, then B is A&rsquo;s subordinate.
Again, this is not a requirement, but it is a useful pattern in practice
nevertheless. Taking this hierarchical pattern to the fullest extent, it is
common to have a single actor functioning as a broker, or coordinator, between
the outside world and the actor system itself.</p>
<h1 id="simulation-overview">Simulation Overview</h1>
<p>At a very high level, our actor system looks as follows:</p>
<a href="assets/collectionsim.dot.png" target="_blank">
<img src="assets/collectionsim.dot.png" class="Large"/> </a>
<p>The arrows in the diagram represent responsibility. For example, the inner-most
(red) circle is the central coordinator, and is responsible for spawning the
area coordinators (green circles), and for passing messages to them. The area
coordinators are responsible for spawning field collectors (blue circles),
assigning work to them, and forwarding messages to them. Field collectors
receive work from area coordinators in the form of addresses, which collectors
use in turn to spawn dwellings. Finally, dwellings will each spawn a random set
of individuals which will serve as its residents. Field collectors send
interview requests to dwellings, and dwellings reply with &lsquo;refusal&rsquo;, &lsquo;empty&rsquo;,
&lsquo;non-contact&rsquo;, or &lsquo;response&rsquo;. If a dwelling is non-empty, and decides to
&lsquo;respond&rsquo;, it sends the parent field collector references to the individuals
which the collector then also attempts to contact. We describe the system in
more detail in the following sections.</p>
<p>One actor is not shown in the diagram, and that is a single instance of
<code>EventRecorder</code>. It is the job of this actor to persist (in a SQLite database)
event information we wish to keep after our simulation is finished, and a number
of the actors in the system will send information directly to it. It&rsquo;s a bit
clunky (a real-time system might use something like Kafka topics instead, or
even Akka&rsquo;s own streaming functionality, for example), but functional enough for
this simple example.</p>
<h1 id="actors">Actors</h1>
<p>We will first describe the various actors at a high level, and then move on to a
description of the message protocol and the various sub-processes.</p>
<h2 id="coordinator"><code>Coordinator</code></h2>
<p>There is a single coordinator, an instance of <code>Coordinator</code>, which is our
entry-point for the actor system itself. On start-up, the coordinator spawns 6
area coordinators, and its sole responsibility after set-up is to listen for
messages from outside the system, and pass them to the appropriate area
coordinator. The internal state of the coordinator is just a list of the area
coordinators spawned.</p>
<h2 id="areacoordinator"><code>AreaCoordinator</code></h2>
<p>The simulation as configured contains 6 area coordinators, which are instances
of <code>AreaCoordinator</code>, and which divide New Zealand up as follows:</p>
<a href="assets/collection_areas.png" target="_blank">
<img src="assets/collection_areas.png" class="med"/> </a>
<p>Area coordinators are responsible for spawning field collectors and for deciding
which field collectors will spawn particular dwellings. The internal state of an
area coordinator is a list of the the collectors spawned, and a map storing the
assignment of dwellings to collectors.</p>
<h2 id="fieldcollectoractor"><code>FieldCollectorActor</code></h2>
<p>Field collectors are instances of <code>FieldCollectorActor</code>, and are spawned by area
coordinators. They are assigned a certain number of dwellings, after which it is
their responsibility to set about getting responses from those cases. They will
typically be sent a message instructing them to simulate a day&rsquo;s work, assuming
a particular starting day and time. This will involve placing all unfinished
cases in some efficient driving order, and then visiting each in turn. A field
collector will send a dwelling an interview request, and react accordingly. In
all cases, time will be advanced by a random amount appropriate for the type of
response, and interviewers will stop working once some maximum amount of work
has been exceeded.</p>
<p>The internal state of a field collector contains information about itself (id,
address, location, name) as well as a configuration object that contains:</p>
<ul>
<li>cases it has been assigned</li>
<li>overall summaries of each case (complete, incomplete, etc.)</li>
<li>work items for the current day</li>
<li>the dwelling being surveyed</li>
<li>the current individual being surveyed</li>
<li>the simulated date and time of day</li>
<li>the total kilometres travelled in the current day</li>
<li>the total minutes spent working in the current day</li>
</ul>
<h2 id="dwellingactor"><code>DwellingActor</code></h2>
<p>Dwellings are instances of <code>DwellingActor</code>, and are spawned by the field
collector responsible. Once they are spawned, they will in turn spawn a random
set of individuals to function as the dwelling&rsquo;s residents. A dwelling can
respond to interview requests from the field collector which spawned them,
avoiding contact, refusing, or providing a full response. After a full response,
the dwelling actor will pass the references for any individuals it spawned to
the field collector.</p>
<p>The internal state of a dwelling actor contains information about itself (id,
address, location), along with a list of all individuals spawned. A dwelling is
also aware of whether or not it has responded (that is, sent a complete
questionnaire response to its parent collector).</p>
<h2 id="individualactor"><code>IndividualActor</code></h2>
<p>Individuals function as dwelling residents, and are instances of
<code>IndividualActor</code>. All they can do is respond to requests for an interview from
field collectors, avoiding contact, refusing, or providing a full response.
Individuals are only discovered by field collectors after getting a response
from the dwelling that spawned them.</p>
<p>The internal state of an individual contains information about itself (name,
age, sex, date of birth), and a reference to its parent dwelling. Like
dwellings, individuals are also aware of whether or not they have responded
(i.e., provided a questionnaire response to a field collector).</p>
<h2 id="eventrecorder"><code>EventRecorder</code></h2>
<p>The system has a single instance of <code>EventRecorder</code>, and this actor is
responsible for persisting information. This might not reflect idiomatic, or
best practice; but it works well enough in this case. For example, when a field
collector gets a response from an individual, the individual will send a message
to the field collector indicating the type of response, but also a JSON string
representing a questionnaire response if fully responding. The response itself
is then sent, along with identifiers for the dwelling and individual, to the
event recorder to persist. Currently, the event recorder stores the following:</p>
<div class=narrowtab>
<table>
<thead>
<tr>
<th>table</th>
<th>from</th>
<th>purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>collectors</code></td>
<td><code>AreaCoordinator</code></td>
<td>A list of all spawned collectors.</td>
</tr>
<tr>
<td><code>dwellings</code></td>
<td><code>FieldCollectorActor</code></td>
<td>A list of all spawned dwellings.</td>
</tr>
<tr>
<td><code>dwelling_assignment</code></td>
<td><code>FieldCollector</code></td>
<td>Collector and dwelling pairs reflecting work allocation.</td>
</tr>
<tr>
<td><code>dwelling_response</code></td>
<td><code>FieldCollector</code></td>
<td>Completed dwelling questionnaires.</td>
</tr>
<tr>
<td><code>individual_response</code></td>
<td><code>FieldCollector</code></td>
<td>Completed individual questionnaires.</td>
</tr>
<tr>
<td><code>interview</code></td>
<td><code>FieldCollector</code></td>
<td>All attempted contacts and their outcome.</td>
</tr>
<tr>
<td><code>trips</code></td>
<td><code>FieldCollector</code></td>
<td>All car trips made by field collectors.</td>
</tr>
</tbody>
</table>
</div>
<h1 id="detailed-process--message-protocol">Detailed Process / Message Protocol</h1>
<p>Here we provide additional detail about the overall simulation. The simulation
itself is driven largely by the messages that can be understood by the various
actors, so the simulation is well described by the message protocol. However,
rather than describe the simulation in terms of all possible messages, we
instead describe the following broad sub-processes:</p>
<ul>
<li>spawn area coordinators</li>
<li>spawn field collectors</li>
<li>spawn dwellings and individuals</li>
<li>repeatedly simulate a day of work</li>
</ul>
<h2 id="spawn-event-recorder-and-area-coordinators">Spawn Event Recorder and Area Coordinators</h2>
<p>The actor system starts with a single coordinator, which is created as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> system <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">ActorSystem</span><span style="color:#f92672">(</span><span style="color:#a6e22e">Coordinator</span><span style="color:#f92672">(</span>conf<span style="color:#f92672">.</span>dbpath<span style="color:#f92672">()),</span> <span style="color:#e6db74">&#34;collectionsim&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><p>This coordinator spawns a single event recorder and 6 area coordinators when
created. The code looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">val</span> eventRecorder<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">ActorRef</span><span style="color:#f92672">[</span><span style="color:#66d9ef">EventRecorderCommand</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
  context<span style="color:#f92672">.</span>spawn<span style="color:#f92672">(</span><span style="color:#a6e22e">EventRecorder</span><span style="color:#f92672">(</span>dbpath<span style="color:#f92672">,</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;eventrecorder&#34;</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">val</span> areaCoordinators<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Area</span>, <span style="color:#66d9ef">ActorRef</span><span style="color:#f92672">[</span><span style="color:#66d9ef">AreaCoordinatorCommand</span><span style="color:#f92672">]]</span> <span style="color:#66d9ef">=</span> 
  area<span style="color:#f92672">.</span>areas<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>x <span style="color:#66d9ef">=&gt;</span> 
    <span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> context<span style="color:#f92672">.</span>spawn<span style="color:#f92672">(</span><span style="color:#a6e22e">AreaCoordinator</span><span style="color:#f92672">(</span>eventRecorder<span style="color:#f92672">),</span> <span style="color:#e6db74">s&#34;areacoordinator@</span><span style="color:#e6db74">${</span>x<span style="color:#f92672">.</span>toString<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">))</span>
  <span style="color:#f92672">).</span>toMap
</code></pre></div><p>Note that <code>dbpath</code> is the name of the SQLite database which will be created, and
100 is the batch size for writing to the database. That is, a buffer is
maintained that contains up to 100 SQL queries&ndash;when the buffer is full, the
queries are committed to the database.</p>
<h2 id="spawn-field-collectors">Spawn Field Collectors</h2>
<p>Field collector actors are ultimately spawned by passing a message to the
coordinator, which is defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FieldCollector</span><span style="color:#f92672">(</span>
  id<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> address<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> location<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Coordinates</span><span style="color:#f92672">,</span> area<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span>
<span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">AreaCoordinatorCommand</span>
</code></pre></div><p>This message is passed to the coordinator, the coordinator then forwards it to
the correct area coordinator, and the area coordinator then spawns a new
collector. The area coordinator also sends a message to the event recorder to be
persisted. Visually:</p>
<a href="assets/fieldcollector.png" target="_blank">
<img src="assets/fieldcollector.png" class="medlarge"/> </a>
<p> </p>
<p>(Note I got a Wacom tablet recently, which is awesome, but I&rsquo;m new to any sort
of digital drawing process, and the hand-eye coordination is taking some time.
So, this is the best I can do for now! Sorry.)</p>
<p>Collectors can be provided by a CSV (or gzipped CSV) file, and an iterator can
be used to read such files row-by-row, converting each row to an instance of
<code>FieldCollector</code>, before being passed to the coordinator. For example, the
<a href="https://github.com/cmhh/collectionsim">simulation source</a> includes a file,
<a href="https://github.com/cmhh/collectionsim/raw/main/data/interviewers.csv.gz">interviewers.csv.gz</a>,
consisting of 100 locations, and the first few rows look as follows:</p>
<div class=narrowtab>
<table>
<thead>
<tr>
<th style="text-align:center">address_id</th>
<th style="text-align:left">full_address</th>
<th style="text-align:center">region</th>
<th style="text-align:right">lng</th>
<th style="text-align:right">lat</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">236594</td>
<td style="text-align:left">258 Hereford Street, Christchurch Central, Christchurch</td>
<td style="text-align:center">13</td>
<td style="text-align:right">172.6452</td>
<td style="text-align:right">-43.53221</td>
</tr>
<tr>
<td style="text-align:center">1535707</td>
<td style="text-align:left">26 Harris Road, Pokuru</td>
<td style="text-align:center">3</td>
<td style="text-align:right">175.2201</td>
<td style="text-align:right">-38.02346</td>
</tr>
<tr>
<td style="text-align:center">617660</td>
<td style="text-align:left">125 Westminster Avenue, Tamatea, Napier</td>
<td style="text-align:center">6</td>
<td style="text-align:right">176.8741</td>
<td style="text-align:right">-39.50367</td>
</tr>
<tr>
<td style="text-align:center">582666</td>
<td style="text-align:left">49 Cambridge Terrace, Kaiti, Gisborne</td>
<td style="text-align:center">5</td>
<td style="text-align:right">178.0384</td>
<td style="text-align:right">-38.67728</td>
</tr>
<tr>
<td style="text-align:center">2096666</td>
<td style="text-align:left">206/155 Beach Road, Auckland Central, Auckland</td>
<td style="text-align:center">2</td>
<td style="text-align:right">174.7741</td>
<td style="text-align:right">-36.84973</td>
</tr>
<tr>
<td style="text-align:center">992032</td>
<td style="text-align:left">14 Glen Close, Glen Eden, Auckland</td>
<td style="text-align:center">2</td>
<td style="text-align:right">174.6365</td>
<td style="text-align:right">-36.91012</td>
</tr>
</tbody>
</table>
</div>
<p> </p>
<p>We can spawn a new collector for each row by running something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">val</span> csvConfig <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">CsvConfig</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;address_id&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;full_address&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lng&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lat&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;region&#34;</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">val</span> cit <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">FieldCollectorIterator</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;interviewers.csv.gz&#34;</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>cit<span style="color:#f92672">.</span>hasNext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  system <span style="color:#f92672">!</span> cit<span style="color:#f92672">.</span>next<span style="color:#f92672">()</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>For interest, the interviewer locations look as follows:</p>
<a href="assets/interviewers.png" target="_blank">
<img src="assets/interviewers.png" class="med"/> </a>
<h2 id="spawn-dwellings">Spawn Dwellings</h2>
<p>The process of spawning a dwelling actors is triggered by sending a message to
the coordinator, defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dwelling</span><span style="color:#f92672">(</span>
  id<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> address<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> location<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Coordinates</span><span style="color:#f92672">,</span> area<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span>
<span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">AreaCoordinatorCommand</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">FieldCollectorCommand</span>
</code></pre></div><p>This message is passed to the coordinator, the coordinator then forwards it to
the correct area coordinator, and the area coordinator then decides which of its
collectors to forward the message to. Additionally, when a dwelling is spawned,
the field collector sends a message to the event recorder to be persisted.
Visually:</p>
<a href="assets/dwelling.png" target="_blank">
<img src="assets/dwelling.png" class="Large"/> </a>
<p>The rule for deciding which specific field collector will be sent a particular
dwelling is currently very simple, and works as follows:</p>
<ul>
<li>filter the list of collectors to the set with less than <code>$n$</code> cases already
assigned</li>
<li>assign the dwelling to the closest (according to a routing service)
remaining collector.</li>
</ul>
<p>Like collectors, dwellings can be provided by a CSV (or gzipped CSV) file, and
an iterator can be used to read such files row-by-row, converting each row to an
instance of <code>Dwelling</code>, and passing it to the coordinator. For example, say we
had a file called <code>dwellings.csv.gz</code>, and the first few rows looked as follows:</p>
<div class=narrowtab>
<table>
<thead>
<tr>
<th style="text-align:center">address_id</th>
<th style="text-align:left">full_address</th>
<th style="text-align:center">region</th>
<th style="text-align:right">lng</th>
<th style="text-align:right">lat</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2186256</td>
<td style="text-align:left">75B Insoll Avenue, Enderley, Hamilton</td>
<td style="text-align:center">03</td>
<td style="text-align:right">175.2944</td>
<td style="text-align:right">-37.76214</td>
</tr>
<tr>
<td style="text-align:center">814042</td>
<td style="text-align:left">7 Bertram Street, Hillcrest, Rotorua</td>
<td style="text-align:center">04</td>
<td style="text-align:right">176.2322</td>
<td style="text-align:right">-38.14669</td>
</tr>
<tr>
<td style="text-align:center">695912</td>
<td style="text-align:left">114 Naylor Street, Hamilton East, Hamilton</td>
<td style="text-align:center">03</td>
<td style="text-align:right">175.3075</td>
<td style="text-align:right">-37.79751</td>
</tr>
<tr>
<td style="text-align:center">1283168</td>
<td style="text-align:left">46 Mako Street, Oneroa, Waiheke Island</td>
<td style="text-align:center">02</td>
<td style="text-align:right">175.0076</td>
<td style="text-align:right">-36.78458</td>
</tr>
<tr>
<td style="text-align:center">336865</td>
<td style="text-align:left">85 Wither Road, Witherlea, Blenheim</td>
<td style="text-align:center">18</td>
<td style="text-align:right">173.9541</td>
<td style="text-align:right">-41.53808</td>
</tr>
<tr>
<td style="text-align:center">336339</td>
<td style="text-align:left">1/11 Milford Street, Witherlea, Blenheim</td>
<td style="text-align:center">18</td>
<td style="text-align:right">173.9540</td>
<td style="text-align:right">-41.53505</td>
</tr>
</tbody>
</table>
</div>
<p> </p>
<p>Then we could spawn a new collector for each row by running something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">val</span> csvConfig <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">CsvConfig</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;address_id&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;full_address&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lng&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lat&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;region&#34;</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">val</span> dit <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">DwellingIterator</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;dwellings.csv.gz&#34;</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>dit<span style="color:#f92672">.</span>hasNext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  system <span style="color:#f92672">!</span> dit<span style="color:#f92672">.</span>next<span style="color:#f92672">()</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>A number of sample files are provided along with the <a href="https://github.com/cmhh/collectionsim">simulation
source</a>. For example
<a href="https://github.com/cmhh/collectionsim/raw/main/data/sample1_01.csv.gz">sample1_01.csv.gz</a>
and
<a href="https://github.com/cmhh/collectionsim/raw/main/data/sample1_02.csv.gz">sample1_02.csv.gz</a>
both consist of roughly 1600 locations each, but one is the result of a
two-stage selection and one is a simple random sample, the result being the
latter is more spatially dispersed. Spatially, the two samples look as follows:</p>
<a href="assets/dwellings.png" target="_blank">
<img src="assets/dwellings.png" class="Large"/> </a>
<p>Note that these two samples give us the opportunity to look a little at the
plausibility of our simulation outcomes. All else constant, we&rsquo;d expect
collectors to have to travel more to service the non-clustered sample, and
probably require more days to finish their workload overall as a result.</p>
<h2 id="spawn-individuals">Spawn Individuals</h2>
<p>Immediately after being spawned, a dwelling actor will then spawn a random
collection of individual actors, or else remain empty / vacant. The process
proceeds as follows&hellip;</p>
<p>Firstly, with some probability (default of 0.1), we decide the dwelling is
empty, and do nothing.</p>
<p>For non-empty dwellings, the first step is to assign a <em>household type</em>. This is
done randomly from the following discrete distribution (the default
probabilities are drawn for the <a href="https://www.stats.govt.nz/methods/families-and-households-in-the-2018-census-data-sources-family-coding-and-data-quality">2018
Census</a>):</p>
<div class=narrowtab>
<table>
<thead>
<tr>
<th>household type</th>
<th style="text-align:right">probability</th>
</tr>
</thead>
<tbody>
<tr>
<td>one-person household</td>
<td style="text-align:right">0.2274</td>
</tr>
<tr>
<td>one-family household</td>
<td style="text-align:right">0.6862</td>
</tr>
<tr>
<td>two-family household</td>
<td style="text-align:right">0.0352</td>
</tr>
<tr>
<td>other multi-person household</td>
<td style="text-align:right">0.0512</td>
</tr>
</tbody>
</table>
</div>
<p> </p>
<p>In the case of a one-person household, a single individual is randomly
generated. This process involves generating a random name, sex, and a random
birth-date which makes the person at least 18 years of age (using the current
system time&amp;endash;this could, of course, be modified). In the case of a
multi-person household, we simply generate a random number of individuals in the
same way.</p>
<p>In the case of a one-family household, we randomly generate a &lsquo;family&rsquo;, and for
a two-family household, we randomly generate two. To generate a family, we first
generate a random family type according to the following distribution:</p>
<div class=narrowtab>
<table>
<thead>
<tr>
<th>family type</th>
<th style="text-align:right">probability</th>
</tr>
</thead>
<tbody>
<tr>
<td>couple only</td>
<td style="text-align:right">0.3725</td>
</tr>
<tr>
<td>couple only and others</td>
<td style="text-align:right">0.0376</td>
</tr>
<tr>
<td>couple with children</td>
<td style="text-align:right">0.3985</td>
</tr>
<tr>
<td>couple with children and others</td>
<td style="text-align:right">0.0373</td>
</tr>
<tr>
<td>one parent with children</td>
<td style="text-align:right">0.1247</td>
</tr>
<tr>
<td>one parent with children and others</td>
<td style="text-align:right">0.0293</td>
</tr>
</tbody>
</table>
</div>
<p> </p>
<p>Children are simply random individuals with a random birth-date which makes them
less than 15-years of age, and who have a specified family name. The process for
generating couples is <em>very</em> naive, being more illustrative than definitive&ndash;we
simply generate a male and female with a common surname, and who are within
<code>$\pm$</code> 5 years of age of each other.</p>
<h2 id="simulating-a-days-work">Simulating a Day&rsquo;s Work</h2>
<p>We kick off a simulated day of work by passing the coordinator a message defined
as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RunDay</span><span style="color:#f92672">(</span>datetime<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">LocalDateTime</span><span style="color:#f92672">)</span> 
<span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">CoordinatorCommand</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">AreaCoordinatorCommand</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">FieldCollectorCommand</span>
</code></pre></div><p>This message is then forwarded to each area coordinator, and each area
coordinator then forwards it to each of their collectors. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala">system <span style="color:#f92672">!</span> <span style="color:#a6e22e">RunDay</span><span style="color:#f92672">(</span><span style="color:#a6e22e">LocalDateTime</span><span style="color:#f92672">.</span>of<span style="color:#f92672">(</span><span style="color:#ae81ff">2022</span><span style="color:#f92672">,</span><span style="color:#ae81ff">01</span><span style="color:#f92672">,</span><span style="color:#ae81ff">10</span><span style="color:#f92672">,</span><span style="color:#ae81ff">9</span><span style="color:#f92672">,</span><span style="color:#ae81ff">0</span><span style="color:#f92672">))</span>
</code></pre></div><p> </p>
<a href="assets/runday.png" target="_blank">
<img src="assets/runday.png" class="Large"/> </a>
<p>Each field collector will then proceed to work through their assigned dwelling
cases, assuming a start time of 9:00 am on January 10, 2022. For each field
collector, this means&hellip;</p>
<p>A field collector first subsets cases to those that are active. The active cases
are placed in driving order by appealing to a routing service, and attempted
one-by-one. This means travelling to the address of each case, attempting to
interview the dwelling and any residents, and then moving to the next. The total
minutes spent interviewing and total distance travelled are tracked, and if the
maximum allowable minutes an interviewer can work in any day has been exceeded,
the interviewer will return home, rather than travel to the next case. Each time
a field collector travels to a new address, a record representing the trip,
including origin and destination coordinates, departure and arrival time, and
distance travelled is sent to the event recorder to persist. Likewise, all
attempts to interview a dwelling or individual&ndash;the time the attempt is made,
along with the outcome&ndash;is logged with the event recorder.</p>
<p>If a dwelling response has not been previously obtained, then the field
collector sends an <code>AttemptInterview</code> message to the dwelling, and the dwelling
responds with <code>DwellingRefusal</code>, <code>DwellingNoncontact</code>, or <code>DwellingResponse</code>. If
<code>DwellingRefusal</code>, the case is marked as complete, and no further attempts will
be made. If <code>DwellingNoncontact</code>, the collector moves on to the next case. If
<code>DwellingResponse</code>, the dwelling will also send a list of any individuals it has
spawned, and the collector will then attempt those in turn. Along with the list
of individuals, a dwelling will also send a payload representing a completed
household questionnaire (just a random string for now), which the collector will
then forward to the event recorder to persist. If a dwelling response has been
previously obtained, then the collector will already have a list of available
individuals, and so they will be attempted directly, and no message will be sent
to the dwelling.</p>
<a href="assets/dwelling_response.png" target="_blank">
<img src="assets/dwelling_response.png" class="med"/> </a>
<p> </p>
<p>Like dwellings, individuals will each be sent an <code>AttemptInterview</code> message, and
they will respond with any of <code>IndividualRefusal</code>, <code>IndividualNoncontact</code>, or
<code>IndividualResponse</code>. If <code>IndividualRefusal</code>, the individual will be marked as
complete, and no further attempts will be made. If <code>IndividualNoncontact</code>, the
collector will move on to the next individual, but the non-contact will remain
active, and so future interview attempts will be made. If <code>IndividualResponse</code>,
a payload representing a completed personal questionnaire will be sent as part
of the message, which the collector will then forward to the event recorder to
persist. The individual will be marked as complete, and no future interviews
will be attempted.</p>
<a href="assets/individual_response.png" target="_blank">
<img src="assets/individual_response.png" class="Large"/> </a>
<p> </p>
<p>When finished with a particular dwelling, field collectors send themselves a
<code>NextItem</code> message. When received, collectors will remove the current case from
the pool of outstanding work, and send an <code>AttemptInterview</code> message to the next
available case (to the dwelling if no response has yet been received, or to the
next unfinished individual). When moving to the next case, collectors increment
a <code>dayKms</code> variable (if travelling), and a <code>dayMins</code> variable as appropriate.</p>
<p>At any point, ff there is no more work, or if <code>dayMins</code> exceeds some
pre-configured amount of time in the day, the collector sends themselves the
<code>GoHome</code> message. When this message is received, the route home is calculated
and <code>dayKms</code> and <code>dayMins</code> are incremented, the pool of work is emptied, and no
further messages are sent.</p>
<h1 id="analysing-the-simulated-data">Analysing the Simulated Data</h1>
<p>When a simulation is run, a SQLite database is used by the system&rsquo;s event
recorder. This database remains once the simulation has completed, and can be
used to analyse the simulation after the fact. For example, above we noted that
the samples
<a href="https://github.com/cmhh/collectionsim/raw/main/data/sample1_02.csv.gz">sample1_02.csv.gz</a>
is more spatially dispersed than
<a href="https://github.com/cmhh/collectionsim/raw/main/data/sample1_01.csv.gz">sample1_01.csv.gz</a>,
and so we would expect this sample to require more time and travel, all else
constant. We can check this (in R, for convenience) quite directly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(RSQLite)

db1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbConnect</span>(RSQLite<span style="color:#f92672">::</span><span style="color:#a6e22e">SQLite</span>(), <span style="color:#e6db74">&#34;collectionsim1.db&#34;</span>)
db2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbConnect</span>(RSQLite<span style="color:#f92672">::</span><span style="color:#a6e22e">SQLite</span>(), <span style="color:#e6db74">&#34;collectionsim2.db&#34;</span>)

kms1 <span style="color:#f92672">&lt;-</span> DBI<span style="color:#f92672">::</span><span style="color:#a6e22e">dbGetQuery</span>(db1, <span style="color:#e6db74">&#34;select sum(distance) / 1000 from trips&#34;</span>)
kms2 <span style="color:#f92672">&lt;-</span> DBI<span style="color:#f92672">::</span><span style="color:#a6e22e">dbGetQuery</span>(db2, <span style="color:#e6db74">&#34;select sum(distance) / 1000 from trips&#34;</span>)

<span style="color:#a6e22e">as.numeric</span>(kms2 <span style="color:#f92672">/</span> kms1)

DBI<span style="color:#f92672">::</span><span style="color:#a6e22e">dbDisconnect</span>(db1)
DBI<span style="color:#f92672">::</span><span style="color:#a6e22e">dbDisconnect</span>(db2)
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">[1] 1.481211
</code></pre></div><p>That is, for one particular instance, the total distance travelled by all
collectors was roughly 1.5 times greater for
<a href="https://github.com/cmhh/collectionsim/raw/main/data/sample1_02.csv.gz">sample1_02.csv.gz</a>
than
<a href="https://github.com/cmhh/collectionsim/raw/main/data/sample1_01.csv.gz">sample1_01.csv.gz</a>.</p>
<p>In addition to this, we can create interactive tools using the simulated data.
For example, the following is a screen grab of a simple
<a href="https://shiny.rstudio.com/">Shiny</a> application which can be used to look at
daily work for each collector by day:</p>
<p><img src="assets/trips1.webp" alt=""></p>
<p>The following screen-grab is the same application, but configured to use a
routing service to get the paths for trips, rather than drawing simple straight
lines:</p>
<p><img src="assets/trips2.webp" alt=""></p>

            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="../../tags/akka">akka</a></span>
        
            <span class="tag"><a href="../../tags/akka-actor">akka-actor</a></span>
        
            <span class="tag"><a href="../../tags/akka-http">akka-http</a></span>
        
            <span class="tag"><a href="../../tags/aws">aws</a></span>
        
            <span class="tag"><a href="../../tags/azure">azure</a></span>
        
            <span class="tag"><a href="../../tags/deeplearning4j">deeplearning4j</a></span>
        
            <span class="tag"><a href="../../tags/docker">docker</a></span>
        
            <span class="tag"><a href="../../tags/geoserver">geoserver</a></span>
        
            <span class="tag"><a href="../../tags/geospark">geospark</a></span>
        
            <span class="tag"><a href="../../tags/kafka">kafka</a></span>
        
            <span class="tag"><a href="../../tags/nodejs">nodejs</a></span>
        
            <span class="tag"><a href="../../tags/postgis">postgis</a></span>
        
            <span class="tag"><a href="../../tags/postgraphile">postgraphile</a></span>
        
            <span class="tag"><a href="../../tags/postgresql">postgresql</a></span>
        
            <span class="tag"><a href="../../tags/postgrest">postgrest</a></span>
        
            <span class="tag"><a href="../../tags/qgis">qgis</a></span>
        
            <span class="tag"><a href="../../tags/r">r</a></span>
        
            <span class="tag"><a href="../../tags/r-packages">r-packages</a></span>
        
            <span class="tag"><a href="../../tags/scala">scala</a></span>
        
            <span class="tag"><a href="../../tags/seasonal-adjustment">seasonal-adjustment</a></span>
        
            <span class="tag"><a href="../../tags/sedona">sedona</a></span>
        
            <span class="tag"><a href="../../tags/shiny">shiny</a></span>
        
            <span class="tag"><a href="../../tags/single-page-web-apps">single-page-web-apps</a></span>
        
            <span class="tag"><a href="../../tags/spark">spark</a></span>
        
            <span class="tag"><a href="../../tags/tiles">tiles</a></span>
        
            <span class="tag"><a href="../../tags/tilestache">tilestache</a></span>
        
            <span class="tag"><a href="../../tags/vuejs">vuejs</a></span>
        
            <span class="tag"><a href="../../tags/wmts">wmts</a></span>
        
            <span class="tag"><a href="../../tags/wsl2">wsl2</a></span>
        
            <span class="tag"><a href="../../tags/x13-arima-seats">x13-arima-seats</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="../../2022/2022-03-03-deploying-shiny-apps/">Deploying Shiny Applications</a></h1>
            <time class="has-text-grey-light is-size-7">3 March 2022</time>
        
            <h1><a href="../../2022/2022-02-25-serving_postgis_feautres/">Serving PostGIS Features Over HTTP</a></h1>
            <time class="has-text-grey-light is-size-7">25 February 2022</time>
        
            <h1><a href="../../2022/2022-01-20-too-much-shiny/">Too Much Shiny?!</a></h1>
            <time class="has-text-grey-light is-size-7">20 January 2022</time>
        
            <h1><a href="../../2022/2022-01-09-agent-based-simulations-with-akka/">Agent Based Simulations with Akka</a></h1>
            <time class="has-text-grey-light is-size-7">9 January 2022</time>
        
            <h1><a href="../../2021/2021-08-14-data-services-from-postgres/">Data Services from Existing PostgreSQL Databases</a></h1>
            <time class="has-text-grey-light is-size-7">14 August 2021</time>
        
    </div>
</div>
    <br>
                


    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="../../archives/2022">2022</a> (4)<br>
        
            <a href="../../archives/2021">2021</a> (4)<br>
        
            <a href="../../archives/2020">2020</a> (4)<br>
        
            <a href="../../archives/2019">2019</a> (1)<br>
        
            <a href="../../archives/2017">2017</a> (1)<br>
        
            <a href="../../archives/2016">2016</a> (3)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://github.com/cmhh" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="mailto://cmhhansen@outlook.com" class="mysocial" rel="me"><i class="fas fa-envelope fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; cmhh 2022 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="//yihui.org/js/math-code.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>




</body>
</html>
