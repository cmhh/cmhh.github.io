<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>cmhh</title>
    <link>/categories/webservices/index.xml</link>
    <description>Recent content on cmhh</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <atom:link href="/categories/webservices/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Web Services with Node.js</title>
      <link>/post/webservice/</link>
      <pubDate>Sat, 28 May 2016 00:00:00 +0000</pubDate>
      
      <guid>/post/webservice/</guid>
      <description>&lt;!-- BLOGDOWN-BODY-BEFORE

/BLOGDOWN-BODY-BEFORE --&gt;

&lt;div id=&#34;what-is-node.js&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;What is node.js?&lt;/h1&gt;
&lt;p&gt;According to the &lt;a href=&#34;https://nodejs.org/en/&#34;&gt;Node.js website&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Node.js is a JavaScript runtime built on Chrome’s V8 JavaScript engine. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;Node.js’ package ecosystem, npm, is the largest ecosystem of open source libraries in the world.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div id=&#34;event-driven-non-blocking-io-model&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Event-driven, non-blocking I/O model&lt;/h2&gt;
&lt;p&gt;Node.js program execution consists of a single-threaded event loop. But all I/O methods in the Node.js standard library have asynchronous versions which accept a callback. This is what is meant by non-blocking I/O. The event loop doesn’t wait for I/O to complete–the callback is executed when the I/O task is finished, but the event loop carries on happily executing other code in the mean time.&lt;/p&gt;
&lt;p&gt;Digging around on the web shows some of this is pretty poorly understood. For example, a lot of people fixate on the fact that the event loop is single threaded, and make erroneous assumptions regarding performance. However, Node.js is &lt;em&gt;not&lt;/em&gt; single-threaded–just the event loop. As long as the event loop isn’t blocked with CPU intensive tasks or synchronous I/O, then Node.js will generally deliver excellent performance.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;extensible&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Extensible&lt;/h2&gt;
&lt;p&gt;As mentioned, Node.js is extensible, with functionality added via packages.&lt;br /&gt;
There are currently over 280,000 packages available from npm! We can’t pretend that they’re all of a high quality, of course, but still…&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.npmjs.com/browse/star&#34;&gt;most starred&lt;/a&gt;&lt;br&gt; &lt;a href=&#34;https://www.npmjs.com/browse/depended&#34;&gt;most dependent&lt;/a&gt;&lt;br&gt; &lt;a href=&#34;https://github.com/sindresorhus/awesome-nodejs&#34;&gt;Awesome Node.js&lt;/a&gt;&lt;br&gt; &lt;a href=&#34;http://npm-stat.com/charts.html&#34;&gt;npm-stat&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Here are the download counts for May 2016 for a few popular packages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;async - 29,431,852&lt;/li&gt;
&lt;li&gt;lodash - 28,420,265&lt;/li&gt;
&lt;li&gt;commander - 20,670,541&lt;/li&gt;
&lt;li&gt;request - 14,928,496&lt;/li&gt;
&lt;li&gt;underscore - 11,911,351&lt;/li&gt;
&lt;li&gt;express - 6,321,315&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note that a package might not be a Node.js package per se, but rather a repackaging of some other popular Javascript library–&lt;code&gt;lodash&lt;/code&gt;, for example But this should only make the use of Node.js an even more attractive proposition since there are a great number of extremely useful Javascript libraries out there… why not make use of them if you can?&lt;/p&gt;
&lt;p&gt;Actually, it’s fun to look at download counts to get an idea of what’s popular. For example, &lt;code&gt;mysql&lt;/code&gt; provides a MySQL driver, and was downloaded 503,893 times; &lt;code&gt;pg&lt;/code&gt; provides bindings for PostgreSQL and was downloaded 389,851 times; and &lt;code&gt;mssql&lt;/code&gt; is a client for MS SQL Server and was downloaded 54,824 times.&lt;/p&gt;
&lt;p&gt;Among NoSQL options, &lt;code&gt;redis&lt;/code&gt;, a Redis client, was downloaded 1,827,226 times; &lt;code&gt;mongoose&lt;/code&gt;, a MongoDB modelling tool, was downloaded 684,530 times; and &lt;code&gt;cassandra-driver&lt;/code&gt;, a driver for Cassandra, was downloaded 28,385 times.&lt;/p&gt;
&lt;p&gt;This would imply that NoSQL databases, and key-value stores in particular, are very popular when it comes to building network applications with Node.&lt;/p&gt;
&lt;p&gt;Node.js comes bundled with &lt;code&gt;npm&lt;/code&gt;, the Node Package Manager, so installing a new package is straightforward:&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;npm install [-g] &amp;lt;package&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;postman-testing-apis&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Postman / Testing APIs&lt;/h1&gt;
&lt;p&gt;Before getting into it, it’s useful to think about how we would go about testing our web services.&lt;/p&gt;
&lt;p&gt;In an earlier post on OpenCPU we simply used the &lt;code&gt;curl&lt;/code&gt; command line utility. In this post we’ll instead use a useful Chrome extension called Postman.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/postman.png&#34; /&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;making-an-http-server&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Making an HTTP server&lt;/h1&gt;
&lt;p&gt;Before moving on to some useful practical examples, let us look at a few simple cases.&lt;/p&gt;
&lt;div id=&#34;simplest-possible-server&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Simplest possible server&lt;/h2&gt;
&lt;p&gt;The next listing shows the simplest possible webserver we can come up with (without using third-party modules). It does nothing but listen on port 3000, and sends the string “Hello, World!” in response to every request.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;server.js&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;javascript&#34;&gt;&lt;code&gt;var http = require(&amp;quot;http&amp;quot;);

var server = http.createServer(function(request, response){
   response.write(&amp;quot;Hello, World!&amp;quot;);
   response.end();
});

server.listen(3000);&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Since this is the first service we’re running, we note that we start it simply by executing:&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;node server&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/0101.png&#34; /&gt;

&lt;/div&gt;
&lt;p&gt;It can also be fun to benchmark a service. You can do this with &lt;code&gt;ab&lt;/code&gt;, the ApacheBench tool, or &lt;code&gt;siege&lt;/code&gt;. For example, for the simple service above:&lt;/p&gt;
&lt;pre class=&#34;asis&#34;&gt;&lt;code&gt;cmhh@debian:~$ ab -kc 1000 -n 10000 http://debian:3000/
This is ApacheBench, Version 2.3 &amp;lt;$Revision: 1706008 $&amp;gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking debian (be patient)
Completed 1000 requests
Completed 2000 requests
Completed 3000 requests
Completed 4000 requests
Completed 5000 requests
Completed 6000 requests
Completed 7000 requests
Completed 8000 requests
Completed 9000 requests
Completed 10000 requests
Finished 10000 requests


Server Software:        
Server Hostname:        debian
Server Port:            3000

Document Path:          /
Document Length:        14 bytes

Concurrency Level:      1000
Time taken for tests:   1.699 seconds
Complete requests:      10000
Failed requests:        0
Keep-Alive requests:    0
Total transferred:      890000 bytes
HTML transferred:       140000 bytes
Requests per second:    5884.73 [#/sec] (mean)
Time per request:       169.931 [ms] (mean)
Time per request:       0.170 [ms] (mean, across all concurrent requests)
Transfer rate:          511.47 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0   89 281.0      0    1040
Processing:     3   35  23.7     29     287
Waiting:        2   33  22.8     28     287
Total:         10  124 286.7     31    1300

Percentage of the requests served within a certain time (ms)
  50%     31
  66%     48
  75%     65
  80%     74
  90%    110
  95%   1065
  98%   1078
  99%   1095
 100%   1300 (longest request)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;While not the most sophisticated service, we processed the requests at an average of 5884 per second. Seems decent enough…&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;serving-a-file&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Serving a file&lt;/h2&gt;
&lt;p&gt;Now we consider a slightly more complicated example. In this case, we simply serve the file &lt;code&gt;index.html&lt;/code&gt;, a simple HTML landing page. If not found, we issue 404.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;server.js&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;javascript&#34;&gt;&lt;code&gt;var http = require(&amp;#39;http&amp;#39;);
var fs = require(&amp;#39;fs&amp;#39;);

var server = http.createServer(function(request, response){
   if (request.method==&amp;quot;GET&amp;quot; &amp;amp;&amp;amp; request.url==&amp;quot;/&amp;quot;){
      response.writeHead(200, {&amp;#39;Content-Type&amp;#39;: &amp;#39;text/html&amp;#39;});
      fs.createReadStream(&amp;#39;./index.html&amp;#39;).pipe(response);
   }
   else{
      response.writeHead(404, {&amp;#39;Content-Type&amp;#39;: &amp;#39;text/html&amp;#39;});
      response.write(&amp;quot;&amp;amp;lt;h1&amp;amp;gt;404&amp;amp;lt;/h1&amp;amp;gt;&amp;amp;lt;p&amp;amp;gt;Sorry, bro.  There&amp;#39;s no such resource.&amp;amp;lt;/p&amp;amp;gt;&amp;quot;);
      response.end();
   }
})

server.listen(3000);&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;index.html&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;&amp;lt;pre&amp;gt;&amp;lt;code data-trim contenteditable class=&amp;quot;html hljs&amp;quot;
&amp;gt;&amp;amp;lt;html&amp;amp;gt;
&amp;amp;lt;head&amp;amp;gt;
   &amp;amp;lt;title&amp;amp;gt;Hello, World!&amp;amp;lt;/title&amp;amp;gt;
&amp;amp;lt;/head&amp;amp;gt;
&amp;amp;lt;body&amp;amp;gt;
   &amp;amp;lt;p&amp;amp;gt;Hello, World!&amp;amp;lt;/p&amp;amp;gt;
&amp;amp;lt;/body&amp;amp;gt;
&amp;amp;lt;/html&amp;amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/0201.png&#34; /&gt;

&lt;/div&gt;
&lt;p&gt;In this example, more than twice the amount of data is transferred compared to the previous example, and so the throughput falls accordingly:&lt;/p&gt;
&lt;pre class=&#34;asis&#34;&gt;&lt;code&gt;cmhh@debian:~$ ab -kc 1000 -n 10000 http://debian:3000/
This is ApacheBench, Version 2.3 &amp;lt;$Revision: 1706008 $&amp;gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking debian (be patient)
Completed 1000 requests
Completed 2000 requests
Completed 3000 requests
Completed 4000 requests
Completed 5000 requests
Completed 6000 requests
Completed 7000 requests
Completed 8000 requests
Completed 9000 requests
Completed 10000 requests
Finished 10000 requests


Server Software:        
Server Hostname:        debian
Server Port:            3000

Document Path:          /
Document Length:        101 bytes

Concurrency Level:      1000
Time taken for tests:   3.835 seconds
Complete requests:      10000
Failed requests:        0
Keep-Alive requests:    0
Total transferred:      2010000 bytes
HTML transferred:       1010000 bytes
Requests per second:    2607.54 [#/sec] (mean)
Time per request:       383.503 [ms] (mean)
Time per request:       0.384 [ms] (mean, across all concurrent requests)
Transfer rate:          511.83 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0  186 579.4      3    3009
Processing:    10  109  72.5     87     422
Waiting:        4   83  60.1     64     406
Total:         35  295 592.8     92    3426

Percentage of the requests served within a certain time (ms)
  50%     92
  66%    107
  75%    143
  80%    256
  90%   1092
  95%   1188
  98%   3092
  99%   3096
 100%   3426 (longest request)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We’re now down to a lowly 2607 requests per second!&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;serving-files&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Serving files&lt;/h2&gt;
&lt;p&gt;Now we make an even more flexible service–one capable of serving any file.&lt;br /&gt;
This time, however, we make use of the module &lt;code&gt;express&lt;/code&gt;. Brace yourself…&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;server.js&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;javascript&#34;&gt;&lt;code&gt;var express = require(&amp;#39;express&amp;#39;);
var app = express();
app.use(express.static(__dirname + &amp;#39;/public&amp;#39;)).listen(3000);&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The service will serve any file found in the &lt;code&gt;public&lt;/code&gt; folder, and will return an error for any file that does not exist.&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/0301.png&#34; /&gt;

&lt;/div&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/0302.png&#34; /&gt;

&lt;/div&gt;
&lt;p&gt;&lt;code&gt;express.static&lt;/code&gt; is an example of &lt;em&gt;middleware&lt;/em&gt;. You simply pass the middleware to the &lt;code&gt;use&lt;/code&gt; method, and you can chain lots of different middleware together. You could add more folders, compress content, cache content, and so on. In fact, let’s add compression to the above example:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;server.js&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;javascript&#34;&gt;&lt;code&gt;var express = require(&amp;#39;express&amp;#39;);
var compression = require(&amp;#39;compression&amp;#39;);
var app = express();

app.use(compression())
   .use(express.static(__dirname + &amp;#39;/public&amp;#39;))
   .listen(3000);&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;practical-examples&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Practical Examples&lt;/h1&gt;
&lt;p&gt;Let us now ramp things up a little and work through a couple of (somewhat) realistic and practical examples. I thought of two that I thought would be fun:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;provide a set of endpoints to query the &lt;a href=&#34;http://www.stats.govt.nz/Census/2013-census/data-tables/meshblock-dataset.aspx#csv&#34;&gt;Census Meshblock datasets&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;provide an endpoint for executing the X13-ARIMA-SEATS program&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This presentation consists of my first and only attempt to use node.js, so we’ll aim to keep things simple. In that spirit, arguments will be passed as part of the URI, for example:&lt;/p&gt;
&lt;pre class=&#34;html&#34;&gt;&lt;code&gt;/value1/value2/...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Moreover, responses, when provided, will generally be plain text or JSON format, but that shouldn’t prove any real issue for consumption. And just as I’m not exactly an expert in Node.js, I’m not an expert in writing fully compliant RESTful services. For the examples here, I’ll assume the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;GET&lt;/code&gt; will yield a status of 200 on success, and will return content; and 404 on failure, with no content.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;POST&lt;/code&gt; will yield a status of 200 or 204 on success–200 if content is returned, and 204 if no content is returned; and 404 on failure, with no content.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;DELETE&lt;/code&gt; will yield a status of 204 on success, and 404 on failure; no content will be returned in either case.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This may or may not conform to common practice, but that’s hardly the point.&lt;/p&gt;
&lt;div id=&#34;census-meshblock-service&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Census Meshblock service&lt;/h2&gt;
&lt;p&gt;In this example we are just serving data, so we first need to store the data where it can be easily retrieved by Node.js. There are a range of options available, but we choose to put the data in a MongoDB database in this case.&lt;/p&gt;
&lt;p&gt;If all we want to do is select meshblock data by meshblock code, then a key-value store like Redis might be sufficient, and would probably offer better performance. However, if we want to extend the example and allow more complicated queries, then MongoDB is a better option.&lt;/p&gt;
&lt;p&gt;As noted, the Census ‘meshblock’ data is not in a particularly usable state as is. So, I’ve imported the data and tidied it up, then put the tidied data in an R package called &lt;code&gt;NZCensus&lt;/code&gt;. This provides datasets such as the following:&lt;/p&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/datadictionary.png&#34; alt=&#34;datadictionary&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;&lt;code&gt;datadictionary&lt;/code&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/dwelling.png&#34; alt=&#34;dwelling&#34; /&gt;
&lt;p class=&#34;caption&#34;&gt;&lt;code&gt;dwelling&lt;/code&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;The full set of datasets is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;dwelling&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;household&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;`family```&lt;/li&gt;
&lt;li&gt;&lt;code&gt;individual&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;datadictionary&lt;/code&gt; - metadata describing columns in the above datasets&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Each dataset (excluding &lt;code&gt;datadictionary&lt;/code&gt;) contains data at a number of geographic levels: &lt;code&gt;MB&lt;/code&gt; - meshblock, &lt;code&gt;AU&lt;/code&gt; - area unit, &lt;code&gt;Ward&lt;/code&gt; - ward, &lt;code&gt;TA&lt;/code&gt; - territorial authority, &lt;code&gt;CMB&lt;/code&gt; - community board, and &lt;code&gt;RC&lt;/code&gt; - regional council.&lt;/p&gt;
&lt;p&gt;So, let’s aim for the following endpoints for the &lt;code&gt;datadictionary&lt;/code&gt; dataset:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/metadata&lt;/code&gt; - return the whole dataset&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/metadata/{column}&lt;/code&gt; - return metadata for column &lt;code&gt;column&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For the other datasets, let’s aim for:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/{dataset}/{MB|AU|Ward|TA|CMB|RC}/{code}&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For example, &lt;code&gt;/datadictionary/V0001&lt;/code&gt; will return the metadata for the column named &lt;code&gt;V0001&lt;/code&gt;. Similarly, &lt;code&gt;/dwelling/RC/01&lt;/code&gt; will return the ‘row’ of data from the &lt;code&gt;dwelling&lt;/code&gt; dataset corresponding to Northland regional council.&lt;/p&gt;
&lt;p&gt;Before making the service, though, we need to load the data into a database. We use MongoDB to store the data, and there’s a nice package in R called &lt;code&gt;mongolite&lt;/code&gt; which we can use to do the loading. As a simple example:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;loadmongodb.R&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(NZCensusLite)
library(mongolite)

m &amp;lt;- mongo(collection=&amp;quot;dwelling&amp;quot;, db=&amp;quot;census&amp;quot;)
m$insert(dwelling)

# and so on...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As an aside, this is nice and generic and would work for any dataset–not a schema in sight! This, among other things, can be extrememly useful.&lt;br /&gt;
SQL Server is not the answer for absolutely every application that needs persistent storage, and using something else on occasion doesn’t necessarily diminish the value of relational database management systems. Something to think about (for those who haven’t given NoSQL options a look).&lt;/p&gt;
&lt;p&gt;Anyway, we can run a few queries to ensure our data is loaded:&lt;/p&gt;
&lt;pre class=&#34;asis&#34;&gt;&lt;code&gt;cmhh@debian:~$ mongo
MongoDB shell version: 2.4.14
connecting to: test
&amp;amp;gt; 
&amp;amp;gt; use census
switched to db census
&amp;amp;gt; 
&amp;amp;gt; db.dwelling.find({&amp;quot;geography&amp;quot;:&amp;quot;RC&amp;quot;, &amp;quot;code&amp;quot;:&amp;quot;01&amp;quot;, &amp;quot;year&amp;quot;:2013},
... {&amp;quot;code&amp;quot;:1, &amp;quot;description&amp;quot;: 1, &amp;quot;year&amp;quot;: 1, &amp;quot;V0001&amp;quot;:1})
{
    &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5753a9346e955210cf07bd90&amp;quot;),
    &amp;quot;code&amp;quot; : &amp;quot;01&amp;quot;,
    &amp;quot;description&amp;quot; : &amp;quot;Northland Region&amp;quot;,
    &amp;quot;year&amp;quot; : 2013,
    &amp;quot;V0001&amp;quot; : 47820
}
&amp;amp;gt; 
&amp;amp;gt; db.metadata.find({$or: [{&amp;quot;name&amp;quot;:&amp;quot;V0001&amp;quot;}, {&amp;quot;name&amp;quot;:&amp;quot;V0002&amp;quot;}]})
{
    &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5753a9a76e955210cf0e77d9&amp;quot;),
    &amp;quot;name&amp;quot; : &amp;quot;V0001&amp;quot;,
    &amp;quot;type&amp;quot; : &amp;quot;dwelling&amp;quot;,
    &amp;quot;subtype&amp;quot; : &amp;quot;dwelling&amp;quot;,
    &amp;quot;variable&amp;quot; : &amp;quot;Occupied private dwelling type&amp;quot;,
    &amp;quot;outcome&amp;quot; : &amp;quot;Separate House&amp;quot;,
    &amp;quot;notes&amp;quot; : &amp;quot;&amp;quot;
}
{
    &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;5753a9a76e955210cf0e77da&amp;quot;),
    &amp;quot;name&amp;quot; : &amp;quot;V0002&amp;quot;,
    &amp;quot;type&amp;quot; : &amp;quot;dwelling&amp;quot;,
    &amp;quot;subtype&amp;quot; : &amp;quot;dwelling&amp;quot;,
    &amp;quot;variable&amp;quot; : &amp;quot;Occupied private dwelling type&amp;quot;,
    &amp;quot;outcome&amp;quot; : &amp;quot;Two or More Flats/Units/Townhouses/ Apartments/Houses Joined Together&amp;quot;,
    &amp;quot;notes&amp;quot; : &amp;quot;&amp;quot;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let’s look at a service where we define a single endpoint, &lt;code&gt;/metadata/column&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;server.js&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;javascript&#34;&gt;&lt;code&gt;var express = require(&amp;#39;express&amp;#39;);
var app = express();
var assert = require(&amp;#39;assert&amp;#39;);
var client = require(&amp;#39;mongodb&amp;#39;).MongoClient;
var url = &amp;#39;mongodb://127.0.0.1:27017/census&amp;#39;;
var db;

client.connect(url, function(err, database) {
  assert.equal(null, err);
  db = database;
  app.listen(3000);
});

app.get(&amp;#39;/metadata/:name&amp;#39;, function(request, response){
   response.setHeader(&amp;#39;Content-Type&amp;#39;, &amp;#39;application/json&amp;#39;);
   db.collection(&amp;#39;metadata&amp;#39;).find({&amp;quot;name&amp;quot;: request.params.name}, function(err, items){
      var a = items.toArray(function(err, results){
         response.write(JSON.stringify(results));
         response.end();
      });
   });
});&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/metadata01.png&#34; /&gt;

&lt;/div&gt;
&lt;p&gt;And, for giggles, let’s benchmark the service:&lt;/p&gt;
&lt;pre class=&#34;asis&#34;&gt;&lt;code&gt;cmhh@debian:~$ ab -kc 1000 -n 10000 http://debian:3000/V0001
This is ApacheBench, Version 2.3 &amp;lt;$Revision: 1706008 $&amp;gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking debian (be patient)
Completed 1000 requests
Completed 2000 requests
Completed 3000 requests
Completed 4000 requests
Completed 5000 requests
Completed 6000 requests
Completed 7000 requests
Completed 8000 requests
Completed 9000 requests
Completed 10000 requests
Finished 10000 requests


Server Software:        
Server Hostname:        debian
Server Port:            3000

Document Path:          /V0001
Document Length:        18 bytes

Concurrency Level:      1000
Time taken for tests:   1.823 seconds
Complete requests:      10000
Failed requests:        0
Non-2xx responses:      10000
Keep-Alive requests:    10000
Total transferred:      2210000 bytes
HTML transferred:       180000 bytes
Requests per second:    5485.41 [#/sec] (mean)
Time per request:       182.302 [ms] (mean)
Time per request:       0.182 [ms] (mean, across all concurrent requests)
Transfer rate:          1183.86 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0   19 133.2      0    1006
Processing:    12   57  27.1     53     326
Waiting:       12   57  27.1     53     326
Total:         12   76 148.5     54    1330

Percentage of the requests served within a certain time (ms)
  50%     54
  66%     64
  75%     71
  80%     74
  90%     84
  95%     94
  98%    151
  99%   1092
 100%   1330 (longest request)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So, 5485 requests per second. Not too shabby…&lt;/p&gt;
&lt;p&gt;Now let’s add the &lt;code&gt;/metadata&lt;/code&gt; and &lt;code&gt;/dataset/&lt;/code&gt; endpoints:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;server.js&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;javascript&#34;&gt;&lt;code&gt;var express = require(&amp;#39;express&amp;#39;);
var app = express();
var client = require(&amp;#39;mongodb&amp;#39;).MongoClient;
var url = &amp;#39;mongodb://127.0.0.1:27017/census&amp;#39;;
var db;

client.connect(url, function(err, database) {
  if (!err){
     db = database;
     app.listen(3000);
  }
});

app.get(&amp;#39;/metadata&amp;#39;, function(request, response){
   db.collection(&amp;#39;metadata&amp;#39;).find({}, function(err, items){
      if (!err){
         var a = items.toArray(function(err, results){
            if (!err){
               response.setHeader(&amp;#39;Content-Type&amp;#39;, &amp;#39;application/json&amp;#39;);
               response.statusCode = 200;
               response.write(JSON.stringify(results));
               response.end();
            }
            else{
               response.statusCode = 404;
               response.end();
            }
         });
      }
      else{
         response.statusCode = 404;
         response.end();
      }
   });
});

app.get(&amp;#39;/metadata/:name&amp;#39;, function(request, response){
   db.collection(&amp;#39;metadata&amp;#39;).find({&amp;quot;name&amp;quot;: request.params.name}, function(err, items){
      if (!err){
         var a = items.toArray(function(err, results){
            if (!err){
               response.setHeader(&amp;#39;Content-Type&amp;#39;, &amp;#39;application/json&amp;#39;);
               response.statusCode = 200;
               response.write(JSON.stringify(results));
               response.end();
            }
            else{
               response.statusCode = 404;
               response.end();
            }
         });
      }
      else {
         response.statusCode = 404;
         response.end();
      }
   });
});

app.get(&amp;#39;/:dataset/:geography/:code&amp;#39;, function(request, response){
   var dataset = request.params.dataset;
   var geography = request.params.geography;
   var code = request.params.code;
   var collection = db.collection(dataset);
   collection.find({&amp;quot;geography&amp;quot;:geography, &amp;quot;code&amp;quot;:code}, function(err, items){
      if (!err){
         var a = items.toArray(function(err, results){
            if (!err){
               response.setHeader(&amp;#39;Content-Type&amp;#39;, &amp;#39;application/json&amp;#39;);
               response.statusCode = 200;
               response.write(JSON.stringify(results));
               response.end();
            }
            else {
               response.statusCode = 404;
               response.end();
            }
         });
      }
      else {
         response.statusCode = 404;
         response.end();
      }
   });
});&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/metadata02.png&#34; /&gt;

&lt;/div&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/dwelling01.png&#34; /&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;x13-arima-seats-service&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;X13-ARIMA-SEATS service&lt;/h2&gt;
&lt;p&gt;This example is somewhat more complicated. But, again, to keep things a little simple, we will assume that the required input for an adjustment is a single ‘&lt;code&gt;spc&lt;/code&gt;’ file containing both the raw data to be adjusted as well as the adjustment specifications. The &lt;code&gt;spc&lt;/code&gt; file will be submitted via a &lt;code&gt;POST&lt;/code&gt; request.&lt;/p&gt;
&lt;p&gt;Taking inspiration from &lt;a href=&#34;https://www.opencpu.org/&#34;&gt;OpenCPU&lt;/a&gt;, the result will be a series of endpoints available via a &lt;code&gt;GET&lt;/code&gt; request where each corresponds to a text file generated by the X13 program.&lt;/p&gt;
&lt;p&gt;For example, assume we upload &lt;code&gt;foo.spc&lt;/code&gt; and conduct an adjustment, and this yields the remote file &lt;code&gt;foo.d12&lt;/code&gt;. Then this file will be available via &lt;code&gt;/foo/d12&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Attempting to &lt;code&gt;POST&lt;/code&gt; an adjustment that has already been run will result in failure. But using the &lt;code&gt;DELETE&lt;/code&gt; method on &lt;code&gt;/foo&lt;/code&gt; will remove any trace of the adjustment from the server.&lt;/p&gt;
&lt;p&gt;To install X13-ARIMA-SEATS on Linux:&lt;/p&gt;
&lt;pre class=&#34;bash&#34;&gt;&lt;code&gt;wget https://www.census.gov/ts/x13as/unix/x13assrc_V1.1_B26.tar.gz
tar -xvf x13assrc_V1.1_B26.tar.gz
make -f makefile.gf
sudo mv x13asv11b26o1 /usr/local/bin/x13as&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let us just use the &lt;code&gt;Testairline.spc&lt;/code&gt; file that comes bundled with the &lt;code&gt;x13as&lt;/code&gt; program (note that this &lt;code&gt;spc&lt;/code&gt; format looks like a prime candidate for conversion to some other format, such as JSON):&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;Testairline.spc&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;asis&#34;&gt;&lt;code&gt;series{
  title=&amp;quot;International Airline Passengers Data from Box and Jenkins&amp;quot;
  start=1949.01
  data=(
    112 118 132 129 121 135 148 148 136 119 104 118
    115 126 141 135 125 149 170 170 158 133 114 140
    145 150 178 163 172 178 199 199 184 162 146 166
    171 180 193 181 183 218 230 242 209 191 172 194
    196 196 236 235 229 243 264 272 237 211 180 201
    204 188 235 227 234 264 302 293 259 229 203 229
    242 233 267 269 270 315 364 347 312 274 237 278
    284 277 317 313 318 374 413 405 355 306 271 306
    315 301 356 348 355 422 465 467 404 347 305 336
    340 318 362 348 363 435 491 505 404 359 310 337
    360 342 406 396 420 472 548 559 463 407 362 405
    417 391 419 461 472 535 622 606 508 461 390 432)
  span=(1952.01, )
}
spectrum{
  savelog=peaks 
}
transform{
  function=auto
  savelog=autotransform  
}
regression{
  aictest=(td easter)
  savelog=aictest  
}
automdl{  
  savelog=automodel  
}
outlier{ }
x11{
  save=(d10 d11 d12)
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here’s the full service:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;server.js&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;pre class=&#34;javascript&#34;&gt;&lt;code&gt;var express = require(&amp;#39;express&amp;#39;);
var app = express();
var fs = require(&amp;#39;fs&amp;#39;);
var rimraf = require(&amp;#39;rimraf&amp;#39;);
var exec = require(&amp;#39;child_process&amp;#39;).exec;
var busboy = require(&amp;#39;connect-busboy&amp;#39;);
var path = require(&amp;#39;path&amp;#39;);

app.use(busboy());

app.post(&amp;#39;/adjust&amp;#39;, function(request, response){
   request.pipe(request.busboy);
   request.busboy.on(&amp;#39;file&amp;#39;, function(fieldname, file, filename){
      var fstream;
      var basename = path.basename(filename, path.extname(filename));
      fs.mkdir(__dirname  + &amp;#39;/work/&amp;#39; + basename, function(err){
         if (!err){
            fstream = fs.createWriteStream(__dirname + &amp;quot;/work/&amp;quot; + basename + &amp;#39;/&amp;#39; + filename);
            file.pipe(fstream);
            fstream.on(&amp;#39;close&amp;#39;, function(){
               var cmd = &amp;#39;cd &amp;#39; + __dirname + &amp;#39;/work/&amp;#39; + basename + &amp;#39; &amp;amp;&amp;amp; x13as &amp;#39; + basename;
               exec(cmd, function(error, stdout, stderr) {
                  if (!error){
                     response.statusCode = 200;
                     fs.readdir(__dirname + &amp;#39;/work/&amp;#39; + basename, function(err, files){
                        if (!err){
                           files.forEach(function(file){
                              var thisext = path.extname(file);
                              var thisbase = path.basename(file, thisext);
                              thisext = thisext.split(&amp;#39;.&amp;#39;).pop();
                              if (basename==thisbase) response.write(&amp;#39;/&amp;#39; + basename + &amp;#39;/&amp;#39; + thisext + &amp;#39;\n&amp;#39;);
                           });
                           response.end();
                        }
                     });
                  }
                  else{
                     response.statusCode = 404;
                     response.end();
                  }
               });
            });
         }
         else{
            response.statusCode = 404;
            response.end();
         }
      });
   });
});

app.delete(&amp;#39;/:series&amp;#39;, function(request, response){
   response.statusCcode = 404;
   var series = request.params.series;
   fs.stat(__dirname + &amp;#39;/work/&amp;#39; + series, function(err, stat){
      if (!err){
         rimraf(__dirname + &amp;#39;/work/&amp;#39; + series, function(err){
            if (!err){
               response.statusCode = 204;
               response.end();
            }
            else{
               response.statusCode = 404;
               response.end();
            }
         });
      }
      else{
         response.statusCode = 404;
         response.end();
      }
   });
});

app.get(&amp;#39;/:series/:output&amp;#39;, function(request, response){
   var series = request.params.series;
   var output = request.params.output;
   fs.stat(__dirname + &amp;#39;/work/&amp;#39; + series + &amp;#39;/&amp;#39; + series + &amp;#39;.&amp;#39; + output, function(err, stat){
      if (!err){
         response.statusCode = 200;
         response.setHeader(&amp;quot;Content-Type&amp;quot;, &amp;quot;text/html&amp;quot;);
         fs.createReadStream(__dirname + &amp;#39;/work/&amp;#39; + series + &amp;#39;/&amp;#39; + series + &amp;#39;.&amp;#39; + output).pipe(response);
      }
      else{
         response.statusCode = 404;
         response.end();
      }
   });
});

app.listen(3000);&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/x13post.png&#34; /&gt;

&lt;/div&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/x13get01.png&#34; /&gt;

&lt;/div&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/x13get02.png&#34; /&gt;

&lt;/div&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/x13delete.png&#34; /&gt;

&lt;/div&gt;
&lt;p&gt;And we might as well visualise the results:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;getandplot &amp;lt;- function(){
   if (!require(magrittr)) stop(&amp;quot;Nope.&amp;quot;)
   d10 &amp;lt;- read.table(&amp;quot;http://127.0.0.1:3000/Testairline/d10&amp;quot;, 
                     col.names=c(&amp;quot;date&amp;quot;, &amp;quot;d10&amp;quot;), skip=2)
   d11 &amp;lt;- read.table(&amp;quot;http://127.0.0.1:3000/Testairline/d11&amp;quot;, 
                     col.names=c(&amp;quot;date&amp;quot;, &amp;quot;d11&amp;quot;), skip=2)
   d12 &amp;lt;- read.table(&amp;quot;http://127.0.0.1:3000/Testairline/d12&amp;quot;, 
                     col.names=c(&amp;quot;date&amp;quot;, &amp;quot;d12&amp;quot;), skip=2)
   ap  &amp;lt;- ts((d10 %&amp;gt;% merge(d11) %&amp;gt;% merge(d12))[,-1], start=c(1952,1), frequency=12)
   plot(ap[,&amp;quot;d11&amp;quot;] * ap[,&amp;quot;d10&amp;quot;], xlab=&amp;quot;&amp;quot;, ylab=&amp;quot;&amp;quot;, lty=2)
   lines(ap[,&amp;quot;d11&amp;quot;])
   lines(ap[,&amp;quot;d12&amp;quot;], col=&amp;quot;grey&amp;quot;)
   legend(&amp;quot;topleft&amp;quot;, c(&amp;quot;actual&amp;quot;, &amp;quot;SA&amp;quot;, &amp;quot;trend&amp;quot;), 
          lty=c(2,1,1), col=c(&amp;quot;black&amp;quot;, &amp;quot;black&amp;quot;, &amp;quot;grey&amp;quot;), box.col=NA)
   box()
}&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;getandplot()&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;figure&#34;&gt;
&lt;img src=&#34;../../img/webservice/plot.png&#34; /&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&#34;summary&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Summary&lt;/h1&gt;
&lt;p&gt;We’ve touched on a few ideas here. Without advocating specifically for Node.js, we see that web services provide some useful use cases:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;they can provide an alternative to ‘traditional’ dissemination methods such as file downloads–particularly useful for those who only need a subset of the dataset at any one time&lt;/li&gt;
&lt;li&gt;they can be used to wrap existing programs, making them cross platform, and standardising input and output requirements.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The latter is particularly interesting, and you can imagine some obvious applications–CSPA, for example. In fact, I got curious and, for fun, Googled ‘Node.js CSPA’, and found the following:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/edwindj/cspa_rest&#34;&gt;Designing a REST interface for CSPA command line services&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;There is a PDF included:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/edwindj/cspa_rest/blob/master/doc/proposal_rest_interface.pdf&#34;&gt;Generic REST interface for CSPA services&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;We repeat the abstract here:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A generic REST interface is proposed which can be used by many of the services in CSPA. Furthermore, it is possible to develop a generic implementation which can be used to wrap the REST interface around an existing service making implementation much more simple. A generic interface used by most of the services would make it easier to implement systems that use the services.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Of course, web services can be written in any number of languages, including C# with ASP.NET, or Scala or Java with the Play framework. But Node.js has a lot going for it. It is easy to use, and there is an astonishing amount of code out there that we can borrow, free of charge.&lt;/p&gt;
&lt;p&gt;Finally, the other interesting thing we saw was MongoDB, a document database. MongoDB is a NoSQL database capable of storing massive amounts of data in binary JSON (BSON) format with a dynamic schema. It is fast, flexible, and reliable; and lends itself well to rapid development.&lt;/p&gt;
&lt;p&gt;You could argue that using a NoSQL database like MongoDB makes your applications easier to use for 3rd parties–they don’t have to have a specific RDBMS, create users, create databases, create tables with specific schemas, and so on.&lt;/p&gt;
&lt;p&gt;There are times when NoSQL databases like Redis or MongoDB are just much easier to use than a traditional RDBMS, and there really isn’t any good reason not to get on board. Horses for courses, and all that. They can be complementary to SQL, and time saved in development could easily offset any increased IT support required (which is a pretty specious assertion anyway).&lt;/p&gt;
&lt;/div&gt;



&lt;!-- BLOGDOWN-HEAD






/BLOGDOWN-HEAD --&gt;
</description>
    </item>
    
  </channel>
</rss>