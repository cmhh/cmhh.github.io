<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>cmhh  | Collecting Spark DataFrames or RDDs with Akka Actors</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link href="../../css/highlight/atom-one-dark-reasonable.css" rel='stylesheet' type='text/css' />
    <link rel="stylesheet" href="../../css/blog.css" />
    </head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="../../">Home</a>
            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(/img/bg-blog-2.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Collecting Spark DataFrames or RDDs with Akka Actors
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <!-- raw HTML omitted -->
<h1 id="overview">Overview</h1>
<p>I was recently running a process mostly using Spark SQL, but at one point ended up collecting a large DataFrame and converting it to a standard Scala Map.  The source was a large DataFrame containing several records for each of a number of IDs, and I needed to do some reasonably complicated processing by ID (or at least complicated enough that an efficient solution using either DataFrames or RDDs wasn&rsquo;t obvious to me).  I ended up doing something like the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Scala" data-lang="Scala"><span style="color:#66d9ef">val</span> x<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Row</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> df<span style="color:#f92672">.</span>toRDD<span style="color:#f92672">.</span>collect<span style="color:#f92672">.</span>toList
<span style="color:#66d9ef">val</span> y<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">process</span><span style="color:#f92672">(</span><span style="color:#66d9ef">x</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Record</span><span style="color:#f92672">]]())</span>

<span style="color:#66d9ef">def</span> process<span style="color:#f92672">(</span>xs<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Row</span><span style="color:#f92672">],</span> accum<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Record</span><span style="color:#f92672">]])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Record</span><span style="color:#f92672">]]</span> <span style="color:#66d9ef">=</span> xs <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Nil</span> <span style="color:#66d9ef">=&gt;</span> accum
  <span style="color:#66d9ef">case</span> h<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:t</span> <span style="color:#f92672">=&gt;</span> 
    <span style="color:#66d9ef">val</span> key <span style="color:#66d9ef">=</span> h<span style="color:#f92672">.</span>getString<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">val</span> value <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Record</span><span style="color:#f92672">(</span>h<span style="color:#f92672">.</span>get<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">),</span> h<span style="color:#f92672">.</span>get<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">))</span> 
    process<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span> accum <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>accum<span style="color:#f92672">.</span>getOrElse<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> <span style="color:#a6e22e">Vector</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Record</span><span style="color:#f92672">]())</span> <span style="color:#66d9ef">:</span><span style="color:#66d9ef">+</span> <span style="color:#66d9ef">value</span><span style="color:#f92672">)))</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>To make this clearer, imagine a Spark DataFrame that looks as follows:</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>foo</th>
<th>bar</th>
<th>baz</th>
</tr>
</thead>
<tbody>
<tr>
<td>aaaa</td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>bbbb</td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>aaaa</td>
<td>4</td>
<td>5</td>
<td>6</td>
</tr>
<tr>
<td>cccc</td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>bbbb</td>
<td>7</td>
<td>8</td>
<td>9</td>
</tr>
</tbody>
</table>
<p>I would collect this, and then load it into a Map that looked something like the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#a6e22e">Map</span><span style="color:#f92672">(</span>
  <span style="color:#e6db74">&#34;a&#34;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">List</span><span style="color:#f92672">((</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">)),</span>
  <span style="color:#e6db74">&#34;b&#34;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">List</span><span style="color:#f92672">((</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">),</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span><span style="color:#f92672">)),</span>
  <span style="color:#e6db74">&#34;c&#34;</span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">List</span><span style="color:#f92672">((</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">))</span>
<span style="color:#f92672">)</span>
</code></pre></div><p>I would then define a function <code>f: List[(Int,Int,Int)] =&gt; List[(Int,Int,Int)]</code> and apply it to each ID group to obtain a new, transformed set of records.</p>
<p>This is a pretty wasteful exercise on two fronts.  First, collecting an RDD is something you&rsquo;d generally want to avoid if you could.  And having collected the data, it is then just copied again into a different type of collection.  It certainly works, but it&rsquo;s quite slow, and it requires a lot of RAM.</p>
<p>I&rsquo;ve had a lot of fun with Akka Actors recently, and I&rsquo;m always on the lookout for ways to shoehorn them in, whether it makes sense or not.  So, thought I&rsquo;d try it here.  I decided to make an Actor whose internal state was a Map, and which would then just be sent a message for each row in my RDD.  Doing this we can avoid collecting the RDD and instead use the usual <code>foreach*</code> iterator.  And each row of the data gets put directly into our target Map, so no double-handling.  And this is what we&rsquo;ll look at in this post.</p>
<h1 id="data">Data</h1>
<p>The actual use case was more complicated than described, but that description will nevertheless be good enough as a practical basis.  We can generate a test set that will suffice as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> org.apache.spark.sql.SparkSession
<span style="color:#66d9ef">import</span> scala.util.Random

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">implicits</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">val</span> spark<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">SparkSession</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SparkSession</span>
    <span style="color:#f92672">.</span>builder
    <span style="color:#f92672">.</span>master<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;local[4]&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>appName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;test&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>getOrCreate
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">object</span> <span style="color:#a6e22e">Data</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">import</span> implicits._
  <span style="color:#66d9ef">import</span> spark.implicits._

  <span style="color:#66d9ef">val</span> chars <span style="color:#66d9ef">=</span> <span style="color:#e6db74">&#34;01234567890abcdef&#34;</span><span style="color:#f92672">.</span>toVector

  <span style="color:#66d9ef">def</span> rid <span style="color:#66d9ef">=</span> <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> to <span style="color:#ae81ff">4</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>i <span style="color:#66d9ef">=&gt;</span> chars<span style="color:#f92672">(</span><span style="color:#a6e22e">Random</span><span style="color:#f92672">.</span>nextInt<span style="color:#f92672">(</span>chars<span style="color:#f92672">.</span>size<span style="color:#f92672">)))</span>
    <span style="color:#f92672">.</span>mkString

  <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">val</span> df <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
    scala<span style="color:#f92672">.</span>util<span style="color:#f92672">.</span><span style="color:#a6e22e">Random</span><span style="color:#f92672">.</span>setSeed<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span>
    <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> to <span style="color:#ae81ff">1000000</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>i <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>rid<span style="color:#f92672">,</span> <span style="color:#a6e22e">Random</span><span style="color:#f92672">.</span>nextInt<span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">),</span> <span style="color:#a6e22e">Random</span><span style="color:#f92672">.</span>nextInt<span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">)))</span>
      <span style="color:#f92672">.</span>toDF<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>The first 10 rows of the dataset will then look something like the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">scala&gt; Data.df.show(10)
+----+---+---+
|  id|  a|  b|
+----+---+---+
|00fc|  4| 34|
|68c6| 73| 17|
|095a| 62| 96|
|cf33| 99| 74|
|9a80|  2|  5|
|23a7| 55| 89|
|fefa| 60| 77|
|9c6a| 88|  0|
|1a37| 55| 36|
|ec02| 84|  0|
+----+---+---+
only showing top 10 rows
</code></pre></div><p>Importantly, there will a maximum of 65536 unique IDs observed, so a lower bound on the average number of records for each ID will be about 15.  Moreover, the records associated with each ID will be scattered randomly throughout the DataFrame.  For example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">scala&gt; import org.apache.spark.sql.functions.{col, lit}
scala&gt; Data.df.filter(col(&#34;id&#34;) === lit(&#34;68c6&#34;)).show
+----+---+---+
|  id|  a|  b|
+----+---+---+
|68c6| 73| 17|
|68c6| 98| 98|
|68c6|  3| 76|
|68c6|  9| 94|
|68c6| 95| 30|
|68c6| 73| 40|
|68c6| 25| 40|
|68c6| 24|  6|
|68c6| 39| 78|
|68c6| 91| 64|
|68c6|  0|  6|
|68c6| 27| 96|
|68c6| 35| 42|
|68c6| 43| 20|
|68c6| 82| 51|
+----+---+---+
</code></pre></div><h1 id="the-original-approach">The Original Approach</h1>
<p>We can collect the DataFrame and load it into a Map as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">def</span> process<span style="color:#f92672">(</span>xs<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Row</span><span style="color:#f92672">],</span> accum<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">Int</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Seq</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">Int</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]]</span> <span style="color:#66d9ef">=</span> xs <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Nil</span> <span style="color:#66d9ef">=&gt;</span> accum
  <span style="color:#66d9ef">case</span> h<span style="color:#66d9ef">:</span><span style="color:#66d9ef">:t</span> <span style="color:#f92672">=&gt;</span> 
    <span style="color:#66d9ef">val</span> key <span style="color:#66d9ef">=</span> h<span style="color:#f92672">.</span>getString<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">val</span> value <span style="color:#66d9ef">=</span> <span style="color:#f92672">(</span>h<span style="color:#f92672">.</span>getInt<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">),</span> h<span style="color:#f92672">.</span>getInt<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">))</span> 
    process<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span> accum <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>key <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>accum<span style="color:#f92672">.</span>getOrElse<span style="color:#f92672">(</span>key<span style="color:#f92672">,</span> <span style="color:#a6e22e">List</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">)</span> <span style="color:#66d9ef">:</span><span style="color:#66d9ef">+</span> <span style="color:#66d9ef">value</span><span style="color:#f92672">)))</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">val</span> x <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Data</span><span style="color:#f92672">.</span>df<span style="color:#f92672">.</span>rdd<span style="color:#f92672">.</span>collect
<span style="color:#66d9ef">val</span> y <span style="color:#66d9ef">=</span> process<span style="color:#f92672">(</span>x<span style="color:#f92672">.</span>toList<span style="color:#f92672">,</span> <span style="color:#a6e22e">Map</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">)</span>
</code></pre></div><p>On my machine this took roughly 9 seconds or so to collect the RDD, and then 2 seconds to create the Map.  And, of course, we can confirm things are as expected:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">scala&gt; y(&#34;68c6&#34;).foreach(println)
(73,17)
(98,98)
(3,76)
(9,94)
(95,30)
(73,40)
(25,40)
(24,6)
(39,78)
(91,64)
(0,6)
(27,96)
(35,42)
(43,20)
(82,51)
</code></pre></div><h1 id="with-actors">With Actors</h1>
<p>I haven&rsquo;t yet familiarised myself with the new typed actors, so for this example we&rsquo;ll just stick with a classic actor.  Either way, a relatively simple setup will get the job done:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> akka.actor.Actor

<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">F</span><span style="color:#f92672">(</span>f<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Vector</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">Int</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Vector</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">Int</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)])</span>
<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Get</span><span style="color:#f92672">(</span>key<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MapActor</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Actor</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">def</span> receive <span style="color:#66d9ef">=</span> process<span style="color:#f92672">(</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">)</span>

  <span style="color:#66d9ef">def</span> process<span style="color:#f92672">(</span>state<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">Vector</span><span style="color:#f92672">[(</span><span style="color:#66d9ef">Int</span>, <span style="color:#66d9ef">Int</span><span style="color:#f92672">)]])</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Receive</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> <span style="color:#f92672">(</span>x<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> y<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">,</span> z<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Int</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> 
      context<span style="color:#f92672">.</span>become<span style="color:#f92672">(</span>process<span style="color:#f92672">(</span>state <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>x <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">(</span>state<span style="color:#f92672">.</span>getOrElse<span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> <span style="color:#a6e22e">Vector</span><span style="color:#f92672">.</span>empty<span style="color:#f92672">)</span> <span style="color:#66d9ef">:</span><span style="color:#66d9ef">+</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">y</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">z</span><span style="color:#f92672">)))))</span>
    <span style="color:#66d9ef">case</span> F<span style="color:#f92672">(</span>f<span style="color:#f92672">)</span>   <span style="color:#66d9ef">=&gt;</span> sender <span style="color:#f92672">!</span> state<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>x <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">.</span>_1<span style="color:#f92672">,</span> f<span style="color:#f92672">(</span>x<span style="color:#f92672">.</span>_2<span style="color:#f92672">)))</span>
    <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Get</span><span style="color:#f92672">(</span>k<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> sender <span style="color:#f92672">!</span> state<span style="color:#f92672">.</span>get<span style="color:#f92672">(</span>k<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;info&#34;</span> <span style="color:#66d9ef">=&gt;</span> sender <span style="color:#f92672">!</span> <span style="color:#f92672">(</span>state<span style="color:#f92672">.</span>size<span style="color:#f92672">,</span> state<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_2<span style="color:#f92672">.</span>size<span style="color:#f92672">).</span>sum<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>We won&rsquo;t really use the message <code>F</code>, but we include it as an illustration of the sort of thing you <em>could</em> do–<code>f</code> might define some complex transformation of the orginal values, for example, and even the signature assigned here could be different depending on requirements.  Note that we return the actor&rsquo;s internal state when we pass the string <code>&quot;state&quot;</code> as a message.  This isn&rsquo;t a great pattern, but since <code>state</code> is immutable it won&rsquo;t do any harm, and for the purpose of this document it&rsquo;s useful to be able to show directly that things have been inserted correctly.  Anyway, to use the actor:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">import</span> scala.concurrent.Await
<span style="color:#66d9ef">import</span> scala.concurrent.duration.Duration
<span style="color:#66d9ef">import</span> scala.concurrent.ExecutionContext.Implicits.global

<span style="color:#66d9ef">val</span> system <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">ActorSystem</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;system&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">val</span> actor <span style="color:#66d9ef">=</span> system<span style="color:#f92672">.</span>actorOf<span style="color:#f92672">(</span><span style="color:#a6e22e">Props</span><span style="color:#f92672">[</span><span style="color:#66d9ef">MapActor</span><span style="color:#f92672">],</span> <span style="color:#e6db74">&#34;mapActor&#34;</span><span style="color:#f92672">)</span>  

<span style="color:#66d9ef">val</span> x <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Data</span><span style="color:#f92672">.</span>df<span style="color:#f92672">.</span>rdd

<span style="color:#66d9ef">val</span> res <span style="color:#66d9ef">=</span> x<span style="color:#f92672">.</span>foreachAsync<span style="color:#f92672">(</span>row <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">{</span>
  actor <span style="color:#f92672">!</span> <span style="color:#f92672">(</span>row<span style="color:#f92672">.</span>getString<span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">),</span> row<span style="color:#f92672">.</span>getInt<span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">),</span> row<span style="color:#f92672">.</span>getInt<span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">))</span>
<span style="color:#f92672">})</span>

<span style="color:#75715e">// avoid blocking if you can.
</span><span style="color:#75715e">// but we do want to make sure all messages have been processed before continuing...
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Await</span><span style="color:#f92672">.</span>result<span style="color:#f92672">(</span>res<span style="color:#f92672">,</span> <span style="color:#a6e22e">Duration</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Inf</span><span style="color:#f92672">)</span>
</code></pre></div><p>On my machine this consistently takes between 2 and 3 seconds.  We&rsquo;ve reduced the amount of RAM used by not collecting the RDD as an intermediary Scala collection (only 19MB in this case, but still), and the time it takes to collect the results–about 9 seconds in this case.  Again, we can check the results, though it&rsquo;s obviously a bit different since our data is inside an Actor:</p>
<pre><code>import akka.pattern.ask
import scala.concurrent.Future

val rec = actor ? Get(&quot;68c6&quot;)

rec.onComplete {
  case Success(x) =&gt; x match {
    case Some(y) =&gt; y.asInstanceOf[Vector[(Int, Int)]].foreach(println)
  }
  case Failure(e) =&gt; println(&quot;doh!&quot;)
}
</code></pre><p>which will print the following (right records, but different ordering since messages were sent asyncronously):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">(73,17)
(0,6)
(82,51)
(98,98)
(95,30)
(3,76)
(73,40)
(25,40)
(9,94)
(27,96)
(24,6)
(39,78)
(91,64)
(35,42)
(43,20)
</code></pre></div><h1 id="with-remote-actors">With Remote Actors</h1>
<p>The actor example above works, but it won&rsquo;t in a genuinely distributed setting.  That is, where work is distributed across different JVM instances, or where we are using Spark workers that are physically separate servers, we will not be able to communicate with our actor in the way described.  One option is to use remote actors.  To demonstrate, we will start one process containing our actor, and a separate process containing our Spark DataFrame which we will process in pseudo-distributed mode.</p>

            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="../../tags/akka">akka</a></span>
        
            <span class="tag"><a href="../../tags/akka-actor">akka-actor</a></span>
        
            <span class="tag"><a href="../../tags/akka-http">akka-http</a></span>
        
            <span class="tag"><a href="../../tags/akka-remote">akka-remote</a></span>
        
            <span class="tag"><a href="../../tags/convolutional-neural-network">convolutional-neural-network</a></span>
        
            <span class="tag"><a href="../../tags/deeplearning4j">deeplearning4j</a></span>
        
            <span class="tag"><a href="../../tags/docker">docker</a></span>
        
            <span class="tag"><a href="../../tags/geoserver">geoserver</a></span>
        
            <span class="tag"><a href="../../tags/geospatial">geospatial</a></span>
        
            <span class="tag"><a href="../../tags/image-classfication">image-classfication</a></span>
        
            <span class="tag"><a href="../../tags/nodejs">nodejs</a></span>
        
            <span class="tag"><a href="../../tags/osrm">osrm</a></span>
        
            <span class="tag"><a href="../../tags/postgresql">postgresql</a></span>
        
            <span class="tag"><a href="../../tags/qgis">qgis</a></span>
        
            <span class="tag"><a href="../../tags/r">r</a></span>
        
            <span class="tag"><a href="../../tags/r-packages">r-packages</a></span>
        
            <span class="tag"><a href="../../tags/seasonal-adjustment">seasonal-adjustment</a></span>
        
            <span class="tag"><a href="../../tags/shiny">shiny</a></span>
        
            <span class="tag"><a href="../../tags/spark">spark</a></span>
        
            <span class="tag"><a href="../../tags/tiles">tiles</a></span>
        
            <span class="tag"><a href="../../tags/tilestache">tilestache</a></span>
        
            <span class="tag"><a href="../../tags/vuejs">vuejs</a></span>
        
            <span class="tag"><a href="../../tags/wmts">wmts</a></span>
        
            <span class="tag"><a href="../../tags/x13-arima-seats">x13-arima-seats</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="../../post/chest-xray/">Classifying Chest X-Rays with Deeplearning4j</a></h1>
            <time class="has-text-grey-light is-size-7">19 June 2020</time>
        
            <h1><a href="../../post/crud/">Creating a Basic Read-only Service</a></h1>
            <time class="has-text-grey-light is-size-7">13 June 2020</time>
        
            <h1><a href="../../post/spark-akka/">Collecting Spark DataFrames or RDDs with Akka Actors</a></h1>
            <time class="has-text-grey-light is-size-7">13 June 2020</time>
        
            <h1><a href="../../post/seasadj/">Seasonal Adjustment as a Service</a></h1>
            <time class="has-text-grey-light is-size-7">1 June 2020</time>
        
            <h1><a href="../../post/geoserver/">Building Tile Services on-the-fly with GeoServer</a></h1>
            <time class="has-text-grey-light is-size-7">17 September 2019</time>
        
    </div>
</div>
    <br>
                


    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="../../archives/2020">2020</a> (4)<br>
        
            <a href="../../archives/2019">2019</a> (1)<br>
        
            <a href="../../archives/2017">2017</a> (1)<br>
        
            <a href="../../archives/2016">2016</a> (4)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://github.com/cmhh" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="mailto://cmhhansen@outlook.com" class="mysocial" rel="me"><i class="fas fa-envelope fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; cmhh 2020 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<script src="../../js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
