<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.28">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Hansen">
<meta name="dcterms.date" content="2022-06-19">
<meta name="description" content="…">

<title>cmhh - Webscraping with Azure Functions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-block .quarto-title-banner {
      background-image: url(../../img/banner-2.jpg);
background-size: cover;
    }
    </style>


<link rel="stylesheet" href="../../css/styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">cmhh</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cmhh"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Webscraping with Azure Functions</h1>
                  <div>
        <div class="description">
          …
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Azure Functions</div>
                <div class="quarto-category">Selenium</div>
                <div class="quarto-category">Azurite</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Chris Hansen </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 19, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#working-with-remote-content-in-practice" id="toc-working-with-remote-content-in-practice" class="nav-link" data-scroll-target="#working-with-remote-content-in-practice">Working With Remote Content in Practice</a></li>
  <li><a href="#a-simple-template" id="toc-a-simple-template" class="nav-link" data-scroll-target="#a-simple-template">A Simple Template</a></li>
  <li><a href="#a-bit-more-detail" id="toc-a-bit-more-detail" class="nav-link" data-scroll-target="#a-bit-more-detail">A Bit More Detail…</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="overview" class="level1">
<h1>Overview</h1>
<p>Let’s say you have a need to fetch data from a range of online sources. You want to be able to fetch data on-demand, or according to some fixed schedule; and you want to be able to add new sources easily. Further assume that you want to use the public cloud to implement things for the most part, and that you have selected Microsoft Azure.</p>
<p>There are a number of ways we could do this, but here we settle on a method using Azure Functions. No matter the specific use case, our general process will be the same. We create an Azure Function that is responsible for fetching the data we need, and then for saving the extracted information to BLOB storage. And we have an additional function which runs whenever new files appear in BLOB storage, and then copies that data to a database. This last step might be better implemented in other ways, for example via a <a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-overview">Logic Application</a> or <a href="https://docs.microsoft.com/en-us/azure/data-factory/introduction#pipeline">Azure Data Factory pipeline</a> in response to a BLOB trigger, but that’s personal preference to some extent.</p>
<p><strong>Note</strong> it’s likely others will be using some variation of the code underpinning this post, and Python is the language they’re most likely to know and be comfortable with. So, for practical reasons, all the code in this post will be Python. I don’t particularly like Python, which means I’m also not particularly good at it! So, you know, keep that in mind when reading any code listings 😀.</p>
</section>
<section id="working-with-remote-content-in-practice" class="level1">
<h1>Working With Remote Content in Practice</h1>
<p>Sometimes, scraping content from a website is easy. Using a language like Python, it is easy to use a module such as beautiful soup to find data within a web page or series of web pages. But things aren’t always so easy. Let’s look at a couple of examples. First:</p>
<p><a href="https://www.stats.govt.nz/large-datasets/csv-files-for-download/">Stats NZ, CSV files for download</a></p>
<p>This page contains a number of CSV files, mostly containing time series data. Let’s say we want to extract the unadjusted Consumers Price Index (CPI) data, which looks to be in the file:</p>
<p><a href="https://www.stats.govt.nz/assets/Uploads/Consumers-price-index/Consumers-price-index-March-2022-quarter/Download-data/consumers-price-index-march-2022-index-numbers.csv">Consumers price index: March 2022 – index numbers – CSV</a></p>
<p>This isn’t a stable URL since it will clearly change when the June 2022 figures become available. That’s pretty unforgivable, but we could still work with that by searching for a link tag with an <code>href</code> attribute matching a regular expression like <code>^.*(/consumers-price-index){1}.*(.csv){1}$</code>. If we open this in a browser and inspect the link we’re interested in, we see:</p>
<p><img src="assets/csv_for_dl_01.png" class="img-fluid"></p>
<p>So, targeting something like <code>a[download]</code> looks a reasonable option for getting <em>all</em> files, after which we can filter. So, you would expect the following to do the job:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests, re</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  requests.get(<span class="st">'https://www.stats.govt.nz/large-datasets/csv-files-for-download/'</span>).text, </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">'html.parser'</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cpi_links(x):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  links <span class="op">=</span> x.select(<span class="st">"h3.block-document__title &gt; a[download]"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  hrefs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x: x[<span class="st">'href'</span>], links))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> re.<span class="bu">compile</span>(<span class="st">"^.*(/consumers-price-index)</span><span class="sc">{1}</span><span class="st">.*(index-numbers.csv)</span><span class="sc">{1}</span><span class="st">$"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">filter</span>(<span class="kw">lambda</span> x: <span class="bu">bool</span>(r.match(x)), hrefs))</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>cpi <span class="op">=</span> get_cpi_links(soup)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But if you run this, you will find that <code>cpi</code> is an empty list. WTF?</p>
<p><img src="assets/csv_for_dl_02.png" class="img-fluid"></p>
<p>This site weirdly ships most of the elements which will eventually be loaded to the DOM as an escaped string containing about 150000 characters:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">"pageViewData"</span> <span class="er">data-value</span><span class="ot">=</span><span class="st">"here!"</span><span class="kw">&gt;&lt;/div&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The string turned into valid HTML and injected into the DOM after page load by a JavaScript call-back. This is dumb, but it also means that the page can’t be scraped naively. Instead, users would have to parse this string themselves, or use a JavaScript-capable browser via Selenium or puppeteer.</p>
</section>
<section id="a-simple-template" class="level1">
<h1>A Simple Template</h1>
<p>A stated goal was to be able to easily deploy a new function for any additional online source we want to fetch. So, we build a basic template which can be used as a starting point for any new function. Users copy the template, and then just modify two files:</p>
<ul>
<li><code>scrape.py</code></li>
<li><code>metadata.json</code></li>
</ul>
<p><code>scrape.py</code> should contain a single function called <code>scrape</code> which returns a list of pandas DataFrames, and <code>metadata.json</code> should contain a list of objects describing the expected DataFrames. each of which we ultimately want to copy to a</p>
<p>replace the content of just two filesWe At a high level:</p>
<p><img src="assets/azurefunction01.png" class="img-fluid"></p>
</section>
<section id="a-bit-more-detail" class="level1">
<h1>A Bit More Detail…</h1>
<p><img src="assets/azurefunction01.png" class="img-fluid"></p>
<p>, including:</p>
<ul>
<li>information found in web pages, such as numbers in a table</li>
<li>information found in downloadable files, such as CSV files, Excel spreadsheets or PDF files</li>
<li>information pubished via data services</li>
</ul>
<p>range of disparate data sourcesand store it all in some central database.</p>
<p>For various reasons I recently found myself wanting to fetch data from a range of online sources, and then put all of that data together in a database. Moreover, I wanted this to be automated as much as possible, with data being fetched according to some pre-defined schedule in most cases. I put together a local solution using Selenium WebDriver to control a headless Chrome session, and I just used cron for the scheduling. This worked well enough, but it’s hardly an enterprise solution.</p>
<p>The only cloud-based option available to me where I work is Microsoft Azure. And while there are a few different options that would likely work well, Azure Functions seems a good fit. So, in this post we will run through a simple example to illustrate the process. We’ll work entirely locally, so no Azure account required, using Azure Function Core Tools and a few other related tools.</p>
<p>Note that the reason we use Selenium WebDriver is because often the data we want can only be fetched using a JavaScript-capable web browser. And this means that whatever code we deploy, it must have access to a web browser it can control. Containerisation is an obvious solution here, and so build a Docker image to run our function. While this is a reasonably narrow use case, one can nevertheless imagine other scenarios where we wish to deploy code that has a non-trivial set of dependencies which might be most easily satisfied using containers.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>