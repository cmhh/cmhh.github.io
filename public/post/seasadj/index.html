<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>cmhh  | Seasonal Adjustment as a Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link href="https://cmhh.github.io/css/highlight/atom-one-dark-reasonable.css" rel='stylesheet' type='text/css' />
    <link rel="stylesheet" href="https://cmhh.github.io/css/blog.css" />
    </head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://cmhh.github.io/">Home</a>
            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(https://cmhh.github.io/img/bg-blog-2.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Seasonal Adjustment as a Service
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                


<p><link rel="stylesheet" type="text/css" href="../../css/custom.css"></p>
<div id="overview" class="section level1">
<h1>Overview</h1>
<p><a href="https://www.census.gov/srd/www/x13as/" target="_blank">X13-ARIMA-SEATS</a> is a widely used seasonal adjustment program developed by the <a href="https://www.census.gov/" target="_blank">United States Census Bureau</a>. It’s a command-line tool, and I’ve wondered whether it would be useful to run as a web service–where I work, the standard security model makes running command-line tools a little problematic, so running a single service that could be accessed by any other client remotely would seem, on the face of it, a useful proposition.</p>
</div>
<div id="a-simple-example" class="section level1">
<h1>A Simple Example…</h1>
<p>The X13 binary ships with a relatively simple example using the famous Box and Jenkins air passengers data. That is, a simple specification is provided in a file called <code>testairline.spc</code>:</p>
<pre class="plaintext"><code>series{
  title=&quot;International Airline Passengers Data from Box and Jenkins&quot;
  start=1949.01
  data=(
    112 118 132 129 121 135 148 148 136 119 104 118
    115 126 141 135 125 149 170 170 158 133 114 140
    145 150 178 163 172 178 199 199 184 162 146 166
    171 180 193 181 183 218 230 242 209 191 172 194
    196 196 236 235 229 243 264 272 237 211 180 201
    204 188 235 227 234 264 302 293 259 229 203 229
    242 233 267 269 270 315 364 347 312 274 237 278
    284 277 317 313 318 374 413 405 355 306 271 306
    315 301 356 348 355 422 465 467 404 347 305 336
    340 318 362 348 363 435 491 505 404 359 310 337
    360 342 406 396 420 472 548 559 463 407 362 405
    417 391 419 461 472 535 622 606 508 461 390 432)
  span=(1952.01, )
}
spectrum{
  savelog=peaks 
}
transform{
  function=auto
  savelog=autotransform  
}
regression{
  aictest=(td easter)
  savelog=aictest  
}
automdl{  
  savelog=automodel  
}
outlier{ }
x11{}</code></pre>
<p>One could adjust this at the command line by running something like (there are a number of ways the program can be invoked):</p>
<pre class="bash"><code>x13ashtml testairline -g g</code></pre>
<p>Adding the <code>g</code> flag with value <code>g</code> tells X13 we wish to save output to subdirectory <code>g</code>, and we will end up with a number of text files matching the pattern <code>g/testairline.*</code>. For example, a range of diagnostics will be written as key-value pairs in a file called <code>g/testairline.udg</code>, the first few lines of which would look similar to:</p>
<pre class="plaintext"><code>date: Jun  1, 2020  
time: 14.19.08 
version: 1.1
build: 39
output: html
srstit: International Airline Passengers Data from Box and Jenkins
srsnam: testairline                                                     
freq:    12
span:  1st month,1952 to 12th month,1960
nobs:   108
constant:     0.0000000000E+00
transform: Automatic selection
...</code></pre>
<p>The seasonally adjusted and trend series would be saved as <code>g/testairline.d11</code> and <code>g/tsairline.d12</code>, respectively, and the first few rows of the D11 table would look as follows:</p>
<pre class="plaintext"><code>date    testairline.d11
------  -----------------------
195201  +0.192925972176234E+03
195202  +0.198588812698691E+03
195203  +0.185791217572829E+03
195204  +0.185841707777349E+03
195205  +0.186173988743725E+03
195206  +0.192599054707605E+03
195207  +0.187601439031062E+03
195208  +0.200184926772685E+03
...</code></pre>
</div>
<div id="as-a-service" class="section level1">
<h1>…as a Service</h1>
<p>I created a <a href="https://github.com/cmhh/seasadj">basic library</a> which can be used to run X13 programmatically on the JVM (the library is written in Scala), and also as a web service (the web service itself is written using Akka HTTP). The above test specification would be converted to JSON in somewhat obvious fashion as follows:</p>
<pre class="json"><code>{
  &quot;airpassengers&quot;:{
    &quot;series&quot;:{
      &quot;title&quot;:&quot;International Airline Passengers Data from Box and Jenkins&quot;,
      &quot;start&quot;:&quot;1949.01&quot;,
      &quot;data&quot;:[
        112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 104, 118,
        115, 126, 141, 135, 125, 149, 170, 170, 158, 133, 114, 140,
        145, 150, 178, 163, 172, 178, 199, 199, 184, 162, 146, 166,
        171, 180, 193, 181, 183, 218, 230, 242, 209, 191, 172, 194,
        196, 196, 236, 235, 229, 243, 264, 272, 237, 211, 180, 201,
        204, 188, 235, 227, 234, 264, 302, 293, 259, 229, 203, 229,
        242, 233, 267, 269, 270, 315, 364, 347, 312, 274, 237, 278,
        284, 277, 317, 313, 318, 374, 413, 405, 355, 306, 271, 306,
        315, 301, 356, 348, 355, 422, 465, 467, 404, 347, 305, 336,
        340, 318, 362, 348, 363, 435, 491, 505, 404, 359, 310, 337,
        360, 342, 406, 396, 420, 472, 548, 559, 463, 407, 362, 405,
        417, 391, 419, 461, 472, 535, 622, 606, 508, 461, 390, 432
      ],
      &quot;span&quot;:[&quot;1952.01&quot;, null]
    },
    &quot;spectrum&quot;:{
      &quot;savelog&quot;:&quot;peaks&quot;
    },
    &quot;transform&quot;:{
      &quot;function&quot;:&quot;auto&quot;,
      &quot;savelog&quot;:&quot;autotransform&quot;
    },
    &quot;regression&quot;:{
      &quot;aictest&quot;:[&quot;td&quot;, &quot;easter&quot;],
      &quot;savelog&quot;:&quot;aictest&quot;  
    },
    &quot;automdl&quot;:{
      &quot;savelog&quot;:&quot;automodel&quot;
    },
    &quot;outlier&quot;:null,
    &quot;x11&quot;:null
  }
}</code></pre>
<p>If this was saved as <code>testairline.json</code>, and a service instance was running at <code>localhost:9001</code>, then the adjustment could be run via curl, say, as follows:</p>
<pre class="bash"><code>curl \
  -X POST \
  -H &quot;Content-Type: application/json&quot; \
  -d @testairline.json \
  localhost:9001/seasadj/adjust \
  --compressed --output testairline_output.json</code></pre>
<p>The resulting JSON file contains most of the X13 output where files that can be imported as time series are saved in an array called <code>series</code>, and the diagnostics are parsed into an array called <code>diagnostics</code>.</p>
<div class="figure">
<img src="../../img/seasadj/postman01.png" alt="POST" />
<p class="caption">POST</p>
</div>
<p>Note that more than a single series can be included in a single JSON file / string in a fairly obvious way, and the use of composites is permitted. Moreover, because the full set of results can get somewhat large, it is possible to edit the results. For example, if we only wished to keep the seasonally adjusted and trend time series output we could append the query parameter <code>save=sa,trn</code>; and if we wanted to suppress all the dates and just include the start date and frequency we could append <code>allDates=false</code>.</p>
</div>
<div id="a-basic-javascript-client" class="section level1">
<h1>A Basic JavaScript ‘Client’</h1>
<p>Of course, once we have a web service, we can call it from any language or tool that has the ability to POST and parse JSON, which is pretty much everything. Client libraries could then be written for various target languages, if required, allowing users to use the service easily, and in an idiomatic way. One fun example involves calling the service in the browser using JavaScript. I like the idea of making component libraries using a framework such as <a href="https://vuejs.org/">Vue.js</a>, and this could be done here. In the following example we create a simple Vue.js component which knows how to fetch an unadjusted time series by ID using a <a href="https://github.com/cmhh/snzts">service I created earlier</a>, adjust the result, and then populate a <a href="https://www.highcharts.com/">highchart</a>:</p>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<script src="https://code.highcharts.com/highcharts.src.js"></script>
<div class="framed">
<div id="app">

</div>
</div>
<script>
Vue.component('snzseasadjchart', {
  props: {
    name: {required: true},
    code: { required: true }
  },
  data: function() {
    return {
      tsdata: {}
    }
  },
  mounted() {
    this.$_update(this.code);
  },
  watch: {
    code() {
      this.$_update(this.code);
    },
    tsdata() {
      Highcharts.chart(this.name, {
        title: {
          text: this.tsdata.title,
          useHTML: true
        },
        yAxis: {
          title: {
            text: this.tsdata.units
          }
        },
        xAxis: {
          categories: this.tsdata.period
        },
        series: [
          {
            name: "unadjusted",
            data: this.tsdata.ori
          },
          {
            name: "seasonally adjusted",
            data: this.tsdata.sa
          },
          {
            name: "trend",
            data: this.tsdata.trn
          }
        ],
        chart: {
          type: 'line',
          zoomType: 'xy',
          height: null
        },
        plotOptions: {
          series: {
            allowPointSelect: true,
            marker: {
              enabled: false
            }
          }
        },
        credits: {
          enabled: true,
          href: "https://www.stats.govt.nz/large-datasets/csv-files-for-download/",
          text: "Stats NZ"
        }
      });
    }
  },
  methods: {
    $_update(seriesCode) {
      let context = this;
      axios
        .get(`https://cmhh.hopto.org/snzts/v1/series?format=json&seriesCode=${this.code}`)
        .then(response => {
          let actual = response.data[0];
          let title = actual.outcomes.join(", ");
          let start = actual.period[0];
          let data = actual.value.toString();
          let period = 12 / actual.interval;
          let units = actual.units;
          let magnitude = actual.magnitude;
          let request = 
            `{"x":{"series":{"title":"${title}","start":"${start}",` +
            `"period":${period},"data":[${data}]},"x11":null}}`;
          axios
            .post("https://cmhh.hopto.org/seasadj/adjust?save=ori,sa,trn", request)
            .then(response => {
              let res = response.data.x;
              context.tsdata = {
                title:title,
                units:units,
                magnitude:magnitude,
                period:res.series.ori.date,
                ori:res.series.ori.value,
                sa:res.series.sa.value,
                trn:res.series.trn.value
              };
            });
        });
    }
  },
  template: `<div class="snztschart" v-bind:id="name"></div>`
});
</script>
<script>
let app = new Vue({
  el: '#app',
  data() {
    return {
      code: "HLFQ.SAA3AZ"
    }
  },
  template:`
    <div>
      <label for="cars">Choose a series:</label>
      <select v-model="code">
        <option value="HLFQ.SAA3AZ" selected>total employed</option>
        <option value="HLFQ.SAB3AZ">total unemployed</option>
        <option value="HLFQ.SAC3AZ">not in labour force</option>
        <option value="HLFQ.SAE3AZ">labour force participation rate</option>
        <option value="HLFQ.SAH3AZ">employment rate</option>
        <option value="HLFQ.SAF3AZ">unemployment rate</option>
        <option value="HLFQ.SAD3AZ">working-age population</option>
      </select>
      <hr>
      <snzseasadjchart v-bind:code="code" name=ts02></snzseasadjchart>
    </div>
  `
});
</script>
<p>For those interested, the full source of this ‘application’ is as follows:</p>
<pre class="html"><code>&lt;script src=&quot;https://unpkg.com/axios/dist/axios.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue@2.6.11&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://code.highcharts.com/highcharts.src.js&quot;&gt;&lt;/script&gt;

&lt;div id=app&gt;&lt;/div&gt;
&lt;script&gt;
Vue.component(&#39;snzseasadjchart&#39;, {
  props: {
    name: {required: true},
    code: { required: true }
  },
  data: function() {
    return {
      tsdata: {}
    }
  },
  mounted() {
    this.$_update(this.code);
  },
  watch: {
    code() {
      this.$_update(this.code);
    },
    tsdata() {
      Highcharts.chart(this.name, {
        title: {
          text: this.tsdata.title,
          useHTML: true
        },
        yAxis: {
          title: {
            text: this.tsdata.units
          }
        },
        xAxis: {
          categories: this.tsdata.period
        },
        series: [
          {
            name: &quot;unadjusted&quot;,
            data: this.tsdata.ori
          },
          {
            name: &quot;seasonally adjusted&quot;,
            data: this.tsdata.sa
          },
          {
            name: &quot;trend&quot;,
            data: this.tsdata.trn
          }
        ],
        chart: {
          type: &#39;line&#39;,
          zoomType: &#39;xy&#39;,
          height: null
        },
        plotOptions: {
          series: {
            allowPointSelect: true,
            marker: {
              enabled: false
            }
          }
        },
        credits: {
          enabled: true,
          href: &quot;https://www.stats.govt.nz/large-datasets/csv-files-for-download/&quot;,
          text: &quot;Stats NZ&quot;
        }
      });
    }
  },
  methods: {
    $_update(seriesCode) {
      let context = this;
      axios
        .get(`https://cmhh.hopto.org/snzts/v1/series?format=json&amp;seriesCode=${this.code}`)
        .then(response =&gt; {
          let actual = response.data[0];
          let title = actual.outcomes.join(&quot;, &quot;);
          let start = actual.period[0];
          let data = actual.value.toString();
          let period = 12 / actual.interval;
          let units = actual.units;
          let magnitude = actual.magnitude;
          let request = 
            `{&quot;x&quot;:{&quot;series&quot;:{&quot;title&quot;:&quot;${title}&quot;,&quot;start&quot;:&quot;${start}&quot;,` +
            `&quot;period&quot;:${period},&quot;data&quot;:[${data}]},&quot;x11&quot;:null}}`;
          axios
            .post(&quot;https://cmhh.hopto.org/seasadj/adjust?save=ori,sa,trn&quot;, request)
            .then(response =&gt; {
              let res = response.data.x;
              context.tsdata = {
                title:title,
                units:units,
                magnitude:magnitude,
                period:res.series.ori.date,
                ori:res.series.ori.value,
                sa:res.series.sa.value,
                trn:res.series.trn.value
              };
            });
        });
    }
  },
  template: `&lt;div class=&quot;snztschart&quot; v-bind:id=&quot;name&quot;&gt;&lt;/div&gt;`
});
&lt;/script&gt;
&lt;script&gt;
let app = new Vue({
  el: &#39;#app&#39;,
  data() {
    return {
      code: &quot;HLFQ.SAA3AZ&quot;
    }
  },
  template:`
    &lt;div&gt;
      &lt;label for=&quot;cars&quot;&gt;Choose a series:&lt;/label&gt;
      &lt;select v-model=&quot;code&quot;&gt;
        &lt;option value=&quot;HLFQ.SAA3AZ&quot; selected&gt;total employed&lt;/option&gt;
        &lt;option value=&quot;HLFQ.SAB3AZ&quot;&gt;total unemployed&lt;/option&gt;
        &lt;option value=&quot;HLFQ.SAC3AZ&quot;&gt;not in labour force&lt;/option&gt;
        &lt;option value=&quot;HLFQ.SAE3AZ&quot;&gt;labour force participation rate&lt;/option&gt;
        &lt;option value=&quot;HLFQ.SAH3AZ&quot;&gt;employment rate&lt;/option&gt;
        &lt;option value=&quot;HLFQ.SAF3AZ&quot;&gt;unemployment rate&lt;/option&gt;
        &lt;option value=&quot;HLFQ.SAD3AZ&quot;&gt;working-age population&lt;/option&gt;
      &lt;/select&gt;
      &lt;hr&gt;
      &lt;snzseasadjchart v-bind:code=&quot;code&quot; name=ts02&gt;&lt;/snzseasadjchart&gt;
    &lt;/div&gt;
  `
});
&lt;/script&gt;</code></pre>
</div>

            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="https://cmhh.github.io/tags/akka-http">akka-http</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/geoserver">geoserver</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/geospatial">geospatial</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/nodejs">nodejs</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/osrm">osrm</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/qgis">qgis</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/r">r</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/r-packages">r-packages</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/seasonal-adjustment">seasonal-adjustment</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/shiny">shiny</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/tiles">tiles</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/tilestache">tilestache</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/vuejs">vuejs</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/wmts">wmts</a></span>
        
            <span class="tag"><a href="https://cmhh.github.io/tags/x13-arima-seats">x13-arima-seats</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="https://cmhh.github.io/post/seasadj/">Seasonal Adjustment as a Service</a></h1>
            <time class="has-text-grey-light is-size-7">1 June 2020</time>
        
            <h1><a href="https://cmhh.github.io/post/geoserver/">Building Tile Services on-the-fly with GeoServer</a></h1>
            <time class="has-text-grey-light is-size-7">17 September 2019</time>
        
            <h1><a href="https://cmhh.github.io/post/qgis/">Web Maps and Tiles with QGIS</a></h1>
            <time class="has-text-grey-light is-size-7">26 January 2017</time>
        
            <h1><a href="https://cmhh.github.io/post/tiles/">Serving Geospatial Features with Mapnik and TileStache</a></h1>
            <time class="has-text-grey-light is-size-7">28 November 2016</time>
        
            <h1><a href="https://cmhh.github.io/post/routing/">Routing in R Using the Open Source Routing Machine (OSRM)</a></h1>
            <time class="has-text-grey-light is-size-7">27 November 2016</time>
        
    </div>
</div>
    <br>
                


    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="https://cmhh.github.io/archives/2020">2020</a> (1)<br>
        
            <a href="https://cmhh.github.io/archives/2019">2019</a> (1)<br>
        
            <a href="https://cmhh.github.io/archives/2017">2017</a> (1)<br>
        
            <a href="https://cmhh.github.io/archives/2016">2016</a> (4)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://github.com/cmhh" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="mailto://cmhhansen@outlook.com" class="mysocial" rel="me"><i class="fas fa-envelope fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; cmhh 2020 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
<script src="https://cmhh.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
